{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />
{% include 'components/navbar.html' %}
{% include 'components/tabbar/tabbar.html' with tab1_name="Gen. Patient Info" tab2_name="Additional Info" tab3_name="Chief Complaint" tab4_name="Work Up Done" tab5_name="Vital Signs" show_pending_fallback=False %}
{% include 'components/patients/addpatients.html' %}

<style>
  /* Only disable the top navigation tabs */ 
ul#dashboardTab.nav .nav-link {
  pointer-events: none;
  cursor: not-allowed;
}

</style>

<div class="bg-light py-4">
  <div class="d-flex justify-content-between align-items-center mb-4 mr-3">
        <h4 class="mb-0 text-primary"></h4>
        <button class="btn btn-success shadow-sm" data-bs-toggle="modal" data-bs-target="#registerModal">
  <i class="bi bi-person-plus-fill"></i>
  <span class="ml-2">Add Patient</span>
</button>
      </div>

  <form id="referralForm" method="POST" action="{% url 'referrals:create_referral' %}" class="needs-validation" novalidate>
    {% csrf_token %}
    <div class="container"> 
      <div class="tab-content shadow-sm bg-white rounded p-4" id="assessmentTabContent">
        
 
<!-- Tab 1: General Info with Searchable Dropdown -->
<div class="tab-pane show active" id="tab1" role="tabpanel">
  
  <div class="row mb-4">
    <div class="col-md-8 mx-auto">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="card-title text-primary mb-4">
            <i class="bi bi-person-lines-fill"></i> Patient Selection
          </h5>
          <div class="form-group">
            <select class="form-control form-control-lg" required name="patient" id="patientSelect" style="width: 100%;">
              <option value="" disabled {% if not patient_id %}selected{% endif %}>Select Patient</option>
              {% if patient_id and selected_patient %}
                <option value="{{ selected_patient.patients_id }}" selected>
                  {{ selected_patient.first_name }} {{ selected_patient.middle_name }} {{ selected_patient.last_name }}
                </option>
              {% endif %}
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



        <!-- Tab 2: Additional Information -->
        <div class="tab-pane fade" id="tab2" role="tabpanel">
          <h5 class="text-primary mb-4"><i class="bi bi-info-circle"></i> Additional Referral Information</h5>

          <!-- Lifestyle & Social History Section -->
          <div class="card border-0 bg-light mb-4" style="border-left: 4px solid #6f42c1;">
            <div class="card-body">
              <h6 class="text-primary mb-3">
                <i class="bi bi-heart-pulse-fill" style="color: #6f42c1;"></i> Lifestyle & Social History
              </h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_smoker" name="is_smoker">
                    <label class="form-check-label" for="is_smoker">Smoker</label>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label text-muted">Sticks/Packs per Day</label>
                  <input type="number" class="form-control" id="smoking_sticks_per_day" name="smoking_sticks_per_day" min="0" placeholder="Enter number" disabled>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_alcoholic" name="is_alcoholic">
                    <label class="form-check-label" for="is_alcoholic">Alcoholic</label>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label text-muted">Bottles per Year</label>
                  <input type="number" class="form-control" id="alcohol_bottles_per_year" name="alcohol_bottles_per_year" min="0" placeholder="Enter number" disabled>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="family_planning" name="family_planning">
                    <label class="form-check-label" for="family_planning">Family Planning</label>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label text-muted">Family Planning Type</label>
                  <select class="form-control" id="family_planning_type" name="family_planning_type" disabled>
                    <option value="">Select Type</option>
                    <option value="DMPA">DMPA</option>
                    <option value="IMPLANT">IMPLANT</option>
                    <option value="IUD">IUD</option>
                    <option value="PILLS">PILLS</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Menstrual History Section (for Female patients) -->
          <div class="card border-0 bg-light mb-4" id="menstrualHistoryCard" style="border-left: 4px solid #e91e63; display: none;">
            <div class="card-body">
              <h6 class="text-primary mb-3">
                <i class="bi bi-calendar-heart-fill" style="color: #e91e63;"></i> Menstrual History
              </h6>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Menarche (Age)</label>
                  <input type="number" class="form-control" id="menarche" name="menarche" min="0" max="20" placeholder="Age">
                </div>
                <div class="col-md-4 mb-3">
                  <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="sexually_active" name="sexually_active">
                    <label class="form-check-label" for="sexually_active">Sexually Active</label>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Number of Partners</label>
                  <input type="number" class="form-control" id="number_of_partners" name="number_of_partners" min="0" placeholder="Enter number">
                </div>
                <div class="col-md-4 mb-3">
                  <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="is_menopause" name="is_menopause">
                    <label class="form-check-label" for="is_menopause">Menopause</label>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Menopause Age</label>
                  <input type="number" class="form-control" id="menopause_age" name="menopause_age" min="0" max="100" placeholder="Age">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Last Menstrual Period (LMP)</label>
                  <input type="date" class="form-control" id="last_menstrual_period" name="last_menstrual_period">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Period Duration (Days)</label>
                  <input type="number" class="form-control" id="period_duration" name="period_duration" min="0" placeholder="Days">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Period Interval (Days)</label>
                  <input type="number" class="form-control" id="period_interval" name="period_interval" min="0" placeholder="Days between">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Pads per Day</label>
                  <input type="number" class="form-control" id="pads_per_day" name="pads_per_day" min="0" placeholder="Number">
                </div>
              </div>
            </div>
          </div>

          <!-- Pregnancy History Section (for Female patients) -->
          <div class="card border-0 bg-light mb-4" id="pregnancyHistoryCard" style="border-left: 4px solid #ff6b9d; display: none;">
            <div class="card-body">
              <h6 class="text-primary mb-3">
                <i class="bi bi-heart-fill" style="color: #ff6b9d;"></i> Pregnancy History
              </h6>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="is_pregnant" name="is_pregnant">
                    <label class="form-check-label" for="is_pregnant">Currently Pregnant</label>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Gravidity</label>
                  <input type="number" class="form-control" id="gravidity" name="gravidity" min="0" placeholder="Number of pregnancies">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Parity</label>
                  <input type="number" class="form-control" id="parity" name="parity" min="0" placeholder="Number of births">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Type of Delivery</label>
                  <input type="text" class="form-control" id="delivery_type" name="delivery_type" placeholder="e.g., Normal, CS">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Full Term Births</label>
                  <input type="number" class="form-control" id="full_term_births" name="full_term_births" min="0" placeholder="Number">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Premature Births</label>
                  <input type="number" class="form-control" id="premature_births" name="premature_births" min="0" placeholder="Number">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Abortions</label>
                  <input type="number" class="form-control" id="abortions" name="abortions" min="0" placeholder="Number">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label text-muted">Living Children</label>
                  <input type="number" class="form-control" id="living_children" name="living_children" min="0" placeholder="Number">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab 3: Chief Complaint -->
        <div class="tab-pane fade" id="tab3" role="tabpanel">
          <h5 class="text-primary mb-4"><i class="bi bi-clipboard2-pulse"></i> Patient Complaints</h5>
          <div class="card border-0 bg-light mb-4">
            <div class="card-body">
              <label class="form-label text-muted">Chief Complaint</label>
              <textarea class="form-control" name="chief_complaint" rows="3" required placeholder="Enter the main complaint"></textarea>
            </div>
          </div>
          <div class="card border-0 bg-light">
            <div class="card-body">
              <label class="form-label text-muted">Detailed Symptoms</label>
              <textarea class="form-control" name="symptoms" rows="4" placeholder="Enter detailed symptoms"></textarea>
            </div>
          </div>
        </div>

        <!-- Tab 4: Work Up Done -->
        <div class="tab-pane fade" id="tab4" role="tabpanel">
          <h5 class="text-primary mb-4"><i class="bi bi-journal-medical"></i> Medical Procedures</h5>
          <div class="card border-0 bg-light">
            <div class="card-body">
              <label class="form-label text-muted">Work Up Procedures Done</label>
              <textarea class="form-control" name="work_up_details" rows="4" placeholder="Enter work up procedures performed"></textarea>
            </div>
          </div>
        </div>

        <!-- Tab 5: Vital Signs -->
        <div class="tab-pane fade" id="tab5" role="tabpanel">
          <h5 class="text-primary mb-4"><i class="bi bi-heart-pulse"></i> Patient Vital Signs</h5>
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <label class="form-label text-muted">Weight (kg)</label>
                  <input type="number" class="form-control form-control-lg" step="0.1" min="0" required name="weight" placeholder="" />
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <label class="form-label text-muted">Height (cm)</label>
                  <input type="number" class="form-control form-control-lg" step="0.1" min="0" required name="height" placeholder="" />
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <label class="form-label text-muted">Blood Pressure</label>
                  <div class="input-group">
                    <input type="number" class="form-control form-control-lg" step="1" min="0" required name="bp_systolic" placeholder="Systolic" />
                    <div class="input-group-append input-group-prepend">
                      <span class="input-group-text">/</span>
                    </div>
                    <input type="number" class="form-control form-control-lg" step="1" min="0" required name="bp_diastolic" placeholder="Diastolic" />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-3">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <label class="form-label text-muted">Pulse Rate (bpm)</label>
                  <input type="number" class="form-control form-control-lg" step="1" min="0" max="150" required name="pulse_rate" placeholder="" />
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <label class="form-label text-muted">Respiratory Rate</label>
                  <input type="number" class="form-control form-control-lg" step="1" min="0" required name="respiratory_rate" placeholder="" />
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <label class="form-label text-muted">Temperature (Â°C)</label>
                  <input type="number" class="form-control form-control-lg" step="0.1" min="30" max="45" required name="temperature" placeholder="" />
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <label class="form-label text-muted">O2 Saturation (%)</label>
                  <input type="number" class="form-control form-control-lg" step="1" min="0" max="100" required name="oxygen_saturation" placeholder="" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="d-flex justify-content-between mt-4">
        <button class="btn btn-outline-secondary btn-lg px-4" id="prevBtn" type="button">
          <i class="bi bi-arrow-left"></i> Previous
        </button>
        <button class="btn btn-primary btn-lg px-4" id="nextBtn" type="button">
          Next <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Modal for Incomplete Form -->
<div class="modal fade" id="incompleteFormModal" tabindex="-1" aria-labelledby="incompleteFormModalLabel" aria-hidden="true" >
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="incompleteFormModalLabel">
          <i class="bi bi-exclamation-triangle"></i> Incomplete Form
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Please complete all required fields in the current tab before proceeding.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Referral Confirmation -->
<div class="modal fade" id="referralConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="referralConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="referralConfirmationModalLabel">
          <i class="bi bi-check-circle"></i> Referral Submitted Successfully
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
        </div>
        <h6 class="text-center mb-3">Your referral has been successfully submitted!</h6>
        <p class="text-muted text-center mb-0">
          The referral has been sent to the appropriate healthcare facility. 
          You will receive a confirmation notification shortly.
        </p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="redirectToReferrals()">
          <i class="bi bi-list-ul"></i> View All Referrals
        </button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" onclick="resetForm()">
          <i class="bi bi-plus-circle"></i> Create New Referral
        </button>
      </div>
    </div>
  </div>
</div>

{% block script %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tabs = [...document.querySelectorAll(".tab-pane")];
    const nextBtn = document.getElementById("nextBtn");
    const prevBtn = document.getElementById("prevBtn");
    const form = document.getElementById("referralForm");
    const incompleteModal = new bootstrap.Modal(document.getElementById("incompleteFormModal"));
    const confirmationModal = new bootstrap.Modal(document.getElementById("referralConfirmationModal"));
    const navLinks = document.querySelectorAll("#dashboardTab .nav-link");

    let currentTab = 0;

    // Make sure jQuery and Select2 are loaded before initializing
    if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
      // Check if we have a pre-selected patient
      var preselectedPatient = null;
      {% if patient_id and selected_patient %}
        preselectedPatient = {
          id: "{{ selected_patient.patients_id }}",
          text: "{{ selected_patient.first_name }} {{ selected_patient.middle_name }} {{ selected_patient.last_name }}",
          name: "{{ selected_patient.first_name }} {{ selected_patient.middle_name }} {{ selected_patient.last_name }}"
        };
      {% endif %}

      $('#patientSelect').select2({
        placeholder: "Search patient by name",
        allowClear: true,
        theme: "bootstrap4",
        width: '100%',
        minimumInputLength: 0,
        data: preselectedPatient ? [preselectedPatient] : [], // Pre-populate with selected patient
        ajax: {
          url: "{% url 'patients:search_patients' %}",
          dataType: 'json',
          delay: 250,
          data: function (params) {
            return { q: params.term || '', page: params.page || 1 };
          },
          processResults: function (data, params) {
            params.page = params.page || 1;
            var term = (params.term || '').trim();
            var results = data.results || [];
            
            // If we have a preselected patient and no search term, include it in results
            if (preselectedPatient && !term && params.page === 1) {
              // Check if preselected patient is not already in results
              var patientExists = results.some(function(item) {
                return item.id === preselectedPatient.id;
              });
              if (!patientExists) {
                results.unshift(preselectedPatient);
              }
            }
            
            // Hard-cap to 5 items when there is no search term and first page
            if (!term && params.page === 1 && results.length > 5) {
              results = results.slice(0, 5);
            }
            return {
              results: results,
              pagination: { more: Boolean(data.has_more && !!term) }
            };
          },
          cache: true
        },
        templateResult: function (item) {
          if (!item.id) return item.text;
          var name = item.name || item.text || '';
          var el = document.createElement('div');
          el.innerHTML = '<div><strong>' + name + '</strong></div>';
          return el;
        },
        templateSelection: function (item) {
          return item.name || item.text || '';
        }
      });

      // Set the preselected value if we have one
      {% if patient_id and selected_patient %}
        $('#patientSelect').val("{{ selected_patient.patients_id }}").trigger('change');
        // Check patient sex for preselected patient
        checkPatientSex('{{ selected_patient.sex }}');
      {% endif %}

      // Listen for patient selection changes
      $('#patientSelect').on('select2:select', function (e) {
        const patientId = e.params.data.id;
        // Fetch patient sex via AJAX
        fetchPatientSex(patientId);
      });

      // Listen for patient clearing
      $('#patientSelect').on('select2:clear', function (e) {
        // Hide menstrual and pregnancy sections when patient is cleared
        $('#menstrualHistoryCard, #pregnancyHistoryCard').hide();
      });

    } else {
      console.error("jQuery or Select2 not loaded");
    }

    // Function to fetch patient sex from server
    function fetchPatientSex(patientId) {
      if (!patientId) {
        $('#menstrualHistoryCard, #pregnancyHistoryCard').hide();
        return;
      }
      
      fetch(`/patients/get-patient-sex/${patientId}/`)
        .then(response => response.json())
        .then(data => {
          if (data.sex) {
            checkPatientSex(data.sex);
          }
        })
        .catch(error => {
          console.error('Error fetching patient sex:', error);
        });
    }

    // Function to check patient sex and show/hide sections
    function checkPatientSex(sex) {
      if (sex && sex.toLowerCase() === 'female') {
        $('#menstrualHistoryCard, #pregnancyHistoryCard').show();
      } else {
        $('#menstrualHistoryCard, #pregnancyHistoryCard').hide();
      }
    }

    // Handle conditional enabling of lifestyle fields
    $('#is_smoker').on('change', function() {
      $('#smoking_sticks_per_day').prop('disabled', !$(this).is(':checked'));
      if (!$(this).is(':checked')) {
        $('#smoking_sticks_per_day').val('');
      }
    });

    $('#is_alcoholic').on('change', function() {
      $('#alcohol_bottles_per_year').prop('disabled', !$(this).is(':checked'));
      if (!$(this).is(':checked')) {
        $('#alcohol_bottles_per_year').val('');
      }
    });

    $('#family_planning').on('change', function() {
      $('#family_planning_type').prop('disabled', !$(this).is(':checked'));
      if (!$(this).is(':checked')) {
        $('#family_planning_type').val('');
      }
    });

    function showTab(index) {
      tabs.forEach((tab, i) => {
        tab.classList.remove("show", "active");
        if (i === index) {
          tab.classList.add("show", "active");
        }
      });

      // Update navigation links
      if (navLinks && navLinks.length > 0) {
        navLinks.forEach((link, i) => {
          link.classList.toggle("active", i === index);
        });
      }

      prevBtn.style.display = index === 0 ? "none" : "inline-block";
      nextBtn.innerHTML = index === tabs.length - 1 ? 'Submit <i class="bi bi-check-lg"></i>' : 'Next <i class="bi bi-arrow-right"></i>';
    }

    function isTabValid(index) {
      const fields = tabs[index].querySelectorAll("input, select, textarea");
      let valid = true;
      
      for (let field of fields) {
        if (field.required) {
          if (!field.value || field.value.trim() === "") {
            field.classList.add('is-invalid');
            valid = false;
          } else {
            field.classList.remove('is-invalid');
          }
        }
      }
      return valid;
    }

    // Initialize first tab
    showTab(currentTab);

    nextBtn.addEventListener("click", () => {
      if (!isTabValid(currentTab)) {
        incompleteModal.show();
        return;
      }

      if (currentTab < tabs.length - 1) {
        currentTab++;
        showTab(currentTab);
      } else {
        // Add form validation before submit
        if (form.checkValidity()) {
          // Submit form via AJAX to show confirmation modal
          submitFormWithConfirmation();
        } else {
          incompleteModal.show();
        }
      }
    });

    // Function to submit form and show confirmation modal
    function submitFormWithConfirmation() {
      const formData = new FormData(form);
      
      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => {
        if (response.ok) {
          // Show confirmation modal
          confirmationModal.show();
        } else {
          // Handle error
          alert('There was an error submitting the referral. Please try again.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('There was an error submitting the referral. Please try again.');
      });
    }

    prevBtn.addEventListener("click", () => {
      if (currentTab > 0) {
        currentTab--;
        showTab(currentTab);
      }
    });

    // Global functions for modal buttons
    window.redirectToReferrals = function() {
      window.location.href = "{% url 'referrals:referral_list' %}";
    };

    window.resetForm = function() {
      // Reset form to initial state
      form.reset();
      currentTab = 0;
      showTab(currentTab);
      
      // Reset Select2 if it exists
      if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
        $('#patientSelect').val(null).trigger('change');
      }
      
      // Remove any validation classes
      form.querySelectorAll('.is-invalid').forEach(field => {
        field.classList.remove('is-invalid');
      });
    };
  });
</script>
{% endblock script %}
{% endblock %}
