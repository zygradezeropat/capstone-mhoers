{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}NCERS{% endblock %}</title>
    <link rel="icon" type="image/png" href="{% static 'images/MHO-LOGO.png' %}" />

    <!-- Bootstrap 5.3.2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

    <!-- Custom Styles AFTER Bootstrap -->
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}?v=3" />
    <link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}?v=2" />

    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />

    <!-- Mapbox & Leaflet (optional) -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Responsive Layout Styles -->
    <style>
      .main-content {
        margin-left: 280px;
        padding: 20px;
        min-height: 100vh;
        transition: margin-left 0.3s ease;
        background: #f8f9fa;
      }
      
      /* Collapsed sidebar main content adjustment */
      .main-content.sidebar-collapsed {
        margin-left: 70px;
      }
      
      @media (max-width: 1199px) and (min-width: 768px) {
        .main-content {
          margin-left: 260px;
        }
        
        .main-content.sidebar-collapsed {
          margin-left: 70px;
        }
      }
      
      @media (max-width: 767px) {
        .main-content {
          margin-left: 0;
          padding: 15px;
          padding-top: 80px; /* Space for toggle button */
        }
        
        .main-content.sidebar-collapsed {
          margin-left: 0;
        }
      }
      
      @media (max-width: 480px) {
        .main-content {
          padding: 10px;
          padding-top: 70px;
        }
        
        .main-content.sidebar-collapsed {
          margin-left: 0;
        }
      }
    </style>
    
    <!-- Modal z-index fixes -->
    <style>
      /* Ensure modals appear above sidebar */
      .modal {
        z-index: 1050 !important;
      }
      
      .modal-backdrop {
        z-index: 1040 !important;
      }
      
      /* Bootstrap modal z-index override */
      .modal.fade .modal-dialog {
        z-index: 1055 !important;
      }
      
      /* Additional modal z-index for Bootstrap 4 */
      .modal.show {
        z-index: 1050 !important;
      }
      
      .modal-dialog {
        z-index: 1055 !important;
      }
    </style>
  </head>

  <body>
    {% block sidebar %}
      {% if user.is_staff %}
        {% include 'components/admin_sidebar.html' %}
      {% elif is_doctor %}
        {% include 'components/doctor_sidebar.html' %}
      {% else %}
        {% include 'components/sidebar.html' %}
      {% endif %}
    {% endblock %}

    <main class="main-content">
      {% block content %}{% endblock %}
      {% block alerts %}
        <!-- Messages are now shown via modals -->
      {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light border-top mt-auto py-3" style="margin-left: 280px;">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-12 text-center">
            <small class="text-muted">
              &copy; {% now "Y" %} MHOERS - Municipal Health Office Electronic Referral System | 
              <a href="{% url 'privacy_policy' %}" class="text-decoration-none">Privacy Policy</a>
              {% if user.is_authenticated %}
                | <a href="{% url 'request_deletion' %}" class="text-decoration-none">Request Data Deletion</a>
              {% endif %}
            </small>
          </div>
        </div>
      </div>
    </footer>

    <!-- jQuery and Bootstrap 5 Bundle (Popper + Bootstrap JS) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Reusable Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1" role="dialog" aria-labelledby="messageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header" id="messageModalHeader">
            <h5 class="modal-title" id="messageModalLabel">
              <i class="bi" id="messageModalIcon"></i> <span id="messageModalTitle"></span>
            </h5>
            <button type="button" class="btn-close" id="messageModalCloseBtn" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-3">
              <i class="bi" id="messageModalBodyIcon" style="font-size: 3rem;"></i>
            </div>
            <h6 class="text-center mb-3" id="messageModalMessage"></h6>
            <p class="text-muted text-center mb-0" id="messageModalDetails"></p>
          </div>
          <div class="modal-footer justify-content-center">
            <button type="button" class="btn" id="messageModalButton" data-bs-dismiss="modal">
              <i class="bi bi-check-lg"></i> OK
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar Script -->
    <script src="{% static 'js/sidebar.js' %}"></script>
    
    <!-- Smart Polling Utility -->
    <script src="{% static 'js/smart_polling.js' %}"></script>
    
    <!-- Notification Poller -->
    <script src="{% static 'js/notification_poller.js' %}"></script>
    
    <!-- Message Modal Utility Script -->
    <script>
      // Utility function to show message modals
      function showMessageModal(type, title, message, details = '', callback = null) {
        const modal = new bootstrap.Modal(document.getElementById('messageModal'));
        const header = document.getElementById('messageModalHeader');
        const icon = document.getElementById('messageModalIcon');
        const bodyIcon = document.getElementById('messageModalBodyIcon');
        const titleEl = document.getElementById('messageModalTitle');
        const messageEl = document.getElementById('messageModalMessage');
        const detailsEl = document.getElementById('messageModalDetails');
        const button = document.getElementById('messageModalButton');
        const closeBtn = document.getElementById('messageModalCloseBtn');
        
        // Set colors and icons based on type
        let headerClass, iconClass, bodyIconClass, buttonClass;
        
        switch(type) {
          case 'success':
            headerClass = 'bg-success text-white';
            iconClass = 'bi-check-circle';
            bodyIconClass = 'bi-check-circle text-success';
            buttonClass = 'btn-success';
            break;
          case 'error':
            headerClass = 'bg-danger text-white';
            iconClass = 'bi-x-circle';
            bodyIconClass = 'bi-x-circle text-danger';
            buttonClass = 'btn-danger';
            break;
          case 'warning':
            headerClass = 'bg-warning text-dark';
            iconClass = 'bi-exclamation-triangle';
            bodyIconClass = 'bi-exclamation-triangle text-warning';
            buttonClass = 'btn-warning';
            break;
          case 'info':
            headerClass = 'bg-info text-white';
            iconClass = 'bi-info-circle';
            bodyIconClass = 'bi-info-circle text-info';
            buttonClass = 'btn-info';
            break;
          default:
            headerClass = 'bg-secondary text-white';
            iconClass = 'bi-info-circle';
            bodyIconClass = 'bi-info-circle text-secondary';
            buttonClass = 'btn-secondary';
        }
        
        // Update header
        header.className = 'modal-header ' + headerClass;
        closeBtn.className = type === 'success' || type === 'error' || type === 'info' 
          ? 'btn-close btn-close-white' 
          : 'btn-close';
        
        // Update content
        icon.className = 'bi ' + iconClass;
        bodyIcon.className = 'bi ' + bodyIconClass;
        titleEl.textContent = title;
        messageEl.textContent = message;
        detailsEl.textContent = details;
        button.className = 'btn ' + buttonClass;
        
        // Handle callback
        if (callback) {
          button.onclick = function() {
            modal.hide();
            if (typeof callback === 'function') {
              callback();
            } else if (typeof callback === 'string') {
              window.location.href = callback;
            }
          };
        } else {
          button.onclick = function() {
            modal.hide();
          };
        }
        
        // Show modal
        modal.show();
      }
      
      // Handle Django messages on page load (for backward compatibility)
      {% if messages %}
        {% for message in messages %}
          // Skip modals on conversation detail pages
          const isConversationPage = window.location.pathname.includes('/chat/conversation/');
          if (!isConversationPage) {
          {% if message.tags == 'success' %}
            showMessageModal('success', 'Success', '{{ message|escapejs }}', '');
          {% elif message.tags == 'error' %}
            showMessageModal('error', 'Error', '{{ message|escapejs }}', '');
          {% elif message.tags == 'warning' %}
            showMessageModal('warning', 'Warning', '{{ message|escapejs }}', '');
          {% else %}
            showMessageModal('info', 'Information', '{{ message|escapejs }}', '');
          {% endif %}
          }
        {% endfor %}
      {% endif %}
    </script>

    {% block script %}{% endblock %}
  </body>
</html>
