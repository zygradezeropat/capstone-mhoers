<div class="modal fade" id="editPatients" tabindex="-1" role="dialog" aria-labelledby="editPatientsLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content shadow-lg border-0">
            <!-- Modal Header -->
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editPatientsLabel">
                    <i class="bi bi-pencil-square me-2"></i>Edit Patient Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div> 

            <!-- Modal Body --> 
            <div class="modal-body p-4">
                <form action="{% url 'patients:editPatient' %}" method="POST" id="editPatientForm" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <input type="hidden" name="patient_id" id="edit-patient-id">
                    
                    <!-- Basic Information -->
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="editFname" class="fw-semibold">First Name</label>
                            <input type="text" class="form-control rounded-pill" id="editFname" name="editFname" required placeholder="Enter first name">
                        </div>
                        <div class="col-md-4">
                            <label for="editMname" class="fw-semibold">Middle Name</label>
                            <input type="text" class="form-control rounded-pill" id="editMname" name="editMname" placeholder="Enter middle name">
                        </div>
                        <div class="col-md-4">
                            <label for="editLname" class="fw-semibold">Last Name</label>
                            <input type="text" class="form-control rounded-pill" id="editLname" name="editLname" required placeholder="Enter last name">
                        </div>
                    </div>

                    <!-- Address Information Section -->
                    <div class="row g-3 mt-1">
                        <div class="col-12">
                            <hr class="my-3">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-geo-alt me-2"></i>Address Information
                            </h6>
                        </div>
                    </div>

                    <!-- Province Field -->
                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label for="editProvince" class="fw-semibold">Province</label>
                            <select class="form-control rounded-pill" id="editProvince" name="editProvince" required>
                                <option value="" disabled selected>Select Province</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editMunicipality" class="fw-semibold">City/Municipality</label>
                            <select class="form-control rounded-pill" id="editMunicipality" name="editMunicipality" required disabled>
                                <option value="" disabled selected>Select City/Municipality</option>
                            </select>
                        </div>
                    </div>

                    <!-- Barangay and Purok Row -->
                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label for="editBarangay" class="fw-semibold">Barangay</label>
                            <select class="form-control rounded-pill" id="editBarangay" name="editBarangay" required disabled>
                                <option value="" disabled selected>Select Barangay</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editPurok" class="fw-semibold">Purok</label>
                            <input type="text" class="form-control rounded-pill" id="editPurok" name="editPurok" required placeholder="Enter purok" disabled>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label for="ePhone" class="fw-semibold">Phone Number</label>
                            <input type="tel" class="form-control rounded-pill" id="ePhone" name="ePhone" pattern="[0-9]{11}" inputmode="numeric" required placeholder="Enter 11-digit phone number">
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label for="editBday" class="fw-semibold">Date of Birth</label>
                            <input type="date" class="form-control rounded-pill" id="editBday" name="editBday" required>
                        </div>
                        <div class="col-md-6">
                            <label for="eSex" class="fw-semibold">Sex</label>
                            <select class="form-control rounded-pill" id="eSex" name="eSex" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="row g-3 mt-3">
                        <div class="col-12">
                            <hr class="my-3">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-info-circle me-2"></i>Additional Information
                            </h6>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label for="editCivilStatus" class="fw-semibold">Civil Status</label>
                            <select class="form-control rounded-pill" id="editCivilStatus" name="editCivilStatus">
                                <option value="">Select Civil Status</option>
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                                <option value="Widowed">Widowed</option>
                                <option value="Divorced">Divorced</option>
                                <option value="Separated">Separated</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="editPhicStatus" class="fw-semibold">PHIC Status</label>
                            <select class="form-control rounded-pill" id="editPhicStatus" name="editPhicStatus">
                                <option value="">Select PHIC Status</option>
                                <option value="M">Member</option>
                                <option value="D">Dependent</option>
                                <option value="N">N/A</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="editCctBeneficiary" name="editCctBeneficiary">
                                <label class="form-check-label fw-semibold" for="editCctBeneficiary">
                                    <i class="bi bi-check-circle me-2"></i>CCT Beneficiary
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="editIsPwd" name="editIsPwd">
                                <label class="form-check-label fw-semibold" for="editIsPwd">
                                    <i class="bi bi-person-wheelchair me-2"></i>Person With Disability (PWD)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- PhilHealth Information Section -->
                    <div class="row g-3 mt-3">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editIsPhilhealthMember" name="editIsPhilhealthMember" onchange="toggleEditPhilHealthFields()">
                                <label class="form-check-label fw-semibold" for="editIsPhilhealthMember">
                                    <i class="bi bi-card-checklist me-2"></i>PhilHealth Member
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mt-1" id="editPhilhealthFields" style="display: none;">
                        <div class="col-md-6">
                            <label for="editPhilhealthNumber" class="fw-semibold mb-2 d-block">PhilHealth Number</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-card-text"></i></span>
                                <input type="text" class="form-control rounded-pill" id="editPhilhealthNumber" name="editPhilhealthNumber" placeholder="Enter PhilHealth number">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="editPhilhealthCategory" class="fw-semibold mb-2 d-block">PhilHealth Category</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-tag"></i></span>
                                <select class="form-control rounded-pill" id="editPhilhealthCategory" name="editPhilhealthCategory">
                                    <option value="">Select Category</option>
                                    <option value="Sponsored">Sponsored</option>
                                    <option value="Self Paying">Self Paying</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Family History Section -->
                    <div class="row g-3 mt-3">
                        <div class="col-12">
                            <hr class="my-3">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-diagram-3-fill me-2"></i>Family History
                            </h6>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFamilyHistoryHypertension" name="editFamilyHistoryHypertension">
                                <label class="form-check-label fw-semibold" for="editFamilyHistoryHypertension">
                                    <i class="bi bi-heart-pulse me-2"></i>Hypertension
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFamilyHistoryDiabetes" name="editFamilyHistoryDiabetes">
                                <label class="form-check-label fw-semibold" for="editFamilyHistoryDiabetes">
                                    <i class="bi bi-droplet me-2"></i>Diabetes
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFamilyHistoryCancer" name="editFamilyHistoryCancer">
                                <label class="form-check-label fw-semibold" for="editFamilyHistoryCancer">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Cancer
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFamilyHistoryAsthma" name="editFamilyHistoryAsthma">
                                <label class="form-check-label fw-semibold" for="editFamilyHistoryAsthma">
                                    <i class="bi bi-wind me-2"></i>Asthma
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFamilyHistoryEpilepsy" name="editFamilyHistoryEpilepsy">
                                <label class="form-check-label fw-semibold" for="editFamilyHistoryEpilepsy">
                                    <i class="bi bi-lightning me-2"></i>Epilepsy
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFamilyHistoryTuberculosis" name="editFamilyHistoryTuberculosis">
                                <label class="form-check-label fw-semibold" for="editFamilyHistoryTuberculosis">
                                    <i class="bi bi-lungs me-2"></i>Tuberculosis
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="editFamilyHistoryOthers" class="fw-semibold">Others (Please specify)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-list-ul"></i></span>
                                <textarea class="form-control" id="editFamilyHistoryOthers" name="editFamilyHistoryOthers" rows="3" placeholder="Enter other family history..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="modal-footer bg-light mt-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-warning text-dark">
                            <i class="bi bi-check-circle me-2"></i>Update
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
  // Function to toggle PhilHealth fields in edit modal
  function toggleEditPhilHealthFields() {
    const checkbox = document.getElementById('editIsPhilhealthMember');
    const fieldsContainer = document.getElementById('editPhilhealthFields');
    const numberField = document.getElementById('editPhilhealthNumber');
    const categoryField = document.getElementById('editPhilhealthCategory');
    
    if (checkbox && fieldsContainer && numberField && categoryField) {
      if (checkbox.checked) {
        fieldsContainer.style.display = '';
        fieldsContainer.classList.remove('d-none');
        fieldsContainer.classList.add('d-block');
        numberField.required = true;
        categoryField.required = true;
      } else {
        fieldsContainer.style.display = 'none';
        fieldsContainer.classList.add('d-none');
        fieldsContainer.classList.remove('d-block');
        numberField.required = false;
        categoryField.required = false;
        numberField.value = '';
        categoryField.value = '';
      }
    }
  }

  // Function to parse address string into components
  // Format: "Purok, Barangay, Municipality, Province"
  function parseAddress(addressString) {
    if (!addressString || addressString.trim() === '') {
      return { purok: '', barangay: '', municipality: '', province: '' };
    }
    
    // Split by comma and trim each part
    const parts = addressString.split(',').map(part => part.trim());
    
    // Expected format: Purok, Barangay, Municipality, Province
    if (parts.length >= 4) {
      return {
        purok: parts[0],
        barangay: parts[1],
        municipality: parts[2],
        province: parts.slice(3).join(', ') // Handle province names with commas
      };
    } else if (parts.length === 3) {
      // Handle case where purok might be missing
      return {
        purok: '',
        barangay: parts[0],
        municipality: parts[1],
        province: parts[2]
      };
    }
    
    return { purok: '', barangay: '', municipality: '', province: '' };
  }

  // Helper: select an option by matching its text or value (case-insensitive)
  function setSelectByTextOrValueInsensitive($select, text) {
    if (!text || !$select || !$select.length) return false;
    const want = ('' + text).trim().toLowerCase();
    let matched = false;
    $select.find('option').each(function() {
      const $opt = jQuery(this);
      const optVal = ('' + ($opt.attr('value') || '')).trim().toLowerCase();
      const optText = ('' + ($opt.text() || '')).trim().toLowerCase();
      if (optVal === want || optText === want) {
        $select.val($opt.attr('value'));
        matched = true;
        return false; // break
      }
    });

    // fallback: try contains match on text
    if (!matched) {
      $select.find('option').each(function() {
        const $opt = jQuery(this);
        const optText = ('' + ($opt.text() || '')).trim().toLowerCase();
        if (optText.indexOf(want) !== -1 && want.length > 2) {
          $select.val($opt.attr('value'));
          matched = true;
          return false;
        }
      });
    }

    return matched;
  }

  // Initialize location dropdowns for edit modal
  function initializeEditLocationDropdowns() {
    if (typeof jQuery === 'undefined') {
      console.error('jQuery is not loaded');
      return;
    }
    var $ = jQuery;
    
    const provinceSelect = $('#editProvince');
    const municipalitySelect = $('#editMunicipality');
    const barangaySelect = $('#editBarangay');
    const purokInput = $('#editPurok');
    
    if (provinceSelect.length && municipalitySelect.length && barangaySelect.length) {
      // Load provinces on modal open
      loadEditProvinces();
      
      // Province change handler
      provinceSelect.off('change.edit').on('change.edit', function() {
        const selectedProvince = $(this).val();
        if (selectedProvince) {
          loadEditCities(selectedProvince);
          // Clear city and barangay when province changes
          municipalitySelect.html('<option value="" disabled selected>Select City/Municipality</option>');
          municipalitySelect.prop('disabled', false);
          barangaySelect.html('<option value="" disabled selected>Select Barangay</option>');
          barangaySelect.prop('disabled', true);
          if (purokInput.length) {
            purokInput.val('');
            purokInput.prop('disabled', true);
          }
        } else {
          municipalitySelect.html('<option value="" disabled selected>Select City/Municipality</option>');
          municipalitySelect.prop('disabled', true);
          barangaySelect.html('<option value="" disabled selected>Select Barangay</option>');
          barangaySelect.prop('disabled', true);
          if (purokInput.length) purokInput.prop('disabled', true);
        }
      });
      
      // City change handler
      municipalitySelect.off('change.edit').on('change.edit', function() {
        const selectedCity = $(this).val();
        const selectedProvince = provinceSelect.val();
        if (selectedCity && selectedProvince) {
          loadEditBarangays(selectedCity, selectedProvince);
          // Clear barangay when city changes
          barangaySelect.html('<option value="" disabled selected>Select Barangay</option>');
          barangaySelect.prop('disabled', false);
          if (purokInput.length) {
            purokInput.val('');
            purokInput.prop('disabled', true);
          }
        } else {
          barangaySelect.html('<option value="" disabled selected>Select Barangay</option>');
          barangaySelect.prop('disabled', true);
          if (purokInput.length) purokInput.prop('disabled', true);
        }
      });
      
      // Barangay change handler
      barangaySelect.off('change.edit').on('change.edit', function() {
        const selectedBarangay = $(this).val();
        if (selectedBarangay && purokInput.length) {
          purokInput.prop('disabled', false);
        } else if (purokInput.length) {
          purokInput.val('');
          purokInput.prop('disabled', true);
        }
      });
    }
  }
  
  // Load provinces from API
  function loadEditProvinces() {
    if (typeof jQuery === 'undefined') {
      console.error('jQuery is not loaded');
      return;
    }
    var $ = jQuery;
    
    const provinceSelect = $('#editProvince');
    if (!provinceSelect.length) return;
    
    provinceSelect.html('<option value="" disabled selected>Loading provinces...</option>');
    provinceSelect.prop('disabled', true);
    
    fetch('/facilities/api/psgc-provinces/')
      .then(response => response.json())
      .then(data => {
        provinceSelect.html('<option value="" disabled selected>Select Province</option>');
        if (Array.isArray(data) && data.length > 0) {
          data.forEach(province => {
            const option = $('<option></option>')
              .attr('value', province.name)
              .text(province.name);
            provinceSelect.append(option);
          });
        }
        provinceSelect.prop('disabled', false);
      })
      .catch(error => {
        console.error('Error loading provinces:', error);
        provinceSelect.html('<option value="" disabled selected>Error loading provinces</option>');
        provinceSelect.prop('disabled', false);
      });
  }
  
  // Load cities based on selected province
  function loadEditCities(province) {
    if (typeof jQuery === 'undefined') {
      console.error('jQuery is not loaded');
      return;
    }
    var $ = jQuery;
    
    const municipalitySelect = $('#editMunicipality');
    if (!municipalitySelect.length) return;
    
    municipalitySelect.html('<option value="" disabled selected>Loading cities...</option>');
    municipalitySelect.prop('disabled', true);
    
    const provinceQuery = encodeURIComponent(province);
    fetch(`/facilities/api/psgc-cities/?province=${provinceQuery}`)
      .then(response => response.json())
      .then(data => {
        municipalitySelect.html('<option value="" disabled selected>Select City/Municipality</option>');
        if (Array.isArray(data) && data.length > 0) {
          data.forEach(city => {
            const option = $('<option></option>')
              .attr('value', city.name)
              .text(city.name);
            municipalitySelect.append(option);
          });
        } else {
          const option = $('<option></option>')
            .attr('value', '')
            .text('No cities found')
            .prop('disabled', true);
          municipalitySelect.append(option);
        }
        municipalitySelect.prop('disabled', false);
      })
      .catch(error => {
        console.error('Error loading cities:', error);
        municipalitySelect.html('<option value="" disabled selected>Error loading cities</option>');
        municipalitySelect.prop('disabled', false);
      });
  }
  
  // Load barangays based on selected city and province
  function loadEditBarangays(city, province) {
    if (typeof jQuery === 'undefined') {
      console.error('jQuery is not loaded');
      return;
    }
    var $ = jQuery;
    
    const barangaySelect = $('#editBarangay');
    if (!barangaySelect.length) return;
    
    barangaySelect.html('<option value="" disabled selected>Loading barangays...</option>');
    barangaySelect.prop('disabled', true);
    
    const cityQuery = encodeURIComponent(city);
    const provinceQuery = encodeURIComponent(province);
    fetch(`/facilities/api/psgc-barangays/?city=${cityQuery}&province=${provinceQuery}`)
      .then(response => response.json())
      .then(data => {
        barangaySelect.html('<option value="" disabled selected>Select Barangay</option>');
        if (Array.isArray(data) && data.length > 0) {
          data.forEach(barangay => {
            const option = $('<option></option>')
              .attr('value', barangay.name)
              .text(barangay.name);
            barangaySelect.append(option);
          });
        } else {
          const option = $('<option></option>')
            .attr('value', '')
            .text('No barangays found')
            .prop('disabled', true);
          barangaySelect.append(option);
        }
        barangaySelect.prop('disabled', false);
      })
      .catch(error => {
        console.error('Error loading barangays:', error);
        barangaySelect.html('<option value="" disabled selected>Error loading barangays</option>');
        barangaySelect.prop('disabled', false);
      });
  }

  // Function to populate edit form address fields from parsed address
  function populateEditAddressFields(addressString) {
    if (typeof jQuery === 'undefined') {
      console.error('jQuery is not loaded');
      return;
    }
    var $ = jQuery;
    
    if (!addressString || addressString.trim() === '') {
      console.log('No address to parse');
      return;
    }
    
    const parsed = parseAddress(addressString);
    
    if (!parsed.province) {
      console.log('Could not parse address:', addressString);
      return;
    }
    
    console.log('Parsed address:', parsed);
    
    // Set province first
    const provinceSelect = $('#editProvince');
    if (!provinceSelect.length) {
      console.error('Province select not found');
      return;
    }
    
    // Wait for provinces to load, then set value
    let attempts = 0;
    const maxAttempts = 50; // 5 seconds max wait
    
    const checkProvince = setInterval(function() {
      attempts++;
      const isReady = provinceSelect.prop('disabled') === false && 
                      provinceSelect.find('option').length > 1;
      
      if (isReady || attempts >= maxAttempts) {
        clearInterval(checkProvince);
        
        if (attempts >= maxAttempts) {
          console.error('Timeout waiting for provinces to load');
          return;
        }
        
        // Try to set province using case-insensitive matching (value or text)
        const provMatched = setSelectByTextOrValueInsensitive(provinceSelect, parsed.province);

        if (provMatched) {
          console.log('Province matched and set:', parsed.province);
          provinceSelect.trigger('change.edit');

          // Wait for cities to load, then set municipality using helper
          setTimeout(function() {
            const municipalitySelect = $('#editMunicipality');
            let cityAttempts = 0;
            const checkCity = setInterval(function() {
              cityAttempts++;
              const cityReady = municipalitySelect.prop('disabled') === false && municipalitySelect.find('option').length > 1;

              if (cityReady || cityAttempts >= 30) {
                clearInterval(checkCity);

                if (cityReady) {
                  const muniMatched = setSelectByTextOrValueInsensitive(municipalitySelect, parsed.municipality);
                  if (muniMatched) {
                    console.log('Municipality matched and set:', parsed.municipality);
                    municipalitySelect.trigger('change.edit');

                    // Wait for barangays to load, then set barangay
                    setTimeout(function() {
                      const barangaySelect = $('#editBarangay');
                      let barangayAttempts = 0;
                      const checkBarangay = setInterval(function() {
                        barangayAttempts++;
                        const barangayReady = barangaySelect.prop('disabled') === false && barangaySelect.find('option').length > 1;

                        if (barangayReady || barangayAttempts >= 30) {
                          clearInterval(checkBarangay);

                          if (barangayReady) {
                            const brgyMatched = setSelectByTextOrValueInsensitive(barangaySelect, parsed.barangay);
                            if (brgyMatched) {
                              console.log('Barangay matched and set:', parsed.barangay);

                              // Set purok (text input)
                              const purokInput = $('#editPurok');
                              if (parsed.purok) {
                                purokInput.val(parsed.purok);
                                purokInput.prop('disabled', false);
                                console.log('Purok set:', parsed.purok);
                                console.log('Address population complete!');
                              }
                            } else {
                              console.warn('Failed to match barangay. Expected:', parsed.barangay, 'Available:', barangaySelect.find('option').map(function(){ return jQuery(this).text(); }).get());
                            }
                          } else {
                            console.error('Timeout waiting for barangays to load');
                          }
                        }
                      }, 100);
                    }, 500);
                  } else {
                    console.warn('Failed to match municipality. Expected:', parsed.municipality, 'Available:', municipalitySelect.find('option').map(function(){ return jQuery(this).text(); }).get());
                  }
                } else {
                  console.error('Timeout waiting for cities to load');
                }
              }
            }, 100);
          }, 500);
        } else {
          console.error('Failed to match province. Expected:', parsed.province, 'Available:', provinceSelect.find('option').map(function(){ return jQuery(this).text(); }).get());
        }
      }
    }, 100);
  }

  // Initialize location dropdowns when edit modal is shown
  // Wait for jQuery to be available
  (function() {
    function initEditPatientForm() {
      // Ensure jQuery is available
      if (typeof jQuery === 'undefined') {
        console.log('jQuery not loaded yet, retrying...');
        setTimeout(initEditPatientForm, 100);
        return;
      }
      
      var $ = jQuery;
      
      $(document).ready(function() {
        // Initialize when modal is shown
        // Delegated handler: ensure edit button sets address and patient id before modal opens
        $(document).on('click', '.btn-edit-patient, .btn-edit, [data-action="edit-patient"]', function(e) {
          try {
            const $btn = jQuery(this);
            let addr = $btn.data('address') || $btn.attr('data-address') || '';
            if (!addr) {
              const $tr = $btn.closest('tr');
              addr = $tr.data('address') || $tr.attr('data-address') || '';
            }
            if (addr) {
              window.editPatientAddress = addr;
            }

            let pid = $btn.data('patient-id') || $btn.attr('data-patient-id') || '';
            if (!pid) {
              const $tr = $btn.closest('tr');
              pid = $tr.data('patient-id') || $tr.attr('data-patient-id') || '';
            }
            if (pid) jQuery('#edit-patient-id').val(pid);
          } catch (err) {
            console.warn('Error in delegated edit-button handler', err);
          }
        });

        $('#editPatients').on('shown.bs.modal', function() {
          // Always initialize dropdowns
          initializeEditLocationDropdowns();
          
          // If there's an address stored, populate it after initialization
          if (window.editPatientAddress && typeof populateEditAddressFields === 'function') {
            setTimeout(function() {
              populateEditAddressFields(window.editPatientAddress);
              window.editPatientAddress = null; // Clean up
            }, 600); // Wait a bit longer to ensure provinces are loaded
          }
        });
        
        // Reset form when modal is hidden
        $('#editPatients').on('hidden.bs.modal', function() {
          $('#editProvince').val('').trigger('change.edit');
          $('#editMunicipality').html('<option value="" disabled selected>Select City/Municipality</option>').prop('disabled', true);
          $('#editBarangay').html('<option value="" disabled selected>Select Barangay</option>').prop('disabled', true);
          $('#editPurok').val('').prop('disabled', true);
        });
        
        // Handle form submission - combine address fields into p_address
        $('#editPatientForm').on('submit', function(e) {
          // Get address values for validation
          const province = $('#editProvince').val();
          const municipality = $('#editMunicipality').val();
          const barangay = $('#editBarangay').val();
          const purok = $('#editPurok').val();
          
          // Validate all address fields
          if (!province || !municipality || !barangay || !purok) {
            e.preventDefault();
            alert('Please complete all address fields (Province, City/Municipality, Barangay, and Purok).');
            return false;
          }
          
          // Get address names (text values, not IDs)
          const provinceName = $('#editProvince option:selected').text();
          const municipalityName = $('#editMunicipality option:selected').text();
          const barangayName = $('#editBarangay option:selected').text();
          const purokName = $('#editPurok').val().trim();
          
          // Create address string in format: Purok, Barangay, Municipality, Province
          const fullAddress = `${purokName}, ${barangayName}, ${municipalityName}, ${provinceName}`;
          
          // Remove any existing hidden p_address field to avoid duplicates
          $('#hidden_edit_p_address').remove();
          
          // Create hidden input for p_address that will be submitted to backend
          $('<input>').attr({
            type: 'hidden',
            id: 'hidden_edit_p_address',
            name: 'editAddress',
            value: fullAddress
          }).appendTo(this);
          
          console.log('Edit address being saved to p_address:', fullAddress);
        });
      });
    }
    
    // Start initialization
    initEditPatientForm();
  })();
</script>
