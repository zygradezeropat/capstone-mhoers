<!-- Facility Edit Modal -->
<div class="modal fade" id="editFacilityModal" tabindex="-1" role="dialog" aria-labelledby="editFacilityModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content modern-modal">
      <form method="POST" action="{% url 'facilities:update_facility' %}" id="editFacilityForm" class="provider-form">
        {% csrf_token %}
        <input type="hidden" id="editFacilityId" name="facility_id">
        <div class="modal-header modern-header">
          <div class="header-content">
            <div class="icon-wrapper">
              <i class="bi bi-building-fill"></i>
            </div>
            <div class="title-content">
              <h5 class="modal-title" id="editFacilityModalLabel">Edit Facility</h5>
            </div>
          </div>
          <button type="button" class="btn-close modern-close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body modern-body">
          {% if messages %}
            <div class="alert alert-danger text-center py-2 w-100">
              {% for message in messages %}
                <p>{{ message }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <!-- Facility Information Section -->
          <div class="form-section">
            <div class="section-header">
              <i class="bi bi-building"></i>
              <h6>Facility Information</h6>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" name="facility_name" id="editFacilityName" class="form-control modern-input" placeholder="Facility Name" required>
                  <label for="editFacilityName">Facility Name</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" name="assigned_bhw" id="editAssignedBhw" class="form-control modern-input" placeholder="Assigned BHW" required>
                  <label for="editAssignedBhw">Person Assigned</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" name="barangay" id="editBarangay" class="form-control modern-input" placeholder="Barangay">
                  <label for="editBarangay">Barangay</label>
                </div>
              </div>
            </div>
          </div>

          <!-- Location Selection Section -->
          <div class="form-section">
            <div class="section-header">
              <i class="bi bi-geo-alt"></i>
              <h6>Location Selection</h6>
            </div>
            <div class="location-container">
              <p class="location-instruction">Select a point on the map to set the facility location</p>
              <div id="editMap" class="modern-map"></div>
              <input type="hidden" id="editLatitude" name="latitude" required>
              <input type="hidden" id="editLongitude" name="longitude" required>
            </div>
          </div>
        </div>

        <div class="modal-footer modern-footer">
          <button type="button" class="btn btn-outline-secondary modern-btn-cancel" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-success modern-btn-submit">
            Update Facility
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let editMap;
let editMarker;

function initializeEditMap(lat, lng) {
  if (editMap) {
    editMap.remove();
  }

  editMap = L.map('editMap').setView([lat || 7.587429855100546, lng || 125.82881651697123], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(editMap);

  if (lat && lng) {
    editMarker = L.marker([lat, lng]).addTo(editMap);
  }

  editMap.on('click', function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    document.getElementById('editLatitude').value = lat;
    document.getElementById('editLongitude').value = lng;
    if (editMarker) {
      editMarker.setLatLng([lat, lng]);
    } else {
      editMarker = L.marker([lat, lng]).addTo(editMap);
    }
  });

  setTimeout(() => {
    editMap.invalidateSize();
  }, 100);
}

document.addEventListener('DOMContentLoaded', function() {
  const editModal = document.getElementById('editFacilityModal');
  
  editModal.addEventListener('shown.bs.modal', function(event) {
    const button = event.relatedTarget;
    const row = button.closest('tr');
    
    if (!row) {
      console.error('Could not find table row');
      return;
    }
    
    // Get all data attributes
    const facilityId = row.getAttribute('data-id') || '';
    const facilityName = row.getAttribute('data-facility') || '';
    const barangay = row.getAttribute('data-barangay') || '';
    const latitude = parseFloat(row.getAttribute('data-latitude')) || 7.587429855100546;
    const longitude = parseFloat(row.getAttribute('data-longitude')) || 125.82881651697123;

    // Get assigned_bhw - prioritize table cell since that's what user sees
    let assignedBhw = '';
    
    // Method 1: Get from table cell first (2nd column, index 1 - Assigned BHW column)
    // Column order: 0=Facility Name, 1=Assigned BHW, 2=Barangay, 3=Status, 4=Actions
    const cells = row.querySelectorAll('td');
    if (cells && cells.length > 1) {
      const cellText = cells[1].textContent.trim();
      if (cellText && cellText !== 'None' && cellText !== 'null' && cellText !== 'Not specified') {
        assignedBhw = cellText;
      }
    }
    
    // Method 2: Fallback to data attribute if cell is empty
    if (!assignedBhw || assignedBhw === '') {
      const dataBhwAttr = row.getAttribute('data-bhw');
      if (dataBhwAttr && dataBhwAttr !== 'None' && dataBhwAttr !== 'null' && dataBhwAttr.trim() !== '') {
        assignedBhw = dataBhwAttr.trim();
      }
    }
    
    // Ensure it's a valid string
    if (!assignedBhw || assignedBhw === 'None' || assignedBhw === 'null') {
      assignedBhw = '';
    }

    // Set form values
    const editFacilityIdEl = document.getElementById('editFacilityId');
    const editFacilityNameEl = document.getElementById('editFacilityName');
    const editAssignedBhwEl = document.getElementById('editAssignedBhw');
    const editBarangayEl = document.getElementById('editBarangay');
    const editLatitudeEl = document.getElementById('editLatitude');
    const editLongitudeEl = document.getElementById('editLongitude');

    if (editFacilityIdEl) editFacilityIdEl.value = facilityId || '';
    if (editFacilityNameEl) editFacilityNameEl.value = facilityName || '';
    if (editAssignedBhwEl) {
      editAssignedBhwEl.value = assignedBhw;
    }
    if (editBarangayEl) editBarangayEl.value = barangay || '';
    if (editLatitudeEl) editLatitudeEl.value = latitude || '';
    if (editLongitudeEl) editLongitudeEl.value = longitude || '';

    initializeEditMap(latitude, longitude);
  });

  editModal.addEventListener('hidden.bs.modal', function() {
    if (editMap) {
      editMap.remove();
      editMap = null;
    }
    if (editMarker) {
      editMarker = null;
    }
    document.getElementById('editLatitude').value = '';
    document.getElementById('editLongitude').value = '';
  });
});
</script>
