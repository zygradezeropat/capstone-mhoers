{% extends 'base.html' %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}">

<!-- Navbar Include -->
{% include 'components/navbar.html' %}

<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <div>
        <h4 class="text-primary mb-0">Disease Registry</h4>
        <p class="text-muted">Manage and view disease information with ICD codes and criticality levels</p>
      </div>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDiseaseModal">
        <i class="bi bi-plus-circle me-2"></i>Add Disease
      </button>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm rounded-lg">
        <div class="card-body p-4">
          <div class="table-responsive">
            <table id="diseasesTable" class="table table-striped table-hover align-middle w-100">
              <thead class="table-light">
                <tr>
                  <th>ICD Code</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Critical Level</th>
                </tr>
              </thead>
              <tbody>
                {% for disease in diseases %}
                <tr>
                  <td><strong>{{ disease.icd_code }}</strong></td>
                  <td>{{ disease.name }}</td>
                  <td>{{ disease.description }}</td>
                  <td>
                    {% if disease.critical_level == 'high' %}
                      <span class="badge bg-danger">High</span>
                    {% elif disease.critical_level == 'medium' %}
                      <span class="badge bg-warning text-dark">Medium</span>
                    {% else %}
                      <span class="badge bg-success">Low</span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">No diseases found in the registry.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Disease Modal -->
<div class="modal fade" id="addDiseaseModal" tabindex="-1" role="dialog" aria-labelledby="addDiseaseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content modern-modal">
      <form method="POST" action="{% url 'add_disease' %}" id="addDiseaseForm" class="disease-form">
        {% csrf_token %}
        <div class="modal-header modern-header">
          <div class="header-content">
            <div class="icon-wrapper">
              <i class="bi bi-virus"></i>
            </div>
            <div class="title-content">
              <h5 class="modal-title" id="addDiseaseModalLabel">Add New Disease</h5>
              <p class="modal-subtitle">Register a new disease in the registry</p>
            </div>
          </div>
          <button type="button" class="btn-close modern-close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body modern-body">
          {% if messages %}
            <div class="alert alert-danger modern-alert">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              {% for message in messages %}
                <p class="mb-0">{{ message }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <!-- Basic Information Section -->
          <div class="form-section">
            <div class="section-header">
              <i class="bi bi-info-circle"></i>
              <h6>Basic Information</h6>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" name="icd_code" id="disease_icd_code" class="form-control modern-input" placeholder="ICD Code" maxlength="10" required>
                  <label for="disease_icd_code"><i class="bi bi-code-square me-2"></i>ICD Code</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" name="name" id="disease_name" class="form-control modern-input" placeholder="Disease Name" maxlength="100" required>
                  <label for="disease_name"><i class="bi bi-tag me-2"></i>Disease Name</label>
                </div>
              </div>
            </div>
          </div>

          <!-- Classification Section -->
          <div class="form-section">
            <div class="section-header">
              <i class="bi bi-award"></i>
              <h6>Classification</h6>
            </div>
            <div class="row g-3">
              <div class="col-md-12">
                <div class="form-floating">
                  <select name="critical_level" id="disease_critical_level" class="form-select modern-select" required>
                    <option value="">Select Critical Level</option>
                    <option value="high">High</option>
                    <option value="medium" selected>Medium</option>
                    <option value="low">Low</option>
                  </select>
                  <label for="disease_critical_level"><i class="bi bi-exclamation-triangle me-2"></i>Critical Level</label>
                </div>
              </div>
            </div>
          </div>

          <!-- Description Section -->
          <div class="form-section">
            <div class="section-header">
              <i class="bi bi-file-text"></i>
              <h6>Description</h6>
            </div>
            <div class="row g-3">
              <div class="col-md-12">
                <label for="disease_description" class="form-label">
                  <i class="bi bi-file-text me-2"></i>Detailed Description
                </label>
                <textarea name="description" id="disease_description" class="form-control modern-input" placeholder="Enter detailed description of the disease..." rows="4" required></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer modern-footer">
          <button type="button" class="btn btn-outline-secondary modern-btn-cancel" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </button>
          <button type="submit" class="btn btn-primary modern-btn-submit">
            <i class="bi bi-check-circle me-2"></i>Add Disease
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.modern-modal {
  border: none;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
  overflow: hidden;
}

.modern-header {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
  border: none;
  padding: 2rem;
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.icon-wrapper {
  width: 60px;
  height: 60px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.title-content h5 {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
}

.modal-subtitle {
  font-size: 0.9rem;
  opacity: 0.9;
  margin: 0;
}

.modern-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 1.5rem;
  padding: 0.75rem;
  opacity: 1;
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 1050;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.modern-close:hover {
  background: rgba(255, 255, 255, 0.3);
  color: white;
  transform: scale(1.1);
}

.modern-close:focus {
  box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.5);
  color: white;
}

.modern-close span {
  font-size: 1.5rem;
  font-weight: bold;
  line-height: 1;
}

.modern-body {
  padding: 2rem;
  background: #f8f9fa;
}

.form-section {
  background: white;
  border-radius: 15px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  border: 1px solid #e9ecef;
}

.section-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid #f1f3f4;
}

.section-header i {
  color: #667eea;
  font-size: 1.2rem;
}

.section-header h6 {
  color: #2c3e50;
  font-weight: 600;
  margin: 0;
  font-size: 1.1rem;
}

.modern-input, .modern-select {
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 1rem 0.75rem;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  background: #f8f9fa;
}

.modern-input:focus, .modern-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  background: white;
}

.form-floating > label {
  color: #6c757d;
  font-weight: 500;
}

.form-label {
  color: #6c757d;
  font-weight: 500;
  margin-bottom: 0.5rem;
  display: block;
}

.modern-alert {
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #ff6b6b, #ee5a52);
  color: white;
  padding: 1rem 1.5rem;
  margin-bottom: 1.5rem;
}

.modern-footer {
  background: white;
  border: none;
  padding: 1.5rem 2rem;
  border-top: 1px solid #e9ecef;
}

.modern-btn-cancel {
  border: 2px solid #6c757d;
  border-radius: 10px;
  padding: 0.75rem 1.5rem;
  font-weight: 500;
  transition: all 0.3s ease;
}

.modern-btn-cancel:hover {
  background: #6c757d;
  border-color: #6c757d;
  transform: translateY(-2px);
}

.modern-btn-submit {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  border: none;
  border-radius: 10px;
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  transition: all 0.3s ease;
}

.modern-btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
}

@media (max-width: 768px) {
  .modal-xl {
    max-width: 95%;
  }
  
  .modern-header {
    padding: 1.5rem;
  }
  
  .modern-body {
    padding: 1.5rem;
  }
  
  .header-content {
    flex-direction: column;
    text-align: center;
  }
}

/* DataTables Custom Styling */
#diseasesTable_wrapper .dataTables_filter {
  float: right;
  text-align: right;
  margin-bottom: 1rem;
}

#diseasesTable_wrapper .dataTables_filter input {
  margin-left: 0.5rem;
  padding: 0.5rem;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  width: 250px;
}

#diseasesTable_wrapper .dataTables_length {
  margin-bottom: 1rem;
}

#diseasesTable_wrapper .dataTables_length select {
  padding: 0.5rem;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  margin: 0 0.5rem;
}

#diseasesTable_wrapper .dataTables_info {
  padding-top: 0.85rem;
  color: #6c757d;
}

#diseasesTable_wrapper .dataTables_paginate {
  padding-top: 0.5rem;
}

#diseasesTable_wrapper .dataTables_paginate .paginate_button {
  padding: 0.5rem 0.75rem;
  margin: 0 0.25rem;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  background: white;
  color: #0d6efd !important;
}

#diseasesTable_wrapper .dataTables_paginate .paginate_button:hover {
  background: #0d6efd;
  color: white !important;
  border-color: #0d6efd;
}

#diseasesTable_wrapper .dataTables_paginate .paginate_button.current {
  background: #0d6efd;
  color: white !important;
  border-color: #0d6efd;
}

#diseasesTable_wrapper .dataTables_paginate .paginate_button.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#diseasesTable thead th {
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.875rem;
  letter-spacing: 0.5px;
  border-bottom: 2px solid #dee2e6;
}

#diseasesTable tbody tr:hover {
  background-color: #f8f9fa;
  cursor: pointer;
}

#diseasesTable tbody td {
  vertical-align: middle;
  padding: 1rem 0.75rem;
}
</style>

{% block script %}
<script>
$(document).ready(function() {
  // Initialize DataTable with modern styling
  const tableConfig = {
    responsive: true,
    processing: true,
    dom: '<"row mb-3"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
         '<"row"<"col-sm-12"tr>>' +
         '<"row mt-3"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
    language: {
      search: "",
      searchPlaceholder: "Search diseases...",
      lengthMenu: "Show _MENU_ entries",
      info: "Showing _START_ to _END_ of _TOTAL_ diseases",
      infoEmpty: "Showing 0 to 0 of 0 diseases",
      infoFiltered: "(filtered from _MAX_ total diseases)",
      zeroRecords: "No matching diseases found",
      emptyTable: "No diseases found in the registry",
      paginate: {
        first: "First",
        last: "Last",
        next: "Next",
        previous: "Previous"
      }
    },
    pageLength: 10,
    lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
    order: [[0, 'asc']], // Sort by ICD Code by default
    columnDefs: [
      { 
        targets: [2], 
        orderable: true,
        render: function(data, type, row) {
          if (type === 'display' && data.length > 100) {
            return data.substring(0, 100) + '...';
          }
          return data;
        }
      },
      {
        targets: [0],
        className: "text-nowrap"
      },
      {
        targets: [3],
        className: "text-center"
      }
    ],
    drawCallback: function() {
      // Re-initialize tooltips if needed
      $('[data-bs-toggle="tooltip"]').tooltip();
    }
  };

  if ($("#diseasesTable").length && !$.fn.DataTable.isDataTable('#diseasesTable')) {
    $("#diseasesTable").DataTable(tableConfig);
  }

  // Handle form submission with AJAX
  $('#addDiseaseForm').on('submit', function(e) {
    e.preventDefault();
    const form = $(this);
    const formData = form.serialize();
    const submitBtn = form.find('button[type="submit"]');
    const originalText = submitBtn.html();
    
    // Disable submit button and show loading
    submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Adding...');
    
    $.ajax({
      url: form.attr('action'),
      method: 'POST',
      data: formData,
      success: function(response) {
        // Close modal
        $('#addDiseaseModal').modal('hide');
        
        // Reset form
        form[0].reset();
        
        // Reload page to show new disease
        location.reload();
      },
      error: function(xhr) {
        // Re-enable submit button
        submitBtn.prop('disabled', false).html(originalText);
        
        // Show error message
        let errorMsg = 'An error occurred while adding the disease.';
        if (xhr.responseJSON && xhr.responseJSON.error) {
          errorMsg = xhr.responseJSON.error;
        } else if (xhr.responseText) {
          // Try to extract error from response
          const match = xhr.responseText.match(/<div class="alert[^"]*">([^<]+)<\/div>/);
          if (match) {
            errorMsg = match[1];
          }
        }
        
        // Show error alert
        const alertHtml = `
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            ${errorMsg}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        $('.modal-body').prepend(alertHtml);
      }
    });
  });

  // Reset form when modal is closed
  $('#addDiseaseModal').on('hidden.bs.modal', function() {
    $('#addDiseaseForm')[0].reset();
    $('.alert').remove();
  });
});
</script>
{% endblock script %}

{% endblock %}

