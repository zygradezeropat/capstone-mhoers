{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}" />

<!-- Flatpickr CSS for custom date picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
  .is-invalid {
    border-color: #dc3545 !important;
    background-color: #fff5f5 !important;
  }
  .is-invalid:focus {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
  }
  .invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #dc3545;
  }
  
  /* Date Range Picker Styles */
  .input-group .form-control {
    border-right: none;
  }
  
  .input-group .btn {
    border-left: none;
    padding: 0.375rem 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .input-group .btn:hover {
    background-color: #333 !important;
    border-color: #333 !important;
  }
  
  .input-group .btn:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25);
  }
  
  .form-label {
    font-weight: 500;
    color: #495057;
  }
  
  /* Date input styling for disabled dates */
  input[type="date"]:disabled,
  input[type="date"][readonly] {
    background-color: #e9ecef;
    cursor: not-allowed;
  }
  
  /* Visual feedback for date range constraints */
  .input-group input[type="date"]:invalid {
    border-color: #dc3545;
  }
  
  /* Custom Flatpickr Date Picker Styles - Black and White */
  .flatpickr-calendar {
    font-family: 'Roboto', sans-serif;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: 1px solid #000;
    background-color: #fff;
  }
  
  .flatpickr-months {
    background-color: #000;
    border-radius: 8px 8px 0 0;
    padding: 10px;
  }
  
  .flatpickr-month {
    color: #fff;
  }
  
  .flatpickr-current-month {
    color: #fff;
    font-weight: 600;
  }
  
  .flatpickr-prev-month,
  .flatpickr-next-month {
    color: #fff;
    fill: #fff;
    padding: 5px;
    border-radius: 4px;
    transition: background-color 0.2s;
  }
  
  .flatpickr-prev-month:hover,
  .flatpickr-next-month:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }
  
  .flatpickr-weekdays {
    background-color: #f8f9fa;
    border-bottom: 1px solid #000;
  }
  
  .flatpickr-weekday {
    color: #000;
    font-weight: 600;
    font-size: 0.85rem;
  }
  
  .flatpickr-day {
    border-radius: 6px;
    margin: 2px;
    transition: all 0.2s;
    color: #000;
  }
  
  .flatpickr-day:hover {
    background-color: #e9ecef;
    border-color: #000;
  }
  
  .flatpickr-day.selected,
  .flatpickr-day.startRange,
  .flatpickr-day.endRange {
    background-color: #000;
    border-color: #000;
    color: #fff;
    font-weight: 600;
  }
  
  .flatpickr-day.inRange {
    background-color: #e9ecef;
    border-color: #000;
    color: #000;
  }
  
  .flatpickr-day.today {
    border-color: #000;
    border-width: 2px;
    font-weight: 600;
  }
  
  .flatpickr-day.today:hover {
    background-color: #000;
    color: #fff;
  }
  
  .flatpickr-day.flatpickr-disabled,
  .flatpickr-day.prevMonthDay,
  .flatpickr-day.nextMonthDay {
    color: #999;
    opacity: 0.5;
  }
  
  .flatpickr-time {
    border-top: 1px solid #000;
    padding: 10px;
    background-color: #fff;
  }
  
  .flatpickr-time input {
    border-radius: 4px;
    border: 1px solid #000;
    color: #000;
  }
  
  .flatpickr-time input:hover {
    background-color: #f8f9fa;
  }
  
  /* Month and Year Dropdown Styles - Black and White */
  .flatpickr-monthDropdown-months,
  .flatpickr-yearDropdown {
    background-color: #fff;
    border: 1px solid #000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .flatpickr-monthDropdown-month,
  .flatpickr-yearDropdown-year {
    color: #000;
    background-color: #fff;
  }
  
  .flatpickr-monthDropdown-month:hover,
  .flatpickr-yearDropdown-year:hover {
    background-color: #e9ecef;
    color: #000;
  }
  
  .flatpickr-monthDropdown-month.selected,
  .flatpickr-yearDropdown-year.selected {
    background-color: #000 !important;
    color: #fff !important;
  }
  
  .flatpickr-monthDropdown-month.flatpickr-disabled,
  .flatpickr-yearDropdown-year.flatpickr-disabled {
    color: #999;
    opacity: 0.5;
  }
  
  /* Custom input styling */
  .custom-date-input {
    cursor: pointer;
    background-color: white;
    color: #000;
  }
  
  .custom-date-input:focus {
    border-color: #000;
    box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25);
  }
</style>

<!-- Navbar Include -->
{% include 'components/navbar.html' %}

<div class="container-fluid py-4">
  

  <!-- Tab Navigation -->
  {% include 'components/tabbar/tabbar.html' with tab5_name="Generate Reports" tab5_icon="bi-printer" active_tab="tab5" tab1_count=0 show_pending_fallback=False %}

  <!-- Tab Content -->
  <div class="tab-content" id="dashboardTabContent">
    <!-- Tab 1: Referral Statistics -->
    {% comment %}
    <div class="tab-pane fade show active" id="tab1" role="tabpanel">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="row align-items-end mb-4">
            
            <div class="col-md-4">
              <label for="statStartDate" class="form-label small mb-1">START DATE</label>
              <div class="input-group">
                <input type="text" class="form-control custom-date-input" id="statStartDate" name="start_date" placeholder="Select start date" readonly>
                <button type="button" class="btn" style="background-color: #000; color: white; border: 1px solid #000;" id="statStartDateBtn">
                  <i class="bi bi-calendar3"></i>
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <label for="statEndDate" class="form-label small mb-1">END DATE</label>
              <div class="input-group">
                <input type="text" class="form-control custom-date-input" id="statEndDate" name="end_date" placeholder="Select end date" readonly>
                <button type="button" class="btn" style="background-color: #000; color: white; border: 1px solid #000;" id="statEndDateBtn">
                  <i class="bi bi-calendar3"></i>
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1 d-block">&nbsp;</label>
              <button type="button" class="btn btn-outline-secondary w-100" onclick="clearStatFilters()" title="Clear date filters">
                <i class="bi bi-x-circle me-2"></i>Clear Filters
              </button>
            </div>
          </div>
        
          <h5 class="card-title mb-4">Monthly Referral</h5>
          <canvas id="monthlyReportChart" height="100"></canvas>
        </div>
      </div>
    </div>
    {% endcomment %}

    <!-- Tab 2: Common Diagnoses -->
    {% comment %}
    <div class="tab-pane fade" id="tab2" role="tabpanel">
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
              <h5 class="card-title mb-4">Top Diagnosed Cases</h5>
              <div style="height: 300px;">
                <canvas id="topDiagnosedChart" style="max-height: 100%; width: 100%;"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
              <h5 class="card-title mb-4">Diagnosis Trends</h5>
              <div style="height: 300px;">
                <canvas id="topTrendsDiagnosed" style="max-height: 100%; width: 100%;"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endcomment %}

    <!-- Tab 3: Barangay Performance -->
    {% comment %}
    <div class="tab-pane fade" id="tab3" role="tabpanel">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <h5 class="card-title mb-4">Barangay Performance Analytics</h5>
          
          <div class="row mb-4">
            <div class="col-md-6 mb-4">
              <h6 class="text-muted mb-3">Referral Status Overview</h6>
              <canvas id="stackedBarangayChart" height="200"></canvas>
            </div>
            <div class="col-md-6 mb-4">
              <h6 class="text-muted mb-3">Completion Rate Analysis</h6>
              <canvas id="groupedBarangayChart" height="200"></canvas>
            </div>
          </div>
  
    
        </div>
      </div>
    </div>
    {% endcomment %}

    <!-- Tab 5: Reports -->
    <div class="tab-pane fade show active" id="tab5" role="tabpanel">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          {% if request.user.is_superuser and not is_doctor %}
          <h5 class="fw-bold mb-4">Export Referral Reports (CSV)</h5>
          
          <form id="exportCsvForm" method="get" action="{% url 'referrals:export_referrals_csv' %}">
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label for="exportFacility" class="form-label small mb-1">Facility</label>
                <select class="form-select" id="exportFacility" name="facility_id">
                  <option value="">All Facilities</option>
                  {% for facility in facilities %}
                    <option value="{{ facility.facility_id }}">{{ facility.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label for="exportYear" class="form-label small mb-1">Year</label>
                <input type="number" class="form-control" id="exportYear" name="year" placeholder="e.g. 2025" min="2000" max="2100">
              </div>
              <div class="col-md-3">
                <label for="exportMonth" class="form-label small mb-1">Month</label>
                <select class="form-select" id="exportMonth" name="month">
                  <option value="">All</option>
                  <option value="1">January</option>
                  <option value="2">February</option>
                  <option value="3">March</option>
                  <option value="4">April</option>
                  <option value="5">May</option>
                  <option value="6">June</option>
                  <option value="7">July</option>
                  <option value="8">August</option>
                  <option value="9">September</option>
                  <option value="10">October</option>
                  <option value="11">November</option>
                  <option value="12">December</option>
                </select>
              </div>
              <div class="col-md-3">
                <button type="submit" class="btn btn-outline-primary w-100">
                  <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export CSV
                </button>
              </div>
            </div>
          </form>
          {% endif %}

          <!-- Printable Reports Section -->
          <div class="{% if request.user.is_superuser and not is_doctor %}mt-5{% endif %}">
            <h5 class="fw-bold mb-4">Generate Printable Reports</h5>
            
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label for="printReportSelect" class="form-label small mb-1">Report Type</label>
                <select class="form-select" id="printReportSelect">
                  <option value="">-- Choose a report --</option>
                  {% if is_doctor %}
                  <option value="{% url 'doctor_transactions_report' %}">
                    My Transactions
                  </option>
                  {% endif %}
                  {% if not is_doctor %}
                  <option value="{% url 'barangay_referral_performance_report' %}">
                    Barangay Performance Summary
                  </option>
                  {% endif %}
                  <option value="{% url 'morbidity_report' %}">
                    Top-Diagnosis
                  </option>
                  {% if not is_doctor %}
                  <option value="{% url 'facility_workforce_masterlist' %}">
                    Workforce Masterlist
                  </option>
                  {% endif %}
                  <option value="{% url 'referral_registry_report' %}">
                    Referral Registry with Vital Signs
                  </option>
                  {% if not is_doctor %}
                  <option value="{% url 'system_usage_scorecard_report' %}">
                    System Usage & Adoption Scorecard
                  </option>
                  {% endif %}
                </select>
              </div>
              <div class="col-md-3">
                <label for="printStartDate" class="form-label small mb-1">START DATE</label>
                <div class="input-group">
                  <input type="text" class="form-control custom-date-input" id="printStartDate" name="start_date" placeholder="Select start date" readonly>
                  <button type="button" class="btn" style="background-color: #000; color: white; border: 1px solid #000;" id="printStartDateBtn">
                    <i class="bi bi-calendar3"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-3">
                <label for="printEndDate" class="form-label small mb-1">END DATE</label>
                <div class="input-group">
                  <input type="text" class="form-control custom-date-input" id="printEndDate" name="end_date" placeholder="Select end date" readonly>
                  <button type="button" class="btn" style="background-color: #000; color: white; border: 1px solid #000;" id="printEndDateBtn">
                    <i class="bi bi-calendar3"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label small mb-1 d-block">&nbsp;</label>
                <button type="button" class="btn btn-outline-primary w-100" onclick="generatePrintableReport()">
                  <i class="bi bi-printer me-2"></i>Preview
                </button>
              </div>
            </div>
            
           
            
            <!-- Report Preview Container -->
            <div id="reportPreviewContainer" class="mt-4" style="display: none;">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                  <h6 class="mb-0 fw-bold" id="reportPreviewTitle">
                    <i class="bi bi-file-earmark-text me-2"></i>Report Preview
                  </h6>
                  <div>
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="printReportContent()">
                      <i class="bi bi-printer me-1"></i>Print
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closeReportPreview()">
                      <i class="bi bi-x-lg"></i> Close
                    </button>
                  </div>
                </div>
                <div class="card-body p-0 position-relative" style="max-height: 800px; overflow-y: auto;">
                  <div id="reportLoadingIndicator" class="text-center p-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading report...</p>
                  </div>
                  <div id="reportContent" style="display: none;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

{% block script %}
<!-- Flatpickr JS for custom date picker -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

{% comment %}
<script src="{% static 'js/user/line_chart_user.js' %}"></script>
<script src="{% static 'js/user/topDiagnosedPie_chart_user.js' %}"></script>
<script src="{% static 'js/user/barangay_performance_user.js' %}"></script>
{% endcomment %}

<script>
  // Initialize Flatpickr for custom date pickers
  document.addEventListener('DOMContentLoaded', function() {
    const statStartDateInput = document.getElementById('statStartDate');
    const statEndDateInput = document.getElementById('statEndDate');
    const statStartDateBtn = document.getElementById('statStartDateBtn');
    const statEndDateBtn = document.getElementById('statEndDateBtn');
    
    // Update date constraints dynamically
    function updateStatDateConstraints() {
      if (startDatePicker && endDatePicker) {
        const startDate = startDatePicker.selectedDates[0];
        const endDate = endDatePicker.selectedDates[0];
        
        if (startDate) {
          endDatePicker.set('minDate', startDate);
        } else {
          endDatePicker.set('minDate', null);
        }
        
        if (endDate) {
          startDatePicker.set('maxDate', endDate);
        } else {
          startDatePicker.set('maxDate', null);
        }
      }
    }
    
    // Initialize Flatpickr for START DATE
    let startDatePicker = null;
    if (statStartDateInput) {
      startDatePicker = flatpickr(statStartDateInput, {
        dateFormat: "Y-m-d",
        altInput: false,
        allowInput: false,
        clickOpens: true,
        theme: "default",
        onChange: function(selectedDates, dateStr, instance) {
          // Update the actual input value for form submission
          statStartDateInput.value = dateStr;
          // Update constraints
          updateStatDateConstraints();
          // Trigger change event for auto-filter
          statStartDateInput.dispatchEvent(new Event('change', { bubbles: true }));
        },
        onClose: function(selectedDates, dateStr, instance) {
          // Ensure value is set
          if (dateStr) {
            statStartDateInput.value = dateStr;
          }
        }
      });
      
      // Make button trigger the picker
      if (statStartDateBtn) {
        statStartDateBtn.addEventListener('click', function() {
          startDatePicker.open();
        });
      }
    }
    
    // Initialize Flatpickr for END DATE
    let endDatePicker = null;
    if (statEndDateInput) {
      endDatePicker = flatpickr(statEndDateInput, {
        dateFormat: "Y-m-d",
        altInput: false,
        allowInput: false,
        clickOpens: true,
        theme: "default",
        onChange: function(selectedDates, dateStr, instance) {
          // Update the actual input value for form submission
          statEndDateInput.value = dateStr;
          // Update constraints
          updateStatDateConstraints();
          // Trigger change event for auto-filter
          statEndDateInput.dispatchEvent(new Event('change', { bubbles: true }));
        },
        onClose: function(selectedDates, dateStr, instance) {
          // Ensure value is set
          if (dateStr) {
            statEndDateInput.value = dateStr;
          }
        }
      });
      
      // Make button trigger the picker
      if (statEndDateBtn) {
        statEndDateBtn.addEventListener('click', function() {
          endDatePicker.open();
        });
      }
    }
    
    // Initialize constraints
    updateStatDateConstraints();
    
    // Initialize Flatpickr for PRINT date pickers
    const printStartDateInput = document.getElementById('printStartDate');
    const printEndDateInput = document.getElementById('printEndDate');
    const printStartDateBtn = document.getElementById('printStartDateBtn');
    const printEndDateBtn = document.getElementById('printEndDateBtn');
    
    // Update print date constraints dynamically
    function updatePrintDateConstraints() {
      if (printStartDatePicker && printEndDatePicker) {
        const startDate = printStartDatePicker.selectedDates[0];
        const endDate = printEndDatePicker.selectedDates[0];
        
        if (startDate) {
          printEndDatePicker.set('minDate', startDate);
        } else {
          printEndDatePicker.set('minDate', null);
        }
        
        if (endDate) {
          printStartDatePicker.set('maxDate', endDate);
        } else {
          printStartDatePicker.set('maxDate', null);
        }
      }
    }
    
    // Initialize Flatpickr for PRINT START DATE
    let printStartDatePicker = null;
    if (printStartDateInput) {
      printStartDatePicker = flatpickr(printStartDateInput, {
        dateFormat: "Y-m-d",
        altInput: false,
        allowInput: false,
        clickOpens: true,
        theme: "default",
        onChange: function(selectedDates, dateStr, instance) {
          printStartDateInput.value = dateStr;
          updatePrintDateConstraints();
          printStartDateInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      
      if (printStartDateBtn) {
        printStartDateBtn.addEventListener('click', function() {
          printStartDatePicker.open();
        });
      }
    }
    
    // Initialize Flatpickr for PRINT END DATE
    let printEndDatePicker = null;
    if (printEndDateInput) {
      printEndDatePicker = flatpickr(printEndDateInput, {
        dateFormat: "Y-m-d",
        altInput: false,
        allowInput: false,
        clickOpens: true,
        theme: "default",
        onChange: function(selectedDates, dateStr, instance) {
          printEndDateInput.value = dateStr;
          updatePrintDateConstraints();
          printEndDateInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      
      if (printEndDateBtn) {
        printEndDateBtn.addEventListener('click', function() {
          printEndDatePicker.open();
        });
      }
    }
    
    // Initialize print constraints
    updatePrintDateConstraints();
  });
</script>

<script>
  function generatePrintableReport() {
    const reportSelect = document.getElementById('printReportSelect');
    const startDateInput = document.getElementById('printStartDate');
    const endDateInput = document.getElementById('printEndDate');
    const previewContainer = document.getElementById('reportPreviewContainer');
    const reportContent = document.getElementById('reportContent');
    const loadingIndicator = document.getElementById('reportLoadingIndicator');
    
    // Reset previous error states
    startDateInput.classList.remove('is-invalid');
    endDateInput.classList.remove('is-invalid');
    
    // Remove any existing error messages
    const existingErrors = document.querySelectorAll('.invalid-feedback');
    existingErrors.forEach(error => error.remove());
    
    let hasErrors = false;
    
    if (!reportSelect.value) {
      alert('Please select a report type.');
      return;
    }
    
    // Validate required fields
    if (!startDateInput.value || startDateInput.value.trim() === '') {
      startDateInput.classList.add('is-invalid');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'invalid-feedback';
      errorDiv.textContent = 'START DATE is required.';
      startDateInput.parentElement.appendChild(errorDiv);
      hasErrors = true;
    }
    
    if (!endDateInput.value || endDateInput.value.trim() === '') {
      endDateInput.classList.add('is-invalid');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'invalid-feedback';
      errorDiv.textContent = 'END DATE is required.';
      endDateInput.parentElement.appendChild(errorDiv);
      hasErrors = true;
    }
    
    // If there are validation errors, stop here
    if (hasErrors) {
      // Scroll to first error field
      const firstError = document.querySelector('.is-invalid');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstError.focus();
      }
      return;
    }
    
    // Validate date range
    let url = reportSelect.value;
    const params = new URLSearchParams();
    
    // For BHW users: backend automatically filters by facility
    // For staff/superusers: can optionally filter by user_id if needed
    // Doctors: filtered by examined_by automatically
    // Note: user_id parameter removed - backend now handles facility filtering for BHW users
    
    if (startDateInput.value && endDateInput.value) {
      const startDate = new Date(startDateInput.value);
      const endDate = new Date(endDateInput.value);
      if (startDate > endDate) {
        startDateInput.classList.add('is-invalid');
        endDateInput.classList.add('is-invalid');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.textContent = 'START DATE cannot be greater than END DATE.';
        endDateInput.parentElement.appendChild(errorDiv);
        endDateInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      
      // Extract year and month from dates for backward compatibility with report views
      const startYear = startDate.getFullYear();
      const startMonth = startDate.getMonth() + 1;
      const endYear = endDate.getFullYear();
      const endMonth = endDate.getMonth() + 1;
      
      // Add year (use start year, or end year if different)
      params.append('year', startYear);
      
      // If same year and month, use single month
      if (startYear === endYear && startMonth === endMonth) {
        params.append('month', startMonth);
      } else {
        // Use month range
        params.append('month_from', startMonth);
        params.append('month_to', endMonth);
        // If different years, we need to handle this - for now use the range
        if (startYear !== endYear) {
          params.set('year', startYear);
          // Note: This might need adjustment based on how reports handle cross-year ranges
        }
      }
      
      // Also add date_from and date_to for reports that support direct date filtering
      params.append('date_from', startDateInput.value);
      params.append('date_to', endDateInput.value);
    }
    
    // Append query string if there are any parameters
    if (params.toString()) {
      url += '?' + params.toString();
    }
    
    // Show loading indicator
    loadingIndicator.style.display = 'block';
    reportContent.style.display = 'none';
    reportContent.innerHTML = '';
    previewContainer.style.display = 'block';
    
    // Fetch the HTML content
    console.log('Fetching report from:', url);
    fetch(url, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
      credentials: 'same-origin'
    })
    .then(response => {
      console.log('Response status:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.text();
    })
    .then(html => {
      console.log('HTML received, length:', html.length);
      // Extract the main content from the response
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Remove navbar and header elements first
      const navbars = doc.querySelectorAll('nav, .navbar, header, [role="navigation"]');
      navbars.forEach(el => el.remove());
      
      // Find the container-fluid that contains the report
      const containerFluid = doc.querySelector('.container-fluid');
      
      if (!containerFluid) {
        throw new Error('Could not find report container');
      }
      
      // Find the card inside container-fluid (this is the actual report)
      const reportCard = containerFluid.querySelector('.card.border-0.shadow-sm, .card');
      
      if (!reportCard) {
        throw new Error('Could not find report card');
      }
      
      // Clone the report card to preserve original structure
      const clonedCard = reportCard.cloneNode(true);
      
      // Remove any d-print-block headers from cloned content to prevent duplication
      const printHeadersInClone = clonedCard.querySelectorAll('.d-print-block, .print-header');
      printHeadersInClone.forEach(header => {
        // Only remove if it's a standalone header, not part of the main header structure
        if (!header.closest('.d-flex.align-items-center')) {
          header.remove();
        }
      });
      
      // Remove notes section from print output
      const notesSections = clonedCard.querySelectorAll('.notes-list, .mt-3.notes-list, .print-notes, .mt-3 small');
      notesSections.forEach(notes => {
        // Check if it's a notes section (contains "Notes:" or "Generated on" text)
        const notesText = notes.textContent || '';
        if (notesText.includes('Notes:') || notesText.includes('Generated on') || notesText.includes('Counts reflect') || notesText.includes('Possible Rabies') || notesText.includes('Gastrointestinal Issue')) {
          notes.remove();
        }
      });
      
      // Remove filter forms and buttons (but preserve header with logos and title)
      const forms = clonedCard.querySelectorAll('form.d-print-none, form[method="get"]');
      forms.forEach(form => {
        // Only remove if it's a filter form, not part of the header
        if (!form.closest('.d-flex.align-items-center')) {
          form.remove();
        }
      });
      
      // Remove back buttons and navigation links
      const backButtons = clonedCard.querySelectorAll('a[href*="report_analytics"], .btn-outline-secondary');
      backButtons.forEach(btn => {
        // Only remove if it's clearly a back button, not part of report content
        if (btn.textContent.includes('Back') || btn.closest('.mb-3')) {
          btn.closest('.mb-3')?.remove() || btn.remove();
        }
      });
      
      // Remove print buttons (but keep the report structure and header)
      const printButtons = clonedCard.querySelectorAll('button[onclick*="print"], button[onclick*="Print"]');
      printButtons.forEach(btn => {
        // Check if this button is part of the header section (which has logos)
        const flexParent = btn.closest('.d-flex');
        if (flexParent) {
          // Check if this flex container has logos - if so, it's the header, don't remove
          const hasLogos = flexParent.querySelector('.report-logo, img[alt*="Logo"]');
          if (hasLogos) {
            return; // Skip - this is in the header section, don't remove
          }
        }
        
        // IMPORTANT: Don't remove if it's near the notes section (which contains timestamp)
        const notesSection = btn.closest('.mt-3, [class*="notes"]');
        if (notesSection) {
          return; // Skip - don't remove buttons near notes section
        }
        
        // Remove the button and its parent row/container if it's a print button
        const parent = btn.closest('.row, .d-grid');
        if (parent && parent.querySelector('button[onclick*="print"]')) {
          // Double-check: don't remove if parent contains notes section
          if (!parent.querySelector('.mt-3, [class*="notes"], small.text-muted')) {
            parent.remove();
          }
        } else if (flexParent && !flexParent.querySelector('.report-logo, img[alt*="Logo"]')) {
          // Only remove d-flex parent if it doesn't contain logos (not the header)
          if (flexParent.querySelector('button[onclick*="print"]')) {
            // Double-check: don't remove if parent contains notes section
            if (!flexParent.querySelector('.mt-3, [class*="notes"], small.text-muted')) {
              flexParent.remove();
            }
          }
        }
      });
      
      // Verify header section exists before replacing middle section
      const headerCheck = clonedCard.querySelector('.d-flex.align-items-center');
      if (!headerCheck) {
        console.warn('Header section not found in cloned card');
      }
      
      // Check if this is a Barangay Performance report
      const isBarangayPerformance = url.includes('barangay-referral-performance');

      // Determine the report title based on selected report
      const reportTitleMap = [
        { keys: ['doctor_transactions_report'], title: 'My Transactions Report' },
        { keys: ['barangay-referral-performance'], title: 'Barangay Performance Summary' },
        { keys: ['morbidity'], title: 'TOP DIAGNOSIS REPORT' },
        { keys: ['facility_workforce_masterlist', 'facility-workforce'], title: 'FACILITY & WORKFORCE MASTERLIST' },
        { keys: ['referral_registry_report', 'referral-registry'], title: 'REFERRAL REGISTRY WITH VITAL SIGNS' },
        { keys: ['system_usage_scorecard', 'system-usage-scorecard'], title: 'SYSTEM USAGE & ADOPTION SCORECARD' },
      ];

      let reportTitle = 'Report Preview';
      const selectedUrl = reportSelect.value || '';
      for (const entry of reportTitleMap) {
        const keys = entry.keys || [entry.key];
        if (keys.some(key => selectedUrl.includes(key))) {
          reportTitle = entry.title;
          break;
        }
      }

      const previewTitleEl = document.getElementById('reportPreviewTitle');
      if (previewTitleEl) {
        previewTitleEl.innerHTML = `<i class="bi bi-file-earmark-text me-2"></i>${reportTitle}`;
      }
      
      // Format date for display (e.g., "November 01, 2025")
      function formatDateForDisplay(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
        const month = months[date.getMonth()];
        const day = String(date.getDate()).padStart(2, '0');
        const year = date.getFullYear();
        return `${month} ${day}, ${year}`;
      }
      
      // Get reporting period date range
      let reportingPeriodHtml = '';
      if (!isBarangayPerformance && startDateInput.value && endDateInput.value) {
        const startDateFormatted = formatDateForDisplay(startDateInput.value);
        const endDateFormatted = formatDateForDisplay(endDateInput.value);
        reportingPeriodHtml = `<div style="font-size: 10pt; color: #333; margin-top: 4px; font-weight: 500;">Reporting Period: ${startDateFormatted} to ${endDateFormatted}</div>`;
      }
      
      // Replace the middle section with official address information
      const middleSection = clonedCard.querySelector('.text-center.flex-grow-1.px-lg-4, .text-center');
      if (middleSection) {
        middleSection.innerHTML = `
          <div style="font-size: 11pt; line-height: 1.3;">
            <div style="font-weight: bold; margin-bottom: 1px;">Republic of the Philippines</div>
            <div style="font-weight: bold; margin-bottom: 1px;">Province of Davao del Norte</div>
            <div style="font-weight: bold; font-size: 12pt; margin-bottom: 1px;">Municipality of New Corella</div>
            <div style="font-weight: bold; margin-bottom: 1px;">Municipal Health Office</div>
            <div style="font-size: 9pt; color: #666; margin-top: 2px;">Purok 5, Poblacion, New Corella | rhunewcorella@yahoo.com | (+63) 970-093-3480</div>
            <div class="mt-4" style="font-weight: bold; font-size: 13pt; text-transform: uppercase; letter-spacing: 0.5px;">${reportTitle}</div>
            ${reportingPeriodHtml}
          </div>
        `;
      } else {
        console.warn('Middle section not found for address replacement');
      }
      
      // Remove any title elements (but be more specific - don't use [class*="date"] as it's too broad)
      const titleElements = clonedCard.querySelectorAll('title, .report-title');
      titleElements.forEach(el => el.remove());
      
      // Remove standalone date/time elements that are clearly not part of report content
      // IMPORTANT: Only check direct text content, not all descendant text, to avoid removing
      // parent containers that contain tables with dates
      const allTextElements = Array.from(clonedCard.querySelectorAll('*'));
      allTextElements.forEach(el => {
        // Skip if element is inside a table (protect table content)
        if (el.closest('table')) {
          return;
        }
        
        // Skip if element contains a table (protect containers with tables)
        if (el.querySelector('table')) {
          return;
        }
        
        // Skip if element is a table-related element
        if (el.tagName === 'TABLE' || el.tagName === 'TH' || el.tagName === 'TD' || el.tagName === 'TR' || el.tagName === 'THEAD' || el.tagName === 'TBODY') {
          return;
        }
        
        // Only check direct text nodes, not all descendant text
        const directText = Array.from(el.childNodes)
          .filter(node => node.nodeType === Node.TEXT_NODE)
          .map(node => node.textContent)
          .join('')
          .trim();
        
        // Also check if element itself has date-related classes (but be specific)
        const hasDateClass = el.className && (
          el.className.includes('timestamp') || 
          el.className.includes('generated-on') ||
          el.className.includes('report-date')
        );
        
        // Only remove if:
        // 1. Direct text contains date patterns AND element doesn't contain tables, OR
        // 2. Element has specific date-related classes
        if (hasDateClass || (directText && (directText.match(/\d{1,2}\/\d{1,2}\/\d{2,4}/) || directText.match(/\d{1,2}:\d{2}\s*(AM|PM)/i)))) {
          // Additional safety: only remove small standalone elements, never major structural elements
          const isMajorElement = ['DIV', 'SECTION', 'ARTICLE', 'MAIN', 'BODY', 'CARD-BODY'].includes(el.tagName) || 
                                 el.classList.contains('card-body') || 
                                 el.classList.contains('card') ||
                                 el.classList.contains('table-responsive');
          
          if (!isMajorElement) {
            // Only remove small standalone elements that are clearly date/timestamp elements
            if (el.tagName === 'SMALL' || el.tagName === 'SPAN' || (el.tagName === 'P' && el.classList.contains('text-muted'))) {
              el.remove();
            }
          }
        }
      });
      
      // Fix logo sizes in the cloned card
      const logos = clonedCard.querySelectorAll('img.report-logo, img[alt*="Logo"]');
      logos.forEach(logo => {
        logo.style.width = '80px';
        logo.style.height = '80px';
        logo.style.objectFit = 'contain';
        logo.style.flexShrink = '0';
      });
      
      // Remove any scripts that might cause issues
      const scripts = clonedCard.querySelectorAll('script');
      scripts.forEach(script => script.remove());
      
      // Remove pending and in-progress columns from tables (but NOT for Barangay Performance report)
      // Barangay Performance report needs these columns visible
      // Note: isBarangayPerformance is already defined above
      if (!isBarangayPerformance) {
        const pendingColumns = clonedCard.querySelectorAll('.status-pending, .status-in-progress');
        pendingColumns.forEach(col => {
          col.remove();
        });
        
        // Update colspan in header rows to account for removed columns (2 columns: pending and in-progress)
        const headerRows = clonedCard.querySelectorAll('th[colspan]');
        headerRows.forEach(header => {
          const currentColspan = parseInt(header.getAttribute('colspan')) || 0;
          if (currentColspan > 0) {
            header.setAttribute('colspan', Math.max(1, currentColspan - 2));
          }
        });
      }
      
      // Verify that essential content exists before proceeding
      const hasTable = clonedCard.querySelector('table');
      const hasContent = clonedCard.querySelector('.card-body, .table-responsive, table, .registry-table');
      
      if (!hasContent && !hasTable) {
        console.warn('Warning: No table or main content found in cloned card');
      }
      
      // Get cleaned HTML - preserve the exact structure including header
      let contentHtml = clonedCard.innerHTML;
      
      if (!contentHtml || contentHtml.trim().length === 0) {
        // Log diagnostic information
        console.error('Report content is empty after processing');
        console.error('Original card HTML length:', reportCard.innerHTML.length);
        console.error('Cloned card HTML length:', clonedCard.innerHTML.length);
        console.error('URL:', url);
        throw new Error('Report content is empty');
      }
      
      // Hide loading indicator and show content
      loadingIndicator.style.display = 'none';
      reportContent.innerHTML = contentHtml;
      reportContent.style.display = 'block';
      
      console.log('Report preview loaded successfully');
    })
    .catch(error => {
      console.error('Error loading report:', error);
      loadingIndicator.style.display = 'none';
      reportContent.innerHTML = `
        <div class="alert alert-danger m-4" role="alert">
          <h6 class="alert-heading">Error Loading Report</h6>
          <p class="mb-0">${error.message}</p>
        </div>
      `;
      reportContent.style.display = 'block';
    });
  }

  function printReportContent() {
    const reportContent = document.getElementById('reportContent');
    if (!reportContent || !reportContent.innerHTML.trim()) {
      alert('No report preview available. Please generate a report first.');
      return;
    }
    
    // Get exactly what's shown in the preview - print it as-is
    let content = reportContent.innerHTML;
    
    // Process content to remove excessive spacing and optimize for print
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = content;
    
    // Check if this is a Barangay Performance report by looking for the report title or table structure
    const reportText = tempDiv.textContent || '';
    const hasBarangayTitle = reportText.includes('Barangay Referral Performance') || 
                            reportText.includes('Barangay Performance Summary');
    
    // Check if table has both "Pending" and "In-Progress" headers (characteristic of Barangay Performance report)
    const allThs = Array.from(tempDiv.querySelectorAll('th'));
    const hasPendingHeader = allThs.some(th => th.textContent.trim() === 'Pending');
    const hasInProgressHeader = allThs.some(th => th.textContent.trim() === 'In-Progress' || th.textContent.trim() === 'In Progress');
    
    const isBarangayPerformance = hasBarangayTitle || (hasPendingHeader && hasInProgressHeader);
    
    // Remove pending and in-progress columns from tables (but NOT for Barangay Performance report)
    if (!isBarangayPerformance) {
      const pendingColumns = tempDiv.querySelectorAll('.status-pending, .status-in-progress');
      pendingColumns.forEach(col => {
        col.remove();
      });
      
      // Update colspan in header rows to account for removed columns (2 columns: pending and in-progress)
      const headerRows = tempDiv.querySelectorAll('th[colspan]');
      headerRows.forEach(header => {
        const currentColspan = parseInt(header.getAttribute('colspan')) || 0;
        if (currentColspan > 0) {
          header.setAttribute('colspan', Math.max(1, currentColspan - 2));
        }
      });
    }
    
    // Fix logo URLs to absolute paths
    const allLogos = tempDiv.querySelectorAll('img');
    allLogos.forEach(logo => {
      const srcAttr = logo.getAttribute('src');
      if (srcAttr && srcAttr.startsWith('/')) {
        logo.setAttribute('src', window.location.origin + srcAttr);
      }
    });
    
    // Remove forms and buttons that shouldn't print
    const forms = tempDiv.querySelectorAll('form.d-print-none, form[method="get"]');
    forms.forEach(form => form.remove());
    
    // Remove all form elements (selects, inputs, etc.)
    const formElements = tempDiv.querySelectorAll('select, input, .form-select, .form-control, .form-label');
    formElements.forEach(el => {
      // Only remove if it's not part of the report content (like in tables)
      if (!el.closest('table') && !el.closest('th') && !el.closest('td')) {
        el.remove();
      }
    });
    
    const buttons = tempDiv.querySelectorAll('button, .btn');
    buttons.forEach(btn => {
      // Only remove if it's not part of the report content
      if (!btn.closest('table') && !btn.closest('.card-body')) {
        btn.remove();
      }
    });
    
    // Remove dropdowns and icon inputs
    const selects = tempDiv.querySelectorAll('select');
    selects.forEach(select => {
      if (!select.closest('table')) {
        select.remove();
      }
    });
    
    // Remove icon inputs and icon containers
    const iconInputs = tempDiv.querySelectorAll('.bi, .fa, i[class*="icon"], [class*="icon"]');
    iconInputs.forEach(icon => {
      if (!icon.closest('table') && !icon.closest('th') && !icon.closest('td')) {
        icon.remove();
      }
    });
    
    // Remove empty divs that create blank spaces
    const emptyDivs = tempDiv.querySelectorAll('div:empty');
    emptyDivs.forEach(div => {
      // Only remove if it doesn't have important classes
      if (!div.classList.contains('clearfix') && !div.hasAttribute('role')) {
        div.remove();
      }
    });
    
    // Remove divs with only whitespace
    const allDivs = tempDiv.querySelectorAll('div');
    allDivs.forEach(div => {
      const text = div.textContent || '';
      const hasVisibleContent = div.querySelector('img, table, h1, h2, h3, h4, h5, h6, p, span, small, th, td');
      if (!hasVisibleContent && text.trim() === '' && div.children.length === 0) {
        div.remove();
      }
    });
    
    // Remove all Notes sections (contains bullet points, notes text, etc.)
    // First, find and remove notes sections by looking for bullet points and notes indicators
    const potentialNotesSections = tempDiv.querySelectorAll('div.mt-3, div.mb-3, small.text-muted, small');
    const notesSectionsToRemove = new Set();
    
    potentialNotesSections.forEach(element => {
      const text = element.textContent || '';
      // Check for bullet points or common notes text patterns
      const isNotesSection = text.includes('â€¢') || 
                            text.includes('Status values') || 
                            text.includes('Please coordinate') || 
                            text.includes('Notes:') || 
                            text.includes('Generated on') || 
                            text.includes('reflect') ||
                            text.includes('accreditation') || 
                            text.includes('personnel records') ||
                            text.includes('personnel') ||
                            text.includes('Possible Rabies') ||
                            text.includes('Gastrointestinal Issue') ||
                            text.includes('DOH Form 48') ||
                            text.includes('LBM-related');
      
      if (isNotesSection) {
        // Find the parent container (usually a div with mt-3 or mb-3)
        const parent = element.closest('div');
        if (parent) {
          // Only remove if parent doesn't contain important content like tables
          const hasTable = parent.querySelector('table');
          const hasImportantContent = parent.querySelector('h1, h2, h3, h4, h5, h6, img[alt*="Logo"]');
          if (!hasTable && !hasImportantContent) {
            notesSectionsToRemove.add(parent);
          }
        } else {
          // If no parent div, remove the element itself if it's a small element
          if (element.tagName === 'SMALL' || element.classList.contains('text-muted')) {
            notesSectionsToRemove.add(element);
          }
        }
      }
    });
    
    // Remove all identified notes sections
    notesSectionsToRemove.forEach(element => {
      element.remove();
    });
    
    // Balance table column widths - make all columns equal width
    const tables = tempDiv.querySelectorAll('table');
    tables.forEach(table => {
      // Count the number of columns in the first row
      const firstRow = table.querySelector('thead tr') || table.querySelector('tr');
      if (firstRow) {
        const columnCount = firstRow.querySelectorAll('th, td').length;
        if (columnCount > 0) {
          // Calculate equal width percentage
          const columnWidth = (100 / columnCount) + '%';
          
          // Apply equal width to all columns
          const allCells = table.querySelectorAll('th, td');
          allCells.forEach(cell => {
            cell.style.width = columnWidth;
            cell.style.minWidth = columnWidth;
            cell.style.maxWidth = columnWidth;
          });
        }
      }
    });
    
    // No page break - keep everything on one page
    // Remove any existing page break classes/styles
    const allTables = tempDiv.querySelectorAll('table');
    allTables.forEach(table => {
      table.style.pageBreakBefore = 'auto';
      table.style.breakBefore = 'auto';
      table.classList.remove('second-table-page-break');
      
      const container = table.closest('.table-responsive') || table.parentElement;
      if (container) {
        container.style.pageBreakBefore = 'auto';
        container.style.breakBefore = 'auto';
        container.classList.remove('second-table-page-break');
      }
    });
    
    // Remove any page break wrapper divs
    const pageBreakWrappers = tempDiv.querySelectorAll('.second-table-page-break, .page-break-before');
    pageBreakWrappers.forEach(wrapper => {
      // Unwrap the content
      const parent = wrapper.parentElement;
      if (parent) {
        while (wrapper.firstChild) {
          parent.insertBefore(wrapper.firstChild, wrapper);
        }
        wrapper.remove();
      }
    });
    
    // Add signature lines at the bottom (after the last table) - compact
    const signatureDiv = document.createElement('div');
    signatureDiv.style.marginTop = '15px';
    signatureDiv.style.paddingTop = '10px';
    signatureDiv.style.pageBreakInside = 'avoid';
    signatureDiv.innerHTML = `
      <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; font-size: 9px;">
        <div style="text-align: left;">
          <div style="margin-bottom: 30px;"><strong>Prepared by:</strong> _______________</div>
        </div>
        <div style="text-align: right;">
          <div style="margin-bottom: 30px;"><strong>Approved by:</strong> _______________</div>
        </div>
      </div>
    `;
    
    // Append signatures after the last table
    if (allTables.length > 0) {
      const lastTable = allTables[allTables.length - 1];
      const lastTableContainer = lastTable.closest('.table-responsive') || lastTable.parentElement;
      if (lastTableContainer && lastTableContainer.parentElement) {
        // Insert after the last table container
        lastTableContainer.parentElement.insertBefore(signatureDiv, lastTableContainer.nextSibling);
      } else {
        // Fallback: append to card-body
        const cardBody = tempDiv.querySelector('.card-body');
        if (cardBody) {
          cardBody.appendChild(signatureDiv);
        } else {
          tempDiv.appendChild(signatureDiv);
        }
      }
    } else {
      // If no tables, append to card-body or last element
      const cardBody = tempDiv.querySelector('.card-body');
      if (cardBody) {
        cardBody.appendChild(signatureDiv);
      } else {
        tempDiv.appendChild(signatureDiv);
      }
    }
    
    // Remove any remaining date/timestamp elements before printing
    const datePatterns = tempDiv.querySelectorAll('*');
    datePatterns.forEach(el => {
      const text = el.textContent || '';
      // Check for date patterns like "11/17/25, 12:49 AM Report" or standalone timestamps
      const hasDatePattern = text.match(/\d{1,2}\/\d{1,2}\/\d{2,4}/);
      const hasTimePattern = text.match(/\d{1,2}:\d{2}\s*(AM|PM)/i);
      const hasReportText = text.includes('Report');
      
      // Remove if it contains date/time and "Report" text OR standalone date/time patterns
      if ((hasDatePattern && hasTimePattern && hasReportText) || 
          (hasDatePattern && hasReportText && text.length < 50) ||
          // Also remove standalone date/time patterns (like "11/17/25, 1:00 AM")
          (hasDatePattern && hasTimePattern && text.length < 30 && !el.closest('table'))) {
        // Only remove if it's not part of a table and not the main header
        if (!el.closest('table') && !el.closest('th') && !el.closest('td') && 
            !el.closest('.d-flex.align-items-center')) {
          el.remove();
        }
      }
    });
    
    // Also check for any text nodes at the top level that might contain the timestamp
    const bodyElements = tempDiv.querySelectorAll('body > *, .card-body > *:first-child, .card > *:first-child');
    bodyElements.forEach(el => {
      const text = el.textContent || '';
      // Match any date/time pattern, not just with "Report"
      if (text.match(/\d{1,2}\/\d{1,2}\/\d{2,4}.*\d{1,2}:\d{2}\s*(AM|PM)/i) ||
          (text.match(/\d{1,2}\/\d{1,2}\/\d{2,4}/) && text.match(/\d{1,2}:\d{2}\s*(AM|PM)/i) && text.length < 50)) {
        if (!el.closest('table') && !el.closest('.d-flex.align-items-center')) {
          el.remove();
        }
      }
    });
    
    content = tempDiv.innerHTML;
    
    // Open print window with clean content - use data URL to avoid "about:blank"
    const printWindow = window.open('data:text/html,<html></html>', '_blank');
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title></title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
          @page { 
            size: A4 landscape; 
            margin: 0mm 12mm 12mm 12mm;
            marks: none;
            @top-center { content: ""; }
            @bottom-center { content: ""; }
            @top-left { content: ""; }
            @top-right { content: ""; }
            @bottom-left { content: ""; }
            @bottom-right { content: ""; }
          }
          * {
            box-sizing: border-box;
            font-family: Arial, sans-serif !important;
          }
          body { 
            font-family: Arial, sans-serif; 
            font-size: 12pt;
            margin: 0;
            padding: 0 12mm 12mm;
            color: #000;
            line-height: 1.5;
          }
          .card {
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
          }
          .card-body {
            padding: 6mm 0 0 0 !important;
            margin: 0 !important;
          }
          h1, h2, h3, h4, h5, h6 {
            font-family: Arial, sans-serif !important;
            font-weight: bold;
            color: #000;
            margin: 15px 0 10px 0;
          }
          h1 { font-size: 18pt; }
          h2 { font-size: 16pt; }
          h3 { font-size: 14pt; }
          h4 { font-size: 13pt; }
          h5, h6 { font-size: 12pt; }
          /* Override for header middle section to prevent oversized text */
          .d-flex.align-items-center .text-center div {
            font-size: 11pt !important;
            line-height: 1.3 !important;
            margin-bottom: 2px !important;
          }
          .d-flex.align-items-center .text-center div[style*="font-size: 12pt"] {
            font-size: 12pt !important;
          }
          .d-flex.align-items-center .text-center div[style*="font-size: 9pt"] {
            font-size: 9pt !important;
          }
          p, small, span, div {
            font-family: Arial, sans-serif !important;
            font-size: 12pt;
            line-height: 1.5;
          }
          .d-flex.align-items-center {
            margin-bottom: 15px !important;
            page-break-after: avoid;
            padding: 5px 0 !important;
            gap: 15px !important;
          }
          /* Tight spacing for header text */
          .d-flex.align-items-center .text-center div[style*="margin-bottom"] {
            margin-bottom: 1px !important;
            line-height: 1.2 !important;
          }
          .d-flex.align-items-center .text-center > div {
            margin-bottom: 1px !important;
            line-height: 1.2 !important;
          }
          .report-logo,
          img[alt*="Logo"],
          img[src*="LGU"],
          img[src*="MHO"] {
            width: 95px !important;
            height: 95px !important;
            max-width: 95px !important;
            max-height: 95px !important;
            object-fit: contain;
            margin: 0 10px !important;
            padding: 0 !important;
            display: block !important;
          }
          .d-flex.align-items-center > div {
            margin: 0 !important;
            padding: 0 !important;
          }
          .text-center.flex-grow-1 {
            padding: 0 15px !important;
            margin: 0 !important;
          }
          .table-responsive {
            page-break-inside: avoid;
            margin: 15px 0;
            overflow: visible !important;
            width: 100% !important;
          }
          table {
            width: 100% !important;
            max-width: 100% !important;
            border-collapse: collapse !important;
            page-break-inside: avoid !important;
            margin: 15px 0;
            font-size: 12pt !important;
            font-family: Arial, sans-serif !important;
          }
          thead {
            display: table-header-group !important;
            page-break-after: avoid;
          }
          tbody {
            display: table-row-group !important;
          }
          tr {
            page-break-inside: avoid;
            page-break-after: auto;
          }
          th, td {
            border: 1px solid #000 !important;
            padding: 8px 10px !important;
            font-size: 12pt !important;
            font-family: Arial, sans-serif !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            vertical-align: top !important;
            box-sizing: border-box !important;
            line-height: 1.4 !important;
          }
          th {
            background-color: #f5f5f5 !important;
            font-weight: bold !important;
            text-align: center !important;
          }
          td {
            text-align: left !important;
          }
          table th:nth-child(2),
          table td:nth-child(2) {
            text-align: left !important;
            padding-left: 10px !important;
          }
          .d-print-none {
            display: none !important;
          }
          .d-none.d-print-block {
            display: none !important;
          }
          /* Hide pending and in-progress columns when printing (but NOT for Barangay Performance report) */
          /* Note: Barangay Performance report needs these columns visible, so we handle it in JavaScript */
          /* This CSS rule is kept for other reports but will be overridden for Barangay Performance */
          /* Hide elements with date/timestamp classes */
          [class*="date"],
          [class*="timestamp"],
          [class*="time"] {
            display: none !important;
          }
          form,
          .btn,
          .row.g-3 {
            display: none !important;
          }
          .container-fluid {
            padding: 0 !important;
            margin: 0 !important;
          }
          div:empty {
            display: none !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
          }
          .card-body > * {
            margin-top: 10px !important;
            margin-bottom: 10px !important;
          }
          .card-body > .d-flex:first-child {
            margin-top: 0 !important;
            margin-bottom: 15px !important;
          }
          .card-body > .table-responsive {
            margin-top: 15px !important;
            margin-bottom: 15px !important;
          }
          div[style*="margin-top: 15px"],
          div[style*="margin-top: 40px"] {
            margin-top: 20px !important;
            padding-top: 15px !important;
            page-break-inside: avoid;
            font-size: 12pt !important;
          }
          div[style*="display: flex"] {
            display: flex !important;
            justify-content: space-between !important;
            width: 100% !important;
            font-size: 12pt !important;
          }
          @media print {
            @page {
              size: A4 landscape;
              margin: 0mm 12mm 12mm 12mm;
              /* Suppress browser headers and footers */
              marks: none;
            }
            /* Explicitly suppress all browser headers and footers */
            @top-left { content: "" !important; }
            @top-center { content: "" !important; }
            @top-right { content: "" !important; }
            @bottom-left { content: "" !important; }
            @bottom-center { content: "" !important; }
            @bottom-right { content: "" !important; }
            body {
              margin: 0;
              padding: 0 12mm 12mm;
            }
            table {
              page-break-inside: avoid !important;
            }
            tr {
              page-break-inside: avoid !important;
            }
          }
        </style>
      </head>
      <body>
        ${content}
      </body>
      </html>
    `);
    printWindow.document.close();
    
    // Wait for content to load, then print
    printWindow.onload = function() {
      // Remove any timestamp elements that might have been added
      setTimeout(function() {
        // Check if this is a Barangay Performance report
        const reportText = printWindow.document.body.textContent || '';
        const hasBarangayTitle = reportText.includes('Barangay Referral Performance') || 
                                reportText.includes('Barangay Performance Summary');
        
        const allThs = Array.from(printWindow.document.querySelectorAll('th'));
        const hasPendingHeader = allThs.some(th => th.textContent.trim() === 'Pending');
        const hasInProgressHeader = allThs.some(th => th.textContent.trim() === 'In-Progress' || th.textContent.trim() === 'In Progress');
        
        const isBarangayPerformance = hasBarangayTitle || (hasPendingHeader && hasInProgressHeader);
        
        // Remove pending and in-progress columns from tables (but NOT for Barangay Performance report)
        if (!isBarangayPerformance) {
          const pendingColumns = printWindow.document.querySelectorAll('.status-pending, .status-in-progress');
          pendingColumns.forEach(col => {
            col.style.display = 'none';
            col.remove();
          });
          
          // Update colspan in header rows to account for removed columns (2 columns: pending and in-progress)
          const headerRows = printWindow.document.querySelectorAll('th[colspan]');
          headerRows.forEach(header => {
            const currentColspan = parseInt(header.getAttribute('colspan')) || 0;
            if (currentColspan > 0) {
              header.setAttribute('colspan', Math.max(1, currentColspan - 2));
            }
          });
        }
        
        const allElements = printWindow.document.querySelectorAll('*');
        allElements.forEach(el => {
          const text = el.textContent || '';
          // Remove standalone date/time patterns
          if (text.match(/\d{1,2}\/\d{1,2}\/\d{2,4}.*\d{1,2}:\d{2}\s*(AM|PM)/i) && 
              text.length < 50 && 
              !el.closest('table') && 
              !el.closest('.d-flex.align-items-center')) {
            el.style.display = 'none';
            el.remove();
          }
        });
        
        // Trigger print
        printWindow.print();
        // Close window after printing (optional)
        // setTimeout(() => printWindow.close(), 100);
      }, 250);
    };
  }

  function closeReportPreview() {
    const previewContainer = document.getElementById('reportPreviewContainer');
    const reportContent = document.getElementById('reportContent');
    const loadingIndicator = document.getElementById('reportLoadingIndicator');
    
    previewContainer.style.display = 'none';
    reportContent.style.display = 'none';
    reportContent.innerHTML = '';
    loadingIndicator.style.display = 'none';
  }

  // Clear error states when user interacts with fields and handle date range validation
  document.addEventListener('DOMContentLoaded', function() {
    const printStartDateInput = document.getElementById('printStartDate');
    const printEndDateInput = document.getElementById('printEndDate');
    const statStartDateInput = document.getElementById('statStartDate');
    const statEndDateInput = document.getElementById('statEndDate');
    
    function clearFieldError(field) {
      field.classList.remove('is-invalid');
      const errorMsg = field.parentElement.querySelector('.invalid-feedback');
      if (errorMsg) {
        errorMsg.remove();
      }
    }
    
    // Function to update date constraints for print dates
    function updatePrintDateConstraints() {
      if (printStartDateInput && printEndDateInput) {
        // Set minimum date for end date based on start date
        if (printStartDateInput.value) {
          printEndDateInput.setAttribute('min', printStartDateInput.value);
          // If end date is before start date, clear it
          if (printEndDateInput.value && printEndDateInput.value < printStartDateInput.value) {
            printEndDateInput.value = '';
          }
        } else {
          // Remove min constraint if start date is cleared
          printEndDateInput.removeAttribute('min');
        }
        
        // Set maximum date for start date based on end date
        if (printEndDateInput.value) {
          printStartDateInput.setAttribute('max', printEndDateInput.value);
          // If start date is after end date, clear it
          if (printStartDateInput.value && printStartDateInput.value > printEndDateInput.value) {
            printStartDateInput.value = '';
          }
        } else {
          // Remove max constraint if end date is cleared
          printStartDateInput.removeAttribute('max');
        }
      }
    }
    
    // Function to update date constraints for stat dates
    function updateStatDateConstraints() {
      if (statStartDateInput && statEndDateInput) {
        // Set minimum date for end date based on start date
        if (statStartDateInput.value) {
          statEndDateInput.setAttribute('min', statStartDateInput.value);
          // If end date is before start date, clear it
          if (statEndDateInput.value && statEndDateInput.value < statStartDateInput.value) {
            statEndDateInput.value = '';
          }
        } else {
          // Remove min constraint if start date is cleared
          statEndDateInput.removeAttribute('min');
        }
        
        // Set maximum date for start date based on end date
        if (statEndDateInput.value) {
          statStartDateInput.setAttribute('max', statEndDateInput.value);
          // If start date is after end date, clear it
          if (statStartDateInput.value && statStartDateInput.value > statEndDateInput.value) {
            statStartDateInput.value = '';
          }
        } else {
          // Remove max constraint if end date is cleared
          statStartDateInput.removeAttribute('max');
        }
      }
    }
    
    // Print date inputs
    if (printStartDateInput) {
      printStartDateInput.addEventListener('change', function() {
        clearFieldError(printStartDateInput);
        updatePrintDateConstraints();
      });
      printStartDateInput.addEventListener('input', function() {
        clearFieldError(printStartDateInput);
        updatePrintDateConstraints();
      });
    }
    
    if (printEndDateInput) {
      printEndDateInput.addEventListener('change', function() {
        clearFieldError(printEndDateInput);
        updatePrintDateConstraints();
      });
      printEndDateInput.addEventListener('input', function() {
        clearFieldError(printEndDateInput);
        updatePrintDateConstraints();
      });
    }
    
    // Stat date inputs
    if (statStartDateInput) {
      statStartDateInput.addEventListener('change', function() {
        clearFieldError(statStartDateInput);
        updateStatDateConstraints();
      });
      statStartDateInput.addEventListener('input', function() {
        clearFieldError(statStartDateInput);
        updateStatDateConstraints();
      });
    }
    
    if (statEndDateInput) {
      statEndDateInput.addEventListener('change', function() {
        clearFieldError(statEndDateInput);
        updateStatDateConstraints();
      });
      statEndDateInput.addEventListener('input', function() {
        clearFieldError(statEndDateInput);
        updateStatDateConstraints();
      });
    }
    
    // Initialize constraints on page load
    updatePrintDateConstraints();
    updateStatDateConstraints();
  });
</script>

{% endblock script %}

{% endblock %}
