{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}" />

<!-- Flatpickr CSS for custom date picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
  #reportPreviewContainer {
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  #reportContent {
    padding: 1rem;
  }
  
  #reportContent .container-fluid {
    padding: 0;
  }
  
  #reportContent img {
    max-width: 100%;
    height: auto;
  }
  
  /* Constrain logo size in preview */
  #reportContent .report-logo {
    width: 95px !important;
    height: 95px !important;
    max-width: 95px !important;
    max-height: 95px !important;
    object-fit: contain;
  }
  
  #reportContent table {
    width: 100%;
  }
  
  /* Preserve original styling */
  #reportContent * {
    box-sizing: border-box;
  }
  
  /* Ensure notes section with timestamp is visible in preview */
  #reportContent .mt-3,
  #reportContent small.text-muted {
    display: block !important;
    visibility: visible !important;
  }
  
  /* Ensure the notes section is not cut off */
  #reportContent .card-body {
    padding-bottom: 2rem !important;
  }
  
  /* Print styles - simplified since we use a separate print window */
  @media print {
    /* Hide navigation and other page elements if printing from main page */
    nav,
    .navbar,
    header,
    [role="navigation"],
    .d-print-none {
      display: none !important;
    }
    
    /* Hide preview container header buttons when printing */
    #reportPreviewContainer .card-header {
      display: none !important;
    }
  }
  
  /* Custom Flatpickr Date Picker Styles - Black and White */
  .flatpickr-calendar {
    font-family: 'Roboto', sans-serif;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: 1px solid #000;
    background-color: #fff;
  }
  
  .flatpickr-months {
    background-color: #000;
    border-radius: 8px 8px 0 0;
    padding: 10px;
  }
  
  .flatpickr-month {
    color: #fff;
  }
  
  .flatpickr-current-month {
    color: #fff;
    font-weight: 600;
  }
  
  .flatpickr-prev-month,
  .flatpickr-next-month {
    color: #fff;
    fill: #fff;
    padding: 5px;
    border-radius: 4px;
    transition: background-color 0.2s;
  }
  
  .flatpickr-prev-month:hover,
  .flatpickr-next-month:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }
  
  .flatpickr-weekdays {
    background-color: #f8f9fa;
    border-bottom: 1px solid #000;
  }
  
  .flatpickr-weekday {
    color: #000;
    font-weight: 600;
    font-size: 0.85rem;
  }
  
  .flatpickr-day {
    border-radius: 6px;
    margin: 2px;
    transition: all 0.2s;
    color: #000;
  }
  
  .flatpickr-day:hover {
    background-color: #e9ecef;
    border-color: #000;
  }
  
  .flatpickr-day.selected,
  .flatpickr-day.startRange,
  .flatpickr-day.endRange {
    background-color: #000;
    border-color: #000;
    color: #fff;
    font-weight: 600;
  }
  
  .flatpickr-day.inRange {
    background-color: #e9ecef;
    border-color: #000;
    color: #000;
  }
  
  .flatpickr-day.today {
    border-color: #000;
    border-width: 2px;
    font-weight: 600;
  }
  
  .flatpickr-day.today:hover {
    background-color: #000;
    color: #fff;
  }
  
  .flatpickr-day.flatpickr-disabled,
  .flatpickr-day.prevMonthDay,
  .flatpickr-day.nextMonthDay {
    color: #999;
    opacity: 0.5;
  }
  
  .flatpickr-time {
    border-top: 1px solid #000;
    padding: 10px;
    background-color: #fff;
  }
  
  .flatpickr-time input {
    border-radius: 4px;
    border: 1px solid #000;
    color: #000;
  }
  
  .flatpickr-time input:hover {
    background-color: #f8f9fa;
  }
  
  /* Month and Year Dropdown Styles - Black and White */
  .flatpickr-monthDropdown-months,
  .flatpickr-yearDropdown {
    background-color: #fff;
    border: 1px solid #000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .flatpickr-monthDropdown-month,
  .flatpickr-yearDropdown-year {
    color: #000;
    background-color: #fff;
  }
  
  .flatpickr-monthDropdown-month:hover,
  .flatpickr-yearDropdown-year:hover {
    background-color: #e9ecef;
    color: #000;
  }
  
  .flatpickr-monthDropdown-month.selected,
  .flatpickr-yearDropdown-year.selected {
    background-color: #000 !important;
    color: #fff !important;
  }
  
  .flatpickr-monthDropdown-month.flatpickr-disabled,
  .flatpickr-yearDropdown-year.flatpickr-disabled {
    color: #999;
    opacity: 0.5;
  }
  
  /* Custom input styling */
  .custom-date-input {
    cursor: pointer;
    background-color: white;
    color: #000;
  }
  
  .custom-date-input:focus {
    border-color: #000;
    box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25);
  }
  
  .input-group .btn:hover {
    background-color: #333 !important;
    border-color: #333 !important;
  }
  
  .input-group .btn:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25);
  }
</style>

<!-- Navbar Include -->
{% include 'components/navbar.html' %}

<div class="container-fluid py-4">
  

  <!-- Tab Navigation -->
  {% include 'components/tabbar/tabbar.html' with tab5_name="Generate Reports" tab5_icon="bi-printer" active_tab="tab5" tab1_count=0 show_pending_fallback=False %}

  <!-- Tab Content -->
  <div class="tab-content" id="dashboardTabContent">
    <!-- Tab 1: Referral Statistics -->
    {% comment %}
    <div class="tab-pane fade" id="tab1" role="tabpanel">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="row align-items-center mb-4">
            <div class="col-md-6">
              <select id="reportViewFilter" class="w-50" style="display: block; width: 100%; padding: 0.375rem 2.25rem 0.375rem 0.75rem; font-size: 1rem; font-weight: 400; line-height: 1.5; color: #212529; background-color: #fff; background-image: url('data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 16 16%27%3e%3cpath fill=%27none%27 stroke=%27%23343a40%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%272%27 d=%27m2 5 6 6 6-6%27/%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 16px 12px; border: 1px solid #ced4da; border-radius: 0.375rem; transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; -webkit-appearance: none; -moz-appearance: none; appearance: none;">
                <option value="monthly" selected>Monthly View</option>
                <option value="yearly">Yearly View</option>
              </select>
            </div>
          </div>
          <h5 class="card-title mb-4">Monthly Referral Analytics</h5>
          <canvas id="monthlyReportChart" height="100"></canvas>
        </div>
      </div>
    </div>
    {% endcomment %}

    <!-- Tab 2: Common Diagnoses -->
    {% comment %}
    <div class="tab-pane fade" id="tab2" role="tabpanel">
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
              <h5 class="card-title mb-4">Top Diagnosed Cases</h5>
              <div style="height: 300px;">
                <canvas id="topDiagnosedChart" style="max-height: 100%; width: 100%;"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
              <h5 class="card-title mb-4">Diagnosis Trends</h5>
              <div style="height: 300px;">
                <canvas id="topTrendsDiagnosed" style="max-height: 100%; width: 100%;"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endcomment %}

    <!-- Tab 3: Barangay Performance -->
    {% comment %}
    <div class="tab-pane fade" id="tab3" role="tabpanel">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <h5 class="card-title mb-4">Barangay Performance Analytics</h5>
          
          <div class="row mb-4">
            <div class="col-md-6 mb-4">
              <h6 class="text-muted mb-3">Referral Status Overview</h6>
              <canvas id="stackedBarangayChart" height="200"></canvas>
            </div>
            <div class="col-md-6 mb-4">
              <h6 class="text-muted mb-3">Completion Rate Analysis</h6>
              <canvas id="groupedBarangayChart" height="200"></canvas>
            </div>
          </div>
    
        </div>
      </div>
    </div>
    {% endcomment %}

    <!-- Tab 5: Reports -->
    <div class="tab-pane fade show active" id="tab5" role="tabpanel">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          {% if request.user.is_superuser and not is_doctor %}
          <h5 class="fw-bold mb-4">Export Referral Reports (CSV)</h5>
          
          <form id="exportCsvForm" method="get" action="{% url 'referrals:export_referrals_csv' %}">
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label for="exportFacility" class="form-label small mb-1">Facility</label>
                <select class="form-select" id="exportFacility" name="facility_id">
                  <option value="">All Facilities</option>
                  {% for facility in facilities %}
                    <option value="{{ facility.facility_id }}">{{ facility.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label for="exportStartDate" class="form-label small mb-1">START DATE</label>
                <div class="input-group">
                  <input type="text" class="form-control custom-date-input" id="exportStartDate" name="date_from" placeholder="Select start date" readonly>
                  <button type="button" class="btn" style="background-color: #000; color: white; border: 1px solid #000;" id="exportStartDateBtn">
                    <i class="bi bi-calendar3"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-3">
                <label for="exportEndDate" class="form-label small mb-1">END DATE</label>
                <div class="input-group">
                  <input type="text" class="form-control custom-date-input" id="exportEndDate" name="date_to" placeholder="Select end date" readonly>
                  <button type="button" class="btn" style="background-color: #000; color: white; border: 1px solid #000;" id="exportEndDateBtn">
                    <i class="bi bi-calendar3"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label small mb-1 d-block">&nbsp;</label>
                <button type="submit" class="btn btn-outline-primary w-100">
                  <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export CSV
                </button>
              </div>
            </div>
          </form>
          {% endif %}

          <!-- Printable Reports Section -->
          <div class="{% if request.user.is_superuser and not is_doctor %}mt-5{% endif %}">
            <h5 class="fw-bold mb-4">Generate Printable Reports</h5>
            
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label for="printReportSelect" class="form-label small mb-1">Report Type</label>
                <select class="form-select" id="printReportSelect">
                  <option value="">-- Choose a report --</option>
                  <option value="{% url 'barangay_referral_performance_report' %}">
                    Barangay Referral Performance Summary
                  </option>
                  <option value="{% url 'morbidity_report' %}">
                    Top-Diagnosis
                  </option>
                  <option value="{% url 'facility_workforce_masterlist' %}">
                    Facility & Workforce Masterlist
                  </option>
                  <option value="{% url 'referral_registry_report' %}">
                    Referral Registry with Vital Signs
                  </option>
                  <option value="{% url 'system_usage_scorecard_report' %}">
                    System Usage & Adoption Scorecard
                  </option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="printStartDate" class="form-label small mb-1">START DATE</label>
                <div class="input-group">
                  <input type="text" class="form-control custom-date-input" id="printStartDate" name="start_date" placeholder="Select start date" readonly>
                  <button type="button" class="btn" style="background-color: #000; color: white; border: 1px solid #000;" id="printStartDateBtn">
                    <i class="bi bi-calendar3"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-3">
                <label for="printEndDate" class="form-label small mb-1">END DATE</label>
                <div class="input-group">
                  <input type="text" class="form-control custom-date-input" id="printEndDate" name="end_date" placeholder="Select end date" readonly>
                  <button type="button" class="btn" style="background-color: #000; color: white; border: 1px solid #000;" id="printEndDateBtn">
                    <i class="bi bi-calendar3"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label small mb-1 d-block">&nbsp;</label>
                <button type="button" class="btn btn-outline-primary w-100" onclick="generatePrintableReport()">
                  <i class="bi bi-printer me-2"></i>Preview
                </button>
              </div>
            </div>
            
            <!-- Report Preview Container -->
            <div id="reportPreviewContainer" class="mt-4" style="display: none;">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                  <h6 class="mb-0 fw-bold" id="reportPreviewTitle">
                    <i class="bi bi-file-earmark-text me-2"></i>Report Preview
                  </h6>
                  <div>
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="printReportContent()">
                      <i class="bi bi-printer me-1"></i>Print
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closeReportPreview()">
                      <i class="bi bi-x-lg"></i> Close
                    </button>
                  </div>
                </div>
                <div class="card-body p-0 position-relative" style="max-height: 800px; overflow-y: auto;">
                  <div id="reportLoadingIndicator" class="text-center p-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading report...</p>
                  </div>
                  <div id="reportContent" style="display: none;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

{% block script %}
<!-- Flatpickr JS for custom date picker -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

{% comment %}
<script src="{% static 'js/user/line_chart_user.js' %}"></script>
<script src="{% static 'js/user/topDiagnosedPie_chart_user.js' %}"></script>
<script src="{% static 'js/user/barangay_performance_user.js' %}"></script>
{% endcomment %}

<script>
  // Initialize Flatpickr for custom date pickers
  document.addEventListener('DOMContentLoaded', function() {
    const printStartDateInput = document.getElementById('printStartDate');
    const printEndDateInput = document.getElementById('printEndDate');
    const printStartDateBtn = document.getElementById('printStartDateBtn');
    const printEndDateBtn = document.getElementById('printEndDateBtn');
    
    const exportStartDateInput = document.getElementById('exportStartDate');
    const exportEndDateInput = document.getElementById('exportEndDate');
    const exportStartDateBtn = document.getElementById('exportStartDateBtn');
    const exportEndDateBtn = document.getElementById('exportEndDateBtn');
    
    // Update print date constraints dynamically
    function updatePrintDateConstraints() {
      if (printStartDatePicker && printEndDatePicker) {
        const startDate = printStartDatePicker.selectedDates[0];
        const endDate = printEndDatePicker.selectedDates[0];
        
        if (startDate) {
          printEndDatePicker.set('minDate', startDate);
        } else {
          printEndDatePicker.set('minDate', null);
        }
        
        if (endDate) {
          printStartDatePicker.set('maxDate', endDate);
        } else {
          printStartDatePicker.set('maxDate', null);
        }
      }
    }
    
    // Update export date constraints dynamically
    function updateExportDateConstraints() {
      if (exportStartDatePicker && exportEndDatePicker) {
        const startDate = exportStartDatePicker.selectedDates[0];
        const endDate = exportEndDatePicker.selectedDates[0];
        
        if (startDate) {
          exportEndDatePicker.set('minDate', startDate);
        } else {
          exportEndDatePicker.set('minDate', null);
        }
        
        if (endDate) {
          exportStartDatePicker.set('maxDate', endDate);
        } else {
          exportStartDatePicker.set('maxDate', null);
        }
      }
    }
    
    // Initialize Flatpickr for PRINT START DATE
    let printStartDatePicker = null;
    if (printStartDateInput) {
      printStartDatePicker = flatpickr(printStartDateInput, {
        dateFormat: "Y-m-d",
        altInput: false,
        allowInput: false,
        clickOpens: true,
        theme: "default",
        onChange: function(selectedDates, dateStr, instance) {
          printStartDateInput.value = dateStr;
          updatePrintDateConstraints();
          printStartDateInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      
      if (printStartDateBtn) {
        printStartDateBtn.addEventListener('click', function() {
          printStartDatePicker.open();
        });
      }
    }
    
    // Initialize Flatpickr for PRINT END DATE
    let printEndDatePicker = null;
    if (printEndDateInput) {
      printEndDatePicker = flatpickr(printEndDateInput, {
        dateFormat: "Y-m-d",
        altInput: false,
        allowInput: false,
        clickOpens: true,
        theme: "default",
        onChange: function(selectedDates, dateStr, instance) {
          printEndDateInput.value = dateStr;
          updatePrintDateConstraints();
          printEndDateInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      
      if (printEndDateBtn) {
        printEndDateBtn.addEventListener('click', function() {
          printEndDatePicker.open();
        });
      }
    }
    
    // Initialize print constraints
    updatePrintDateConstraints();
    
    // Initialize Flatpickr for CSV EXPORT START DATE
    let exportStartDatePicker = null;
    if (exportStartDateInput) {
      exportStartDatePicker = flatpickr(exportStartDateInput, {
        dateFormat: "Y-m-d",
        altInput: false,
        allowInput: false,
        clickOpens: true,
        theme: "default",
        onChange: function(selectedDates, dateStr, instance) {
          exportStartDateInput.value = dateStr;
          updateExportDateConstraints();
          exportStartDateInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      
      if (exportStartDateBtn) {
        exportStartDateBtn.addEventListener('click', function() {
          exportStartDatePicker.open();
        });
      }
    }
    
    // Initialize Flatpickr for CSV EXPORT END DATE
    let exportEndDatePicker = null;
    if (exportEndDateInput) {
      exportEndDatePicker = flatpickr(exportEndDateInput, {
        dateFormat: "Y-m-d",
        altInput: false,
        allowInput: false,
        clickOpens: true,
        theme: "default",
        onChange: function(selectedDates, dateStr, instance) {
          exportEndDateInput.value = dateStr;
          updateExportDateConstraints();
          exportEndDateInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      
      if (exportEndDateBtn) {
        exportEndDateBtn.addEventListener('click', function() {
          exportEndDatePicker.open();
        });
      }
    }
    
    // Initialize export constraints
    updateExportDateConstraints();
    
    // Add form validation for CSV export
    const exportCsvForm = document.getElementById('exportCsvForm');
    if (exportCsvForm) {
      exportCsvForm.addEventListener('submit', function(e) {
        // Validate date range if both dates are provided
        if (exportStartDateInput && exportEndDateInput && 
            exportStartDateInput.value && exportEndDateInput.value) {
          const startDate = new Date(exportStartDateInput.value);
          const endDate = new Date(exportEndDateInput.value);
          
          if (startDate > endDate) {
            e.preventDefault();
            exportStartDateInput.classList.add('is-invalid');
            exportEndDateInput.classList.add('is-invalid');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.textContent = 'START DATE cannot be greater than END DATE.';
            exportEndDateInput.parentElement.appendChild(errorDiv);
            exportEndDateInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
          }
        }
      });
    }
  });

  function generatePrintableReport() {
    const reportSelect = document.getElementById('printReportSelect');
    const startDateInput = document.getElementById('printStartDate');
    const endDateInput = document.getElementById('printEndDate');
    const previewContainer = document.getElementById('reportPreviewContainer');
    const reportContent = document.getElementById('reportContent');
    const loadingIndicator = document.getElementById('reportLoadingIndicator');
    
    // Reset previous error states
    if (startDateInput) startDateInput.classList.remove('is-invalid');
    if (endDateInput) endDateInput.classList.remove('is-invalid');
    
    // Remove any existing error messages
    const existingErrors = document.querySelectorAll('.invalid-feedback');
    existingErrors.forEach(error => error.remove());
    
    if (!reportSelect.value) {
      alert('Please select a report type.');
      return;
    }
    
    // Validate that both dates are required
    let hasErrors = false;
    
    if (!startDateInput.value || startDateInput.value.trim() === '') {
      startDateInput.classList.add('is-invalid');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'invalid-feedback';
      errorDiv.textContent = 'START DATE is required.';
      startDateInput.parentElement.appendChild(errorDiv);
      hasErrors = true;
    }
    
    if (!endDateInput.value || endDateInput.value.trim() === '') {
      endDateInput.classList.add('is-invalid');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'invalid-feedback';
      errorDiv.textContent = 'END DATE is required.';
      endDateInput.parentElement.appendChild(errorDiv);
      hasErrors = true;
    }
    
    // If there are validation errors, stop here
    if (hasErrors) {
      // Scroll to first error field
      const firstError = document.querySelector('.is-invalid');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstError.focus();
      }
      return;
    }
    
    // Validate date range
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    
    if (startDate > endDate) {
      startDateInput.classList.add('is-invalid');
      endDateInput.classList.add('is-invalid');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'invalid-feedback';
      errorDiv.textContent = 'START DATE cannot be greater than END DATE.';
      endDateInput.parentElement.appendChild(errorDiv);
      endDateInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }
    
    // Build URL with query parameters
    let url = reportSelect.value;
    const params = new URLSearchParams();
    
    if (startDateInput.value && endDateInput.value) {
      const startDate = new Date(startDateInput.value);
      const endDate = new Date(endDateInput.value);
      
      // Extract year and month from dates for backward compatibility with report views
      const startYear = startDate.getFullYear();
      const startMonth = startDate.getMonth() + 1;
      const endYear = endDate.getFullYear();
      const endMonth = endDate.getMonth() + 1;
      
      // Add year (use start year, or end year if different)
      params.append('year', startYear);
      
      // If same year and month, use single month
      if (startYear === endYear && startMonth === endMonth) {
        params.append('month', startMonth);
      } else {
        // Use month range
        params.append('month_from', startMonth);
        params.append('month_to', endMonth);
        // If different years, we need to handle this - for now use the range
        if (startYear !== endYear) {
          params.set('year', startYear);
          // Note: This might need adjustment based on how reports handle cross-year ranges
        }
      }
      
      // Also add date_from and date_to for reports that support direct date filtering
      params.append('date_from', startDateInput.value);
      params.append('date_to', endDateInput.value);
    }
    
    // Append query string if there are any parameters
    if (params.toString()) {
      url += '?' + params.toString();
    }
    
    // Show loading indicator
    loadingIndicator.style.display = 'block';
    reportContent.style.display = 'none';
    reportContent.innerHTML = '';
    previewContainer.style.display = 'block';
    
    // Fetch the HTML content
    console.log('Fetching report from:', url);
    fetch(url, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
      credentials: 'same-origin'
    })
    .then(response => {
      console.log('Response status:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.text();
    })
    .then(html => {
      console.log('HTML received, length:', html.length);
      // Extract the main content from the response
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Remove navbar and header elements first
      const navbars = doc.querySelectorAll('nav, .navbar, header, [role="navigation"]');
      navbars.forEach(el => el.remove());
      
      // Find the container-fluid that contains the report
      const containerFluid = doc.querySelector('.container-fluid');
      
      if (!containerFluid) {
        throw new Error('Could not find report container');
      }
      
      // Find the card inside container-fluid (this is the actual report)
      const reportCard = containerFluid.querySelector('.card.border-0.shadow-sm, .card');
      
      if (!reportCard) {
        throw new Error('Could not find report card');
      }
      
      // Clone the report card to preserve original structure
      const clonedCard = reportCard.cloneNode(true);
      
      // Remove notes section from print output
      const notesSections = clonedCard.querySelectorAll('.notes-list, .mt-3.notes-list, .print-notes, .mt-3 small');
      notesSections.forEach(notes => {
        // Check if it's a notes section (contains "Notes:" or "Generated on" text)
        const notesText = notes.textContent || '';
        if (notesText.includes('Notes:') || notesText.includes('Generated on') || notesText.includes('Counts reflect') || notesText.includes('Possible Rabies') || notesText.includes('Gastrointestinal Issue')) {
          notes.remove();
        }
      });
      
      // Remove filter forms and buttons (but preserve header with logos and title)
      const forms = clonedCard.querySelectorAll('form.d-print-none, form[method="get"]');
      forms.forEach(form => {
        // Only remove if it's a filter form, not part of the header
        if (!form.closest('.d-flex.align-items-center')) {
          form.remove();
        }
      });
      
      // Remove back buttons and navigation links
      const backButtons = clonedCard.querySelectorAll('a[href*="report_analytics"], .btn-outline-secondary');
      backButtons.forEach(btn => {
        // Only remove if it's clearly a back button, not part of report content
        if (btn.textContent.includes('Back') || btn.closest('.mb-3')) {
          btn.closest('.mb-3')?.remove() || btn.remove();
        }
      });
      
      // Remove print buttons (but keep the report structure and header)
      const printButtons = clonedCard.querySelectorAll('button[onclick*="print"], button[onclick*="Print"]');
      printButtons.forEach(btn => {
        // Check if this button is part of the header section (which has logos)
        const flexParent = btn.closest('.d-flex');
        if (flexParent) {
          // Check if this flex container has logos - if so, it's the header, don't remove
          const hasLogos = flexParent.querySelector('.report-logo, img[alt*="Logo"]');
          if (hasLogos) {
            return; // Skip - this is in the header section, don't remove
          }
        }
        
        // IMPORTANT: Don't remove if it's near the notes section (which contains timestamp)
        const notesSection = btn.closest('.mt-3, [class*="notes"]');
        if (notesSection) {
          return; // Skip - don't remove buttons near notes section
        }
        
        // Remove the button and its parent row/container if it's a print button
        const parent = btn.closest('.row, .d-grid');
        if (parent && parent.querySelector('button[onclick*="print"]')) {
          // Double-check: don't remove if parent contains notes section
          if (!parent.querySelector('.mt-3, [class*="notes"], small.text-muted')) {
            parent.remove();
          }
        } else if (flexParent && !flexParent.querySelector('.report-logo, img[alt*="Logo"]')) {
          // Only remove d-flex parent if it doesn't contain logos (not the header)
          if (flexParent.querySelector('button[onclick*="print"]')) {
            // Double-check: don't remove if parent contains notes section
            if (!flexParent.querySelector('.mt-3, [class*="notes"], small.text-muted')) {
              flexParent.remove();
            }
          }
        }
      });
      
      // Verify header section exists before replacing middle section
      const headerCheck = clonedCard.querySelector('.d-flex.align-items-center');
      if (!headerCheck) {
        console.warn('Header section not found in cloned card');
      }
      
      // Check if this is a Barangay Performance report
      const isBarangayPerformance = url.includes('barangay-referral-performance');

      // Determine the extended report title
      const reportTitleMap = [
        { keys: ['barangay-referral-performance'], title: 'Barangay Performance Summary' },
        { keys: ['morbidity'], title: 'TOP DIAGNOSIS REPORT' },
        { keys: ['facility_workforce_masterlist', 'facility-workforce'], title: 'FACILITY & WORKFORCE MASTERLIST' },
        { keys: ['referral_registry_report', 'referral-registry'], title: 'REFERRAL REGISTRY WITH VITAL SIGNS' },
        { keys: ['system_usage_scorecard', 'system-usage-scorecard'], title: 'SYSTEM USAGE & ADOPTION SCORECARD' },
      ];

      let reportTitle = 'Report Preview';
      const selectedUrl = reportSelect.value || '';
      for (const entry of reportTitleMap) {
        const keys = entry.keys || [entry.key];
        if (keys.some(key => selectedUrl.includes(key))) {
          reportTitle = entry.title;
          break;
        }
      }

      const previewTitleEl = document.getElementById('reportPreviewTitle');
      if (previewTitleEl) {
        previewTitleEl.innerHTML = `<i class="bi bi-file-earmark-text me-2"></i>${reportTitle}`;
      }
      
      // Format date for display (e.g., "November 01, 2025")
      function formatDateForDisplay(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
        const month = months[date.getMonth()];
        const day = String(date.getDate()).padStart(2, '0');
        const year = date.getFullYear();
        return `${month} ${day}, ${year}`;
      }
      
      // Get reporting period date range
      let reportingPeriodHtml = '';
      if (!isBarangayPerformance && startDateInput.value && endDateInput.value) {
        const startDateFormatted = formatDateForDisplay(startDateInput.value);
        const endDateFormatted = formatDateForDisplay(endDateInput.value);
        reportingPeriodHtml = `<div style="font-size: 10pt; color: #333; margin-top: 4px; font-weight: 500;">Reporting Period: ${startDateFormatted} to ${endDateFormatted}</div>`;
      }
      
      // Replace the middle section with official address information
      const middleSection = clonedCard.querySelector('.text-center.flex-grow-1.px-lg-4, .text-center');
      if (middleSection) {
        middleSection.innerHTML = `
          <div style="font-size: 11pt; line-height: 1.3;">
            <div style="font-weight: bold; margin-bottom: 2px;">Republic of the Philippines</div>
            <div style="font-weight: bold; margin-bottom: 2px;">Province of Davao del Norte</div>
            <div style="font-weight: bold; font-size: 12pt; margin-bottom: 2px;">Municipality of New Corella</div>
            <div style="font-weight: bold; margin-bottom: 2px;">Municipal Health Office</div>
            <div style="font-size: 9pt; color: #666; margin-top: 3px;">Purok 5, Poblacion, New Corella | rhunewcorella@yahoo.com | (+63) 970-093-3480</div>
            <div class="mt-4" style="font-weight: bold; font-size: 13pt; text-transform: uppercase; letter-spacing: 0.5px;">${reportTitle}</div>
            ${reportingPeriodHtml}
          </div>
        `;
      } else {
        console.warn('Middle section not found for address replacement');
      }
      
      // Remove any scripts that might cause issues
      const scripts = clonedCard.querySelectorAll('script');
      scripts.forEach(script => script.remove());
      
      // Explicitly ensure the notes section (with timestamp) is preserved
      const notesSection = clonedCard.querySelector('.mt-3, [class*="notes"], small.text-muted');
      if (!notesSection) {
        // Try to find any section containing "Generated on" text
        const allText = clonedCard.textContent || '';
        if (allText.includes('Generated on')) {
          console.log('Found "Generated on" text in content');
        } else {
          console.warn('Warning: Notes section with timestamp not found in extracted content');
        }
      } else {
        console.log('Notes section found and preserved');
      }
      
      // Get cleaned HTML - preserve the exact structure including header
      // Use innerHTML to get the card content (which includes card-body with header)
      let contentHtml = clonedCard.innerHTML;
      
      // Verify that logos are present in the extracted content
      const tempCheck = document.createElement('div');
      tempCheck.innerHTML = contentHtml;
      const logoCheck = tempCheck.querySelectorAll('.report-logo, img[alt*="Logo"]');
      if (logoCheck.length === 0) {
        console.warn('Warning: No logos found in extracted content');
      }
      
      // Verify notes section with timestamp is in the content
      const notesCheck = tempCheck.querySelectorAll('small.text-muted, .mt-3');
      const hasGeneratedOn = Array.from(notesCheck).some(el => 
        el.textContent && el.textContent.includes('Generated on')
      );
      if (!hasGeneratedOn) {
        console.warn('Warning: "Generated on" timestamp not found in extracted content');
      } else {
        console.log('Verified: "Generated on" timestamp is present in content');
      }
      
      if (!contentHtml || contentHtml.trim().length === 0) {
        throw new Error('Report content is empty');
      }
      
      // Inject the content - this should include the header with logos inside card-body
      reportContent.innerHTML = contentHtml;
      loadingIndicator.style.display = 'none';
      reportContent.style.display = 'block';
      
      // Verify timestamp is visible in the preview after injection
      setTimeout(() => {
        const injectedContent = reportContent.innerHTML;
        const hasTimestamp = injectedContent.includes('Generated on');
        if (!hasTimestamp) {
          console.error('ERROR: "Generated on" timestamp not found in preview content after injection');
        } else {
          console.log('SUCCESS: "Generated on" timestamp is present in preview');
        }
        
        // Scroll to the preview container
        previewContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Also scroll the preview content to show the notes section at the bottom
        setTimeout(() => {
          const notesSection = reportContent.querySelector('.mt-3, small.text-muted');
          if (notesSection) {
            notesSection.scrollIntoView({ behavior: 'smooth', block: 'end' });
          }
        }, 200);
      }, 100);
    })
    .catch(error => {
      console.error('Error loading report:', error);
      loadingIndicator.style.display = 'none';
      reportContent.innerHTML = `
        <div class="text-center p-4">
          <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
          <p class="mt-2 text-danger">Error loading report: ${error.message}</p>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="generatePrintableReport()">Try Again</button>
        </div>
      `;
      reportContent.style.display = 'block';
    });
  }
  
  function printReportContent() {
    const reportContent = document.getElementById('reportContent');
    if (!reportContent || !reportContent.innerHTML.trim()) {
      alert('No report preview available. Please generate a report first.');
      return;
    }
    
    // Get exactly what's shown in the preview - print it as-is
    let content = reportContent.innerHTML;
    
    // Process content to remove excessive spacing and optimize for print
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = content;
    
    // Fix logo URLs to absolute paths
    const allLogos = tempDiv.querySelectorAll('img');
    allLogos.forEach(logo => {
      const srcAttr = logo.getAttribute('src');
      if (srcAttr && srcAttr.startsWith('/')) {
        logo.setAttribute('src', window.location.origin + srcAttr);
      }
    });
    
    // Remove forms and buttons that shouldn't print
    const forms = tempDiv.querySelectorAll('form.d-print-none, form[method="get"]');
    forms.forEach(form => form.remove());
    
    const buttons = tempDiv.querySelectorAll('button, .btn');
    buttons.forEach(btn => {
      // Only remove if it's not part of the report content
      if (!btn.closest('table') && !btn.closest('.card-body')) {
        btn.remove();
      }
    });
    
    // Remove empty divs that create blank spaces
    const emptyDivs = tempDiv.querySelectorAll('div:empty');
    emptyDivs.forEach(div => {
      // Only remove if it doesn't have important classes
      if (!div.classList.contains('clearfix') && !div.hasAttribute('role')) {
        div.remove();
      }
    });
    
    // Remove divs with only whitespace
    const allDivs = tempDiv.querySelectorAll('div');
    allDivs.forEach(div => {
      const text = div.textContent || '';
      const hasVisibleContent = div.querySelector('img, table, h1, h2, h3, h4, h5, h6, p, span, small, th, td');
      if (!hasVisibleContent && text.trim() === '' && div.children.length === 0) {
        div.remove();
      }
    });
    
    // Remove all Notes sections (contains bullet points, notes text, etc.)
    // First, find and remove notes sections by looking for bullet points and notes indicators
    const potentialNotesSections = tempDiv.querySelectorAll('div.mt-3, div.mb-3, small.text-muted, small');
    const notesSectionsToRemove = new Set();
    
    potentialNotesSections.forEach(element => {
      const text = element.textContent || '';
      // Check for bullet points or common notes text patterns
      const isNotesSection = text.includes('â€¢') || 
                            text.includes('Status values') || 
                            text.includes('Please coordinate') || 
                            text.includes('Notes:') || 
                            text.includes('Generated on') || 
                            text.includes('reflect') ||
                            text.includes('accreditation') || 
                            text.includes('personnel records') ||
                            text.includes('personnel') ||
                            text.includes('Possible Rabies') ||
                            text.includes('Gastrointestinal Issue') ||
                            text.includes('DOH Form 48') ||
                            text.includes('LBM-related');
      
      if (isNotesSection) {
        // Find the parent container (usually a div with mt-3 or mb-3)
        const parent = element.closest('div');
        if (parent) {
          // Only remove if parent doesn't contain important content like tables
          const hasTable = parent.querySelector('table');
          const hasImportantContent = parent.querySelector('h1, h2, h3, h4, h5, h6, img[alt*="Logo"]');
          if (!hasTable && !hasImportantContent) {
            notesSectionsToRemove.add(parent);
          }
        } else {
          // If no parent div, remove the element itself if it's a small element
          if (element.tagName === 'SMALL' || element.classList.contains('text-muted')) {
            notesSectionsToRemove.add(element);
          }
        }
      }
    });
    
    // Remove all identified notes sections
    notesSectionsToRemove.forEach(element => {
      element.remove();
    });
    
    // Balance table column widths - make all columns equal width
    const tables = tempDiv.querySelectorAll('table');
    tables.forEach(table => {
      // Count the number of columns in the first row
      const firstRow = table.querySelector('thead tr') || table.querySelector('tr');
      if (firstRow) {
        const columnCount = firstRow.querySelectorAll('th, td').length;
        if (columnCount > 0) {
          // Calculate equal width percentage
          const columnWidth = (100 / columnCount) + '%';
          
          // Apply equal width to all columns
          const allCells = table.querySelectorAll('th, td');
          allCells.forEach(cell => {
            cell.style.width = columnWidth;
            cell.style.minWidth = columnWidth;
            cell.style.maxWidth = columnWidth;
          });
        }
      }
    });
    
    // No page break - keep everything on one page
    // Remove any existing page break classes/styles
    const allTables = tempDiv.querySelectorAll('table');
    allTables.forEach(table => {
      table.style.pageBreakBefore = 'auto';
      table.style.breakBefore = 'auto';
      table.classList.remove('second-table-page-break');
      
      const container = table.closest('.table-responsive') || table.parentElement;
      if (container) {
        container.style.pageBreakBefore = 'auto';
        container.style.breakBefore = 'auto';
        container.classList.remove('second-table-page-break');
      }
    });
    
    // Remove any page break wrapper divs
    const pageBreakWrappers = tempDiv.querySelectorAll('.second-table-page-break, .page-break-before');
    pageBreakWrappers.forEach(wrapper => {
      // Unwrap the content
      const parent = wrapper.parentElement;
      if (parent) {
        while (wrapper.firstChild) {
          parent.insertBefore(wrapper.firstChild, wrapper);
        }
        wrapper.remove();
      }
    });
    
    // Add signature lines at the bottom (after the last table) - compact
    const signatureDiv = document.createElement('div');
    signatureDiv.style.marginTop = '15px';
    signatureDiv.style.paddingTop = '10px';
    signatureDiv.style.pageBreakInside = 'avoid';
    signatureDiv.innerHTML = `
      <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; font-size: 9px;">
        <div style="text-align: left;">
          <div style="margin-bottom: 30px;"><strong>Prepared by:</strong> _______________</div>
        </div>
        <div style="text-align: right;">
          <div style="margin-bottom: 30px;"><strong>Approved by:</strong> _______________</div>
        </div>
      </div>
    `;
    
    // Append signatures after the last table
    if (allTables.length > 0) {
      const lastTable = allTables[allTables.length - 1];
      const lastTableContainer = lastTable.closest('.table-responsive') || lastTable.parentElement;
      if (lastTableContainer && lastTableContainer.parentElement) {
        // Insert after the last table container
        lastTableContainer.parentElement.insertBefore(signatureDiv, lastTableContainer.nextSibling);
      } else {
        // Fallback: append to card-body
        const cardBody = tempDiv.querySelector('.card-body');
        if (cardBody) {
          cardBody.appendChild(signatureDiv);
        } else {
          tempDiv.appendChild(signatureDiv);
        }
      }
    } else {
      // If no tables, append to card-body or last element
      const cardBody = tempDiv.querySelector('.card-body');
      if (cardBody) {
        cardBody.appendChild(signatureDiv);
      } else {
        tempDiv.appendChild(signatureDiv);
      }
    }
    
    content = tempDiv.innerHTML;
    
    // Open print window with clean content
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Report</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
          @page { 
            size: A4 landscape; 
            margin: 0mm 12mm 12mm 12mm;
            @top-center { content: ""; }
            @bottom-center { content: ""; }
            @top-left { content: ""; }
            @top-right { content: ""; }
            @bottom-left { content: ""; }
            @bottom-right { content: ""; }
          }
          * {
            box-sizing: border-box;
            font-family: Arial, sans-serif !important;
          }
          body { 
            font-family: Arial, sans-serif; 
            font-size: 12pt;
            margin: 0;
            padding: 0 12mm 12mm;
            color: #000;
            line-height: 1.5;
          }
          .card {
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
          }
          .card-body {
            padding: 6mm 0 0 0 !important;
            margin: 0 !important;
          }
          h1, h2, h3, h4, h5, h6 {
            font-family: Arial, sans-serif !important;
            font-weight: bold;
            color: #000;
            margin: 15px 0 10px 0;
          }
          h1 { font-size: 18pt; }
          h2 { font-size: 16pt; }
          h3 { font-size: 14pt; }
          h4 { font-size: 13pt; }
          h5, h6 { font-size: 12pt; }
          /* Override for header middle section to prevent oversized text */
          .d-flex.align-items-center .text-center div {
            font-size: 11pt !important;
            line-height: 1.3 !important;
            margin-bottom: 2px !important;
          }
          .d-flex.align-items-center .text-center div[style*="font-size: 12pt"] {
            font-size: 12pt !important;
          }
          .d-flex.align-items-center .text-center div[style*="font-size: 9pt"] {
            font-size: 9pt !important;
          }
          p, small, span, div {
            font-family: Arial, sans-serif !important;
            font-size: 12pt;
            line-height: 1.5;
          }
          .d-flex.align-items-center {
            margin-bottom: 15px !important;
            page-break-after: avoid;
            padding: 5px 0 !important;
            gap: 15px !important;
          }
          .report-logo,
          img[alt*="Logo"],
          img[src*="LGU"],
          img[src*="MHO"] {
            width: 95px !important;
            height: 95px !important;
            max-width: 95px !important;
            max-height: 95px !important;
            object-fit: contain;
            margin: 0 10px !important;
            padding: 0 !important;
            display: block !important;
          }
          .d-flex.align-items-center > div {
            margin: 0 !important;
            padding: 0 !important;
          }
          .text-center.flex-grow-1 {
            padding: 0 15px !important;
            margin: 0 !important;
          }
          .table-responsive {
            page-break-inside: avoid;
            margin: 15px 0;
            overflow: visible !important;
            width: 100% !important;
          }
          table {
            width: 100% !important;
            max-width: 100% !important;
            border-collapse: collapse !important;
            page-break-inside: avoid !important;
            margin: 15px 0;
            font-size: 12pt !important;
            font-family: Arial, sans-serif !important;
          }
          thead {
            display: table-header-group !important;
            page-break-after: avoid;
          }
          tbody {
            display: table-row-group !important;
          }
          tr {
            page-break-inside: avoid;
            page-break-after: auto;
          }
          th, td {
            border: 1px solid #000 !important;
            padding: 8px 10px !important;
            font-size: 12pt !important;
            font-family: Arial, sans-serif !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            vertical-align: top !important;
            box-sizing: border-box !important;
            line-height: 1.4 !important;
          }
          th {
            background-color: #f5f5f5 !important;
            font-weight: bold !important;
            text-align: center !important;
          }
          td {
            text-align: left !important;
          }
          table th:nth-child(2),
          table td:nth-child(2) {
            text-align: left !important;
            padding-left: 10px !important;
          }
          .d-print-none {
            display: none !important;
          }
          .d-none.d-print-block {
            display: none !important;
          }
          form,
          .btn,
          .row.g-3 {
            display: none !important;
          }
          .container-fluid {
            padding: 0 !important;
            margin: 0 !important;
          }
          div:empty {
            display: none !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
          }
          .card-body > * {
            margin-top: 10px !important;
            margin-bottom: 10px !important;
          }
          .card-body > .d-flex:first-child {
            margin-top: 0 !important;
            margin-bottom: 15px !important;
          }
          .card-body > .table-responsive {
            margin-top: 15px !important;
            margin-bottom: 15px !important;
          }
          div[style*="margin-top: 15px"],
          div[style*="margin-top: 40px"] {
            margin-top: 20px !important;
            padding-top: 15px !important;
            page-break-inside: avoid;
            font-size: 12pt !important;
          }
          div[style*="display: flex"] {
            display: flex !important;
            justify-content: space-between !important;
            width: 100% !important;
            font-size: 12pt !important;
          }
          @media print {
            @page {
              size: A4 landscape;
              margin: 10mm 12mm 12mm 12mm;
            }
            body {
              margin: 0;
              padding: 0 12mm 12mm;
            }
            table {
              page-break-inside: avoid !important;
            }
            tr {
              page-break-inside: avoid !important;
            }
          }
        </style>
      </head>
      <body>
        ${content}
      </body>
      </html>
    `);
    printWindow.document.close();
    
    // Wait for content to load, then print
    printWindow.onload = function() {
      setTimeout(function() {
        printWindow.print();
        // Close window after printing (optional)
        // setTimeout(() => printWindow.close(), 100);
      }, 250);
    };
  }
  
  function closeReportPreview() {
    const previewContainer = document.getElementById('reportPreviewContainer');
    const reportContent = document.getElementById('reportContent');
    const loadingIndicator = document.getElementById('reportLoadingIndicator');
    previewContainer.style.display = 'none';
    reportContent.innerHTML = '';
    reportContent.style.display = 'none';
    loadingIndicator.style.display = 'none';
    // Reset loading indicator HTML
    loadingIndicator.innerHTML = `
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Loading report...</p>
    `;
  }
</script>

{% endblock script %}

{% endblock %}
