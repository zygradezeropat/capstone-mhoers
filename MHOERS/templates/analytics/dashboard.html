{% extends 'base.html' %}

{% load static %}  <!-- Load static tag -->

{% block content %} 

<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
  /* Calendar Styles - Ensure calendar fits within card */
  .calendar-main {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
  }
  
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
    width: 100%;
  }
  
  .calendar-header h2 {
    margin: 0;
    flex: 1;
    min-width: 200px;
    font-size: 1.5rem;
  }
  
  .calendar-nav {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .calendar-grid {
    width: 100%;
    max-width: 100%;
    overflow-x: auto;
    overflow-y: visible;
  }
  
  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0;
    width: 100%;
    margin-bottom: 0.5rem;
  }
  
  .calendar-weekday {
    text-align: center;
    font-weight: 600;
    padding: 0.5rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    font-size: 0.875rem;
  }
  
  .calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0;
    width: 100%;
  }
  
  .calendar-day {
    min-height: 80px;
    border: 1px solid #dee2e6;
    padding: 0.5rem;
    background-color: #fff;
    position: relative;
    overflow: hidden;
    word-wrap: break-word;
  }
  
  .calendar-day.other-month {
    background-color: #f8f9fa;
    color: #adb5bd;
  }
  
  .calendar-day.today {
    background-color: #e7f3ff;
    border: 2px solid #0d6efd;
  }
  
  .calendar-day span {
    display: block;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  
  .followup-indicators {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    margin-top: 0.25rem;
  }
  
  .followup-indicator {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    background-color: #0d6efd;
    color: white;
    border-radius: 0.25rem;
    cursor: pointer;
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .followup-indicator:hover {
    background-color: #0b5ed7;
  }
  
  .followup-text {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .calendar-day {
      min-height: 60px;
      padding: 0.25rem;
      font-size: 0.75rem;
    }
    
    .calendar-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .calendar-nav {
      width: 100%;
      justify-content: flex-start;
    }
  }
</style>

<!-- Navbar Include -->
{% include 'components/navbar.html' %}

<!-- Dashboard Cards -->
<div class="container mt-4">
  <div class="row mt-4">
    <div class="col-md-4">
      <div class="card-counter primary">
        <i class="fa fa-code-fork"></i>
        <span class="count-numbers">{{ total_patients }}</span>
        <span class="count-name">Total Patients</span>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card-counter success">
        <i class="fa fa-database"></i>
        <span class="count-numbers">{{ active_referrals }}</span>
        <span class="count-name">Ongoing Referral</span>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card-counter info">
        <i class="fa fa-users"></i>
        <span class="count-numbers">{{ completed_referrals }}</span>
        <span class="count-name">Total Referred</span>
      </div>
    </div>
  </div>


  
  <!-- Overdue Follow-ups content -->
  <div class="row mt-4" id="overdueSection" style="display: none;">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-3">
          <div class="reminder-main">
            <div class="reminder-header text-muted d-flex justify-content-between align-items-center mb-2">
              <h5 class="fw-bold text-danger mb-0">Overdue Follow-ups</h5>
              <small class="text-muted" id="overdueCount"></small>
            </div>
            <div id="overdueContent" style="max-height: 200px; overflow-y: auto;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Schedule today content -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="reminder-main">
            <div class="reminder-header text-muted ">
              <h4 class="fw-bold">Today Schedules</h4>
            </div>
            <div id="scheduleContent"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Calendar Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="calendar-main">
            <div class="calendar-header">
              <h2 id="currentMonth"></h2>
              <div class="calendar-nav">
                <button class="btn btn-secondary btn-sm" onclick="previousMonth()">Previous</button>
                <button class="btn btn-primary btn-sm" onclick="goToToday()">Today</button>
                <button class="btn btn-secondary btn-sm" onclick="nextMonth()">Next</button>
              </div>
            </div>
            <div class="calendar-grid" id="calendarGrid">
              <!-- Calendar will be generated here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Hidden form for New Assessment functionality -->
<form id="goToAssessmentForm" action="{% url 'assessment' %}" method="post" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="patient_id" id="hiddenPatientId">
</form>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Map JS -->
<script src="{% static 'js/map.js' %}"></script>

<!-- Bootstrap is loaded in base.html -->
<script src="{% static 'js/line_chart.js' %}"></script>

<!-- Pass current user context to JavaScript -->
<script>
  // Make current user ID and admin status available to calendar.js
  window.currentUserId = {{ request.user.id }};
  window.isAdmin = {{ request.user.is_staff|yesno:"true,false" }}; 
</script>

<script src="{% static 'js/calendar.js' %}"></script>

{% endblock %}
