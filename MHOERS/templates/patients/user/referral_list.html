{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block content %}


<link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />

<!-- Navbar Include -->
{% include 'components/navbar.html' %}
{% include 'components/tabbar/tabbar.html' with tab1_name="Active Referral" tab2_name="Referred" %}

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm rounded-lg">
        <div class="card-body p-4">
          <div class="tab-content" id="dashboardTabContent">
            <!-- Active Referral Tab -->
            <div class="tab-pane fade {% if active_tab == 'tab1' or not active_tab %}show active{% endif %}" id="tab1" role="tabpanel">
              <div class="table-responsive">
                <table id="activeTable" class="table table-hover align-middle">
                  <thead class="bg-light">
                    <tr>
                      <th>Patient Information</th>
                      <th>Contact</th>
                      <th>Age</th>
                      <th>Location</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in active_referrals %}
                      <tr data-id="{{ r.referral_id }}" class="align-middle">
                        <td>
                          <div class="d-flex align-items-center">
                            <div class="avatar-circle bg-success-soft me-3">
                              <i class="bi bi-person-circle text-success fs-4"></i>
                            </div>
                            <div>
                              <h6 class="mb-1 text-dark">{{ r.patient.first_name }} {{ r.patient.middle_name }} {{ r.patient.last_name }}</h6>
                              <span class="badge badge-pill badge-light">ID: #{{ r.referral_id }}</span>
                            </div>
                          </div>
                        </td>
                        <td><i class="bi bi-telephone-fill text-primary me-2"></i>{{ r.patient.p_number }}</td>
                        <td><i class="bi bi-calendar3 text-success me-2"></i>{{ r.patient.age }}</td>
                        <td><i class="bi bi-geo-alt-fill text-danger me-2"></i>{{ r.patient.p_address }}</td>
                        <td><span class="badge badge-pill badge-success">Active</span>
                          {% if r.status == 'in-progress' %}
                            <br>
                            <small class="text-muted">
                              <i class="bi bi-clock-history me-1"></i>
                              Est. completion: 
                              {% with preds=predictions|dict_get:r.referral_id %}
                              <span class="est-time" data-ref="{{ r.referral_id }}">
                                {% if preds %}{{ preds|last|floatformat:0 }} mins{% else %}--{% endif %}
                              </span>
                              {% endwith %}
                            </small>
                          {% endif %}
                        </td>
                        <td>
                          <button class="btn btn-outline-primary btn-sm rounded-pill MedicalDetails"
                          data-id="{{ r.referral_id }}" 
                          data-vpatient="{{ r.patient.first_name }} {{ r.patient.middle_name }} {{ r.patient.last_name }}"
                          data-vage = "{{ r.patient.age }}"
                          data-vaddress = "{{ r.patient.p_address}}"
                          data-vsex = "{{ r.patient.sex}}"
                          data-vreason = "{{ r.chief_complaint }}"
                          {% with preds=predictions|dict_get:r.referral_id %}
                          data-vdisease = "{% if preds %}{{ preds|first }}{% else %}{% endif %}"
                          {% endwith %}
                          data-bs-toggle="modal" 
                          data-bs-target="#MedicalDetails">
                           <i class="bi bi-file-medical me-1"></i> Referral Details
                         </button>
                        </td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="6" class="text-center text-muted py-4">No active referrals found.</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              {% if active_referrals.paginator.count %}
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
                <small class="text-muted">
                  Showing {{ active_referrals.start_index }}&ndash;{{ active_referrals.end_index }} of {{ active_referrals.paginator.count }}
                </small>
                {% if active_referrals.has_other_pages %}
                <nav>
                  <ul class="pagination pagination-sm mb-0">
                    <li class="page-item {% if not active_referrals.has_previous %}disabled{% endif %}">
                      <a class="page-link" href="{% if active_referrals.has_previous %}?active_page={{ active_referrals.previous_page_number }}&tab=tab1{% else %}#{% endif %}" aria-label="Previous">&laquo;</a>
                    </li>
                    {% for page_num in active_referrals.paginator.page_range %}
                      <li class="page-item {% if page_num == active_referrals.number %}active{% endif %}">
                        <a class="page-link" href="?active_page={{ page_num }}&tab=tab1">{{ page_num }}</a>
                      </li>
                    {% endfor %}
                    <li class="page-item {% if not active_referrals.has_next %}disabled{% endif %}">
                      <a class="page-link" href="{% if active_referrals.has_next %}?active_page={{ active_referrals.next_page_number }}&tab=tab1{% else %}#{% endif %}" aria-label="Next">&raquo;</a>
                    </li>
                  </ul>
                </nav>
                {% endif %}
              </div>
              {% endif %}
            </div>

            <!-- Referred Tab -->
            <div class="tab-pane fade {% if active_tab == 'tab2' %}show active{% endif %}" id="tab2" role="tabpanel">
              <div class="table-responsive">
                <table id="referredTable" class="table table-hover align-middle">
                  <thead class="bg-light">
                    <tr>
                      <th>Patient Name</th>
                      <th>Phone Number</th>
                      <th>Age</th>
                      <th>Address</th>
                      <th>Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in referred_referrals %}
                      <tr data-id="{{ r.referral_id }}" class="align-middle">
                        <td>
                          <div class="d-flex align-items-center">
                            <div class="avatar-circle bg-info-soft me-3">
                              <i class="bi bi-person-circle text-info fs-4"></i>
                            </div>
                            <div>
                              <h6 class="mb-1 text-dark">{{ r.patient.first_name }} {{ r.patient.middle_name }} {{ r.patient.last_name }}</h6>
                              <span class="badge badge-pill badge-light">ID: #{{ r.referral_id }}</span>
                            </div>
                          </div>
                        </td>
                        <td><i class="bi bi-telephone-fill text-primary me-2"></i>{{ r.patient.p_number }}</td>
                        <td><i class="bi bi-calendar3 text-success me-2"></i>{{ r.patient.age }}</td>
                        <td><i class="bi bi-geo-alt-fill text-danger me-2"></i>{{ r.patient.p_address }}</td>
                        <td><span class="badge badge-pill badge-info">Referred</span>
                          {% if r.status == 'completed' %}
                            <br>
                            <small class="text-muted">
                              <i class="bi bi-check-circle me-1"></i>
                              {% with preds=predictions|dict_get:r.referral_id %}
                              Completed in: {% if preds %}{{ preds|last|floatformat:0 }} mins{% else %}--{% endif %}
                              {% endwith %}
                            </small>
                          {% endif %}
                        </td>
                        <td>
                          <button class="btn btn-outline-primary btn-sm rounded-pill MedicalDetails"
                          data-id="{{ r.referral_id }}" 
                          data-vpatient="{{ r.patient.first_name }} {{ r.patient.middle_name }} {{ r.patient.last_name }}"
                          data-vage = "{{ r.patient.age }}"
                          data-vaddress = "{{ r.patient.p_address}}"
                          data-vsex = "{{ r.patient.sex}}"
                          data-vreason = "{{ r.chief_complaint }}"
                          {% with preds=predictions|dict_get:r.referral_id %}
                          data-vdisease = "{% if preds %}{{ preds|first }}{% else %}{% endif %}"
                          {% endwith %}
                          data-bs-toggle="modal" 
                          data-bs-target="#MedicalDetails">
                           <i class="bi bi-file-medical me-1"></i> Referral Details
                         </button>
                        </td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="6" class="text-center text-muted py-4">No referred records found.</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% if referred_referrals.paginator.count %}
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
                <small class="text-muted">
                  Showing {{ referred_referrals.start_index }}&ndash;{{ referred_referrals.end_index }} of {{ referred_referrals.paginator.count }}
                </small>
                {% if referred_referrals.has_other_pages %}
                <nav>
                  <ul class="pagination pagination-sm mb-0">
                    <li class="page-item {% if not referred_referrals.has_previous %}disabled{% endif %}">
                      <a class="page-link" href="{% if referred_referrals.has_previous %}?referred_page={{ referred_referrals.previous_page_number }}&tab=tab2{% else %}#{% endif %}" aria-label="Previous">&laquo;</a>
                    </li>
                    {% for page_num in referred_referrals.paginator.page_range %}
                      <li class="page-item {% if page_num == referred_referrals.number %}active{% endif %}">
                        <a class="page-link" href="?referred_page={{ page_num }}&tab=tab2">{{ page_num }}</a>
                      </li>
                    {% endfor %}
                    <li class="page-item {% if not referred_referrals.has_next %}disabled{% endif %}">
                      <a class="page-link" href="{% if referred_referrals.has_next %}?referred_page={{ referred_referrals.next_page_number }}&tab=tab2{% else %}#{% endif %}" aria-label="Next">&raquo;</a>
                    </li>
                  </ul>
                </nav>
                {% endif %}
              </div>
              {% endif %}
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Medical Details Modal -->
<div class="modal fade" id="MedicalDetails" tabindex="-1" role="dialog" aria-labelledby="MedicalDetailsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-person-lines-fill mr-2"></i>Medical Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        {% csrf_token %}
        <div class="row mb-4">
          <div class="col-md-6">
            <label class="font-weight-bold text-muted" for="viewPatientMedical">Patient Name</label>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                </div>
                <input type="text" class="form-control bg-light" id="viewPatientMedical" disabled>
            </div>
          </div>
        <div class="col-md-6">
          <label class="font-weight-bold text-muted" for="viewMedicalAge">Age</label>
            <div class="input-group">
              <div class="input-group-prepend">
                  <span class="input-group-text"><i class="bi bi-calendar"></i></span>
              </div>
              <input type="text" class="form-control bg-light" id="viewMedicalAge" disabled>
            </div>
        </div>
        </div>
        <div class="row mb-4">
          <div class="col-md-6">
            <label class="font-weight-bold text-muted" for="viewMedicalAddress">Address</label>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                </div>
                <input type="text" class="form-control bg-light" id="viewMedicalAddress" disabled>
            </div>
          </div>
          <div class="col-md-6">
            <label class="font-weight-bold text-muted" for="viewMedicalSex">Sex</label>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="bi bi-gender-ambiguous"></i></span>
                </div>
                <input type="text" class="form-control bg-light" id="viewMedicalSex" disabled>
            </div>
          </div>
        </div>
        <div class="row mb-4">
          <div class="col-md-6">
            <label class="font-weight-bold text-muted" for="viewMedicalReason">Reason</label>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="bi bi-patch-question"></i></span>
                </div>
                <input type="text" class="form-control bg-light" id="viewMedicalReason" disabled>
            </div>
          </div>
          <div class="col-md-6">
            <label class="font-weight-bold text-muted" for="viewDisease">Possible Disease</label>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="bi bi-virus2"></i></span>
                </div>
                <input type="text" class="form-control bg-light" id="viewDisease" disabled>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-arrow-left me-2"></i>Back
        </button>
      </div>
    </div>
  </div>
</div>




{% block script %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function() {
  // Initialize DataTables with modern styling
  const tableConfig = {
    responsive: true,
    paging: false,
    info: false,
    searching: false,
    ordering: false
  };

  $("#activeTable").DataTable(tableConfig);
  $("#referredTable").DataTable(tableConfig);

  // Use event delegation to handle dynamically created elements
  $(document).on('click', '.MedicalDetails', function() {
    const button = $(this);
    
    // Clear previous data first
    $('#viewPatientMedical').val('');
    $('#viewMedicalAge').val('');
    $('#viewMedicalAddress').val('');
    $('#viewMedicalSex').val('');
    $('#viewMedicalReason').val('');
    $('#viewDisease').val('');
    
    // Set new data
    $('#viewPatientMedical').val(button.data('vpatient'));
    $('#viewMedicalAge').val(button.data('vage'));
    $('#viewMedicalAddress').val(button.data('vaddress'));
    $('#viewMedicalSex').val(button.data('vsex'));
    $('#viewMedicalReason').val(button.data('vreason'));
    $('#viewDisease').val(button.data('vdisease'));
  });

  // Replace est-time spans with live API prediction (keeps server value as fallback)
  (function refreshEstTimes() {
    $(".est-time").each(function() {
      const $el = $(this);
      const id = $el.data('ref');
      if (!id) return;
      $.get(`/referral/referral/time-predict/${id}/`)
        .done(function(res) {
          if (res && typeof res.prediction_minutes !== 'undefined') {
            const mins = Math.round(res.prediction_minutes);
            if (!isNaN(mins)) {
              $el.text(`${mins} mins`);
            }
          }
        });
    });
  })();
 
  // Clear modal data when modal is hidden
  $('#MedicalDetails').on('hidden.bs.modal', function() {
    $('#viewPatientMedical').val('');
    $('#viewMedicalAge').val('');
    $('#viewMedicalAddress').val('');
    $('#viewMedicalSex').val('');
    $('#viewMedicalReason').val('');
    $('#viewDisease').val('');
  });
});
</script>
{% endblock %}
{% endblock %}
