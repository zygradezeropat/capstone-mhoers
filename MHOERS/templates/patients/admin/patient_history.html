{% load static %}
{% load custom_filters %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}" />

<style>
  /* Patient List Table Styles */
  .patient-row {
    transition: all 0.2s ease;
  }
  
  .patient-row:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .patient-row.table-active {
    background-color: #e3f2fd !important;
    border-left: 4px solid #2196f3;
  }
  
  .avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }
  
  .bg-primary-soft {
    background-color: rgba(33, 150, 243, 0.1);
    color: #2196f3;
  }
  
  .bg-success-soft {
    background-color: rgba(76, 175, 80, 0.1);
    color: #4caf50;
  }
  
  .bg-info-soft {
    background-color: rgba(0, 188, 212, 0.1);
    color: #00bcd4;
  }
  
  .bg-warning-soft {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
  }
  
  /* Patient Info Cards Animation */
  #patientInfoCards {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s ease;
  }
  
  #patientInfoCards.show {
    opacity: 1;
    transform: translateY(0);
  }
  
  /* Button spacing and layout */
  .gap-2 {
    gap: 0.5rem !important;
  }
  
  /* Referral History Dropdown Styles */
  .referral-history-dropdown {
    margin-top: 1rem;
  }
  
  .referral-history-dropdown .card {
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }
  
  .referral-history-dropdown .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
  }
  
  .referral-history-dropdown .card-header {
    border-radius: 12px 12px 0 0 !important;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  }
  
  .referral-history-dropdown .form-select {
    border-radius: 8px;
    border: 2px solid #cfe2ff; /* visible outline */
    font-size: 0.95rem;
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .referral-history-dropdown .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
    transform: scale(1.02);
  }
  
  .referral-history-dropdown .form-select:hover {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.15rem rgba(59, 130, 246, 0.2);
  }
  
  .referral-history-dropdown .form-select option {
    padding: 12px;
    font-size: 0.9rem;
  }
  
  .bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  }
  
  .form-select-lg {
    padding: 0.75rem 1rem;
    font-size: 1rem;
  }
  
  .shadow-sm {
    box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .table-responsive {
      font-size: 0.875rem;
    }
    
    .avatar-circle {
      width: 32px;
      height: 32px;
    }
    
    .btn-sm {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    .gap-2 {
      gap: 0.25rem !important;
    }
  }
</style>



<!-- Content Here -->
<div class="container-fluid py-4">
    
    <!-- Patient List Section -->
    <div class="row mb-4" id="patientListSection">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>All Patients</h5>
                    <div class="d-flex gap-2">
                        <!-- <button type="button" class="btn btn-outline-light btn-sm" onclick="refreshPatientList()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button> -->
                       
                    </div>
                </div>
                <br>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="patientListTable" class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>Patient Name</th>
                                    <th>Age/Sex</th>
                                    <th>Facility</th>
                                    <th>Address</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for patient in patients %}
                                <tr class="patient-row" data-patient-id="{{ patient.patients_id }}" style="cursor: pointer;">
                                    <td>
                                        <div class="d-flex align-items-center">
                                          
                                            <div>
                                                <h6 class="mb-1 text-dark">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}</h6>
                                                
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-muted">{{ patient.age|default:"N/A" }} / {{ patient.sex|default:"N/A" }}</span>
                                    </td>
                                    <td>
                                        <i class="bi bi-hospital text-primary me-2"></i>
                                        <span>{{ patient.facility.name|default:"N/A" }}</span>
                                    </td>
                                    <td>
                                        <i class="bi bi-geo-alt-fill text-danger me-2"></i>
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;" title="{{ patient.p_address }}">
                                            {{ patient.p_address|default:"N/A" }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm rounded-pill view-patient-btn" 
                                                data-patient-id="{{ patient.patients_id }}"
                                                data-patient-name="{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}"
                                                data-patient-age="{{ patient.age }}"
                                                data-patient-sex="{{ patient.sex }}"
                                                data-patient-facility="{{ patient.facility.name|default:'' }}"
                                                data-patient-address="{{ patient.p_address|default:'' }}">
                                            <i class="bi bi-eye me-1"></i> View
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    


    <!-- Date Filter Section -->
    <div class="row mb-3" id="dateFilterSection" style="display: none;">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <label for="dateFilter" class="me-2 mb-0 fw-medium">Filter by Date: </label>
                        <select id="dateFilter" class="form-select shadow-sm border-0 rounded-pill px-3 py-2">
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Information Cards -->
    <div class="row" id="patientInfoCards" style="display: none;">
        <div class="col-12 mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0 text-primary" id="selectedPatientName"></h4>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="backToPatientList()">
                        <i class="bi bi-arrow-left me-1"></i>Back to Patient List
                    </button>
                </div>
            </div>
            <hr>
        </div>
        
        <!-- Referral History Filter Card - Positioned here between header and cards -->
        <div class="col-12 mb-4" id="referralHistoryFilterContainer" style="display: none;">
            <!-- Referral history dropdown will be inserted here -->
        </div>
        
        <!-- SUBJECTIVE CARD -->
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100 border">
                <div class="card-header bg-primary text-white "><h6 class="fw-bold">SUBJECTIVE</h6></div>
                <div class="card-body border-primary">
                    <h6 class="card-subtitle mb-2 text-muted" id="chiefComplaintLabel">Chief Complaint</h6>
                    <strong><p class="text-uppercase" id="chiefComplaint"></p></strong>
                    <h6 class="card-subtitle mt-3 mb-2 text-muted" id="symptomsLabel">Symptoms</h6>
                    <strong><p class="text-uppercase" id="symptoms"></p></strong>
                </div>
            </div>
        </div>

        <!-- OBJECTIVE CARD -->
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">OBJECTIVE</div>
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Vital Signs</h6>
                    <ul class="list-unstyled" id="vitalSigns">
                        <li>BP: <span id="bpValue">N/A</span></li>
                        <li>HR: <span id="hrValue">N/A</span></li>
                        <li>TEMP: <span id="tempValue">N/A</span></li>
                        <li>O2 SAT: <span id="o2Value">N/A</span></li>
                    </ul>
                    <h6 class="card-subtitle mt-3 mb-2 text-muted" id="physicalExamLabel">Physical Examination</h6>
                    <p id="physicalExam">N/A</p>
                </div>
            </div>
        </div>

        <!-- ASSESSMENT CARD -->
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-warning text-dark">ASSESSMENT</div>
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Diagnosis</h6>
                    <p id="diagnosis"><strong>No diagnosis available</strong></p>
                    <h6 class="card-subtitle mt-3 mb-2 text-muted" id="icdCodeLabel">ICD Code</h6>
                    <p id="icdCode">N/A</p>
                </div>
            </div>
        </div>

        <!-- PLAN CARD -->
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">PLAN</div>
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">MHO Note / Actions / Follow-ups</h6>
                    <p id="mhoNotes">No notes available</p>

                    <h6 class="card-subtitle mt-3 mb-2 text-muted">Advice</h6>
                    <strong><p id="advice">No advice available</p></strong>
                </div>
            </div>
        </div>
    </div>
</div>

{% block script %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/patient-search.js' %}"></script>

<script>
$(document).ready(function() {
    // Get CSRF token for AJAX requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Set up CSRF token for all AJAX requests
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
        }
    });
    
    // Helper function to validate table structure before initializing DataTables
    function validateTableStructure(tableId) {
        const $table = $(tableId);
        if (!$table.length) {
            console.warn(`Table ${tableId} not found`);
            return false;
        }
        
        const $thead = $table.find('thead');
        const $tbody = $table.find('tbody');
        
        if (!$thead.length || !$tbody.length) {
            console.warn(`Table ${tableId} missing thead or tbody`);
            return false;
        }
        
        const headerCols = $thead.find('th').length;
        if (headerCols === 0) {
            console.warn(`Table ${tableId} has no header columns`);
            return false;
        }
        
        console.log(`Validating ${tableId}: Header has ${headerCols} columns`);
        
        // Check if all rows have the correct number of cells
        let isValid = true;
        let rowIndex = 0;
        $tbody.find('tr').each(function() {
            const $row = $(this);
            const cellCount = $row.find('td').length;
            
            // Check for colspan - if a row has colspan, it should match header count
            const $firstCell = $row.find('td').first();
            const colspan = $firstCell.attr('colspan');
            
            if (colspan) {
                const colspanNum = parseInt(colspan);
                if (colspanNum !== headerCols) {
                    console.error(`Table ${tableId}: Row ${rowIndex} has colspan=${colspanNum} but header has ${headerCols} columns`);
                    isValid = false;
                    return false; // break loop
                } else {
                    console.log(`Table ${tableId}: Row ${rowIndex} has correct colspan=${colspanNum}`);
                }
            } else if (cellCount > 0) {
                if (cellCount !== headerCols) {
                    console.error(`Table ${tableId}: Row ${rowIndex} has ${cellCount} cells but header has ${headerCols} columns`);
                    console.error(`Row HTML:`, $row[0].outerHTML.substring(0, 200));
                    isValid = false;
                    return false; // break loop
                } else {
                    console.log(`Table ${tableId}: Row ${rowIndex} has correct ${cellCount} cells`);
                }
            }
            rowIndex++;
        });
        
        if (isValid) {
            console.log(`Table ${tableId} structure is valid`);
        } else {
            console.error(`Table ${tableId} structure validation failed`);
        }
        
        return isValid;
    }
    
    // Track initialization to prevent multiple attempts
    let patientListTableInitialized = false;
    
    // Initialize DataTable for patient list - only when tab is visible
    function initPatientListTable() {
        const $table = $('#patientListTable');
        if (!$table.length) {
            console.warn('patientListTable not found in DOM');
            return; // Table doesn't exist
        }
        
        // Check if already initialized - destroy if exists to prevent conflicts
        if ($.fn.DataTable.isDataTable('#patientListTable')) {
            console.log('patientListTable already initialized, destroying existing instance...');
            try {
                $('#patientListTable').DataTable().destroy();
                console.log('Existing DataTable instance destroyed');
            } catch (e) {
                console.warn('Error destroying existing DataTable:', e);
            }
            // Reset flag to allow reinitialization
            patientListTableInitialized = false;
        }
        
        if (patientListTableInitialized) {
            console.warn('patientListTable initialization already attempted, skipping');
            return;
        }
        
        // Check if table is visible (tab must be active)
        const $tabPane = $table.closest('.tab-pane');
        const isVisible = $table.is(':visible') || ($tabPane.length && ($tabPane.hasClass('active') || $tabPane.hasClass('show')));
        
        if (!isVisible) {
            console.log('patientListTable is not visible yet, waiting for tab to be shown');
            return;
        }
        
        // Mark as attempting initialization
        patientListTableInitialized = true;
        
        // Validate structure before initializing
        if (!validateTableStructure('#patientListTable')) {
            console.error('patientListTable has invalid structure, skipping DataTable initialization');
            patientListTableInitialized = false; // Reset so we can try again
            return;
        }
        
        // Double-check: Count actual cells in all data rows (excluding empty row with colspan)
        const headerCount = $table.find('thead th').length;
        let allRowsValid = true;
        $table.find('tbody tr').each(function(index) {
            const $row = $(this);
            const $firstCell = $row.find('td').first();
            const colspan = $firstCell.attr('colspan');
            
            if (colspan) {
                // This is the empty row - colspan should match header count
                const colspanNum = parseInt(colspan);
                if (colspanNum !== headerCount) {
                    console.error(`Row ${index} (empty row) has colspan=${colspanNum}, fixing to ${headerCount}`);
                    $firstCell.attr('colspan', headerCount);
                }
            } else {
                // Regular data row - should have exact number of cells
                const cellCount = $row.find('td').length;
                if (cellCount !== headerCount) {
                    console.error(`Row ${index} has ${cellCount} cells, expected ${headerCount}`);
                    allRowsValid = false;
                }
            }
        });
        
        if (!allRowsValid) {
            console.error('Not all rows have correct cell count, aborting initialization');
            patientListTableInitialized = false;
            return;
        }
        
        // Final verification and cleanup before initialization
        console.log('Final verification:', {
            headerCols: headerCount,
            totalRows: $table.find('tbody tr').length,
            dataRows: $table.find('tbody tr').not(':has(td[colspan])').length,
            emptyRows: $table.find('tbody tr:has(td[colspan])').length
        });
        
        // Ensure table is visible and force a layout recalculation
        $table.css({
            'visibility': 'visible',
            'display': 'table'
        });
        
        // Force browser to recalculate layout
        if ($table[0]) {
            $table[0].offsetHeight;
        }
        
        // Remove any existing DataTable instance completely
        if ($.fn.DataTable.isDataTable('#patientListTable')) {
            try {
                $('#patientListTable').DataTable().destroy(true);
                // Remove DataTables wrapper if it exists
                const $wrapper = $('#patientListTable').closest('.dataTables_wrapper');
                if ($wrapper.length) {
                    $table.unwrap();
                }
            } catch (e) {
                console.warn('Error cleaning up existing DataTable:', e);
            }
        }
        
        // Small delay to ensure DOM is ready
        setTimeout(function() {
            try {
                console.log('Initializing patientListTable DataTable...');
                // Get the actual number of columns from the header
                const actualColCount = $('#patientListTable thead th').length;
                console.log('Initializing with', actualColCount, 'columns');
                
                // One final check - remove any rows that don't match the structure
                $table.find('tbody tr').each(function() {
                    const $row = $(this);
                    const $firstCell = $row.find('td').first();
                    const colspan = $firstCell.attr('colspan');
                    const cellCount = $row.find('td').length;
                    
                    if (colspan) {
                        // Empty row with colspan - remove it, DataTables will handle empty state
                        $row.remove();
                    } else if (cellCount !== actualColCount) {
                        // Data row with wrong cell count - this is a problem
                        console.error(`Removing invalid row with ${cellCount} cells (expected ${actualColCount})`);
                        $row.remove();
                    }
                });
                
                $('#patientListTable').DataTable();
                console.log('patientListTable DataTable initialized successfully');
            } catch (e) {
                console.error('Error initializing patientListTable DataTable:', e);
                console.error('Table structure details:', {
                    headerCols: $('#patientListTable thead th').length,
                    firstRowCols: $('#patientListTable tbody tr:first td').length,
                    allRows: $('#patientListTable tbody tr').length,
                    emptyRowColspan: $('#patientListTable tbody tr:has(td[colspan]) td').attr('colspan'),
                    rowDetails: Array.from($('#patientListTable tbody tr')).map((row, i) => ({
                        index: i,
                        cells: $(row).find('td').length,
                        colspan: $(row).find('td').first().attr('colspan'),
                        hasColspan: $(row).find('td[colspan]').length > 0
                    }))
                });
                patientListTableInitialized = false; // Reset on error
            }
        }, 100);
    }
    
    // Initialize when Medical History tab (tab2 or tab5) is shown - use multiple event handlers for compatibility
    $(document).on('shown.bs.tab', 'a[href="#tab2"], button[data-bs-target="#tab2"], button[data-target="#tab2"], a[href="#tab5"], button[data-bs-target="#tab5"], button[data-target="#tab5"]', function() {
        console.log('Medical History tab shown event triggered');
        setTimeout(function() {
            initPatientListTable();
        }, 200);
    });
    
    // Also listen for tab shown event on the tab panes themselves
    $('#tab2, #tab5').on('shown.bs.tab', function() {
        console.log('Medical History tab pane shown event triggered');
        setTimeout(function() {
            initPatientListTable();
        }, 200);
    });
    
    // Also try to initialize if Medical History tab is already active on page load
    if ($('#tab2').hasClass('active') || $('#tab2').hasClass('show') || $('#tab5').hasClass('active') || $('#tab5').hasClass('show')) {
        console.log('Medical History tab is already active on page load');
        setTimeout(function() {
            initPatientListTable();
        }, 300);
    }
    
    // Handle patient row click using event delegation for filtered results
    $(document).on('click', '.patient-row', function() {
        const patientId = $(this).data('patient-id');
        const patientName = $(this).find('h6').text();
        showPatientInfo(patientId, patientName);
    });
    
    // Handle view button click using event delegation for filtered results
    $(document).on('click', '.view-patient-btn', function(e) {
        e.stopPropagation(); // Prevent row click
        const patientId = $(this).data('patient-id');
        const patientName = $(this).data('patient-name');
        showPatientInfo(patientId, patientName);
    });
});

// Function to show patient information
function showPatientInfo(patientId, patientName) {
    console.log('showPatientInfo called with:', { patientId, patientName });
    console.log('Patient ID type:', typeof patientId);
    
    // Update patient name header
    $('#selectedPatientName').text(patientName);
    
    // Hide the patient list section
    $('#patientListSection').hide();
    
    // Show the patient info cards with animation
    $('#patientInfoCards').show().addClass('show');
    
    // Scroll to the cards
    $('html, body').animate({
        scrollTop: $('#patientInfoCards').offset().top - 100
    }, 500);
    
    // Load patient data (you can implement AJAX call here)
    loadPatientData(patientId);
    
    // Highlight selected row
    $('.patient-row').removeClass('table-active');
    $(`.patient-row[data-patient-id="${patientId}"]`).addClass('table-active');
}

// Function to hide patient information
function hidePatientInfo() {
    $('#patientInfoCards').removeClass('show');
    $('#referralHistoryFilterContainer').hide();
    setTimeout(() => {
        $('#patientInfoCards').hide();
    }, 500);
    $('.patient-row').removeClass('table-active');
}

// Function to go back to patient list
function backToPatientList() {
    // Hide patient info cards
    $('#patientInfoCards').removeClass('show');
    $('#referralHistoryFilterContainer').hide();
    setTimeout(() => {
        $('#patientInfoCards').hide();
    }, 500);
    
    // Show patient list section
    $('#patientListSection').show();
    
    // Remove active row highlighting
    $('.patient-row').removeClass('table-active');
    
    // Scroll back to patient list
    $('html, body').animate({
        scrollTop: $('#patientListSection').offset().top - 100
    }, 500);
}

// Function to refresh patient list
function refreshPatientList() {
    // Reload the page to refresh the patient list
    location.reload();
}

// Function to test API endpoints
function testAPI() {
    console.log('Testing API endpoints...');
    
    // Test the test view
    $.ajax({
        url: '/referral/test/',
        method: 'GET',
        success: function(data) {
            console.log('✅ Test view working:', data);
        },
        error: function(xhr, status, error) {
            console.error('❌ Test view failed:', error);
            console.error('Status:', xhr.status);
            console.error('Response:', xhr.responseText);
        }
    });
    
    // Test with a sample patient ID (you can change this)
    const testPatientId = 1;
    console.log('Testing patient referral history with ID:', testPatientId);
    
    $.ajax({
        url: `/referral/patient/${testPatientId}/history/`,
        method: 'GET',
        success: function(data) {
            console.log('✅ Patient referral history working:', data);
        },
        error: function(xhr, status, error) {
            console.error('❌ Patient referral history failed:', error);
            console.error('Status:', xhr.status);
            console.error('Response:', xhr.responseText);
        }
    });
}

// Function to load patient data from referral history
function loadPatientData(patientId) {
    // Show loading state
    $('#chiefComplaint').text('Loading...');
    $('#symptoms').text('Loading...');
    $('#bpValue').text('Loading...');
    $('#hrValue').text('Loading...');
    $('#tempValue').text('Loading...');
    $('#o2Value').text('Loading...');
    $('#physicalExam').text('Loading...');
    $('#diagnosis').html('<strong>Loading...</strong>');
    $('#icdCode').text('Loading...');
    $('#mhoNotes').text('Loading...');
    $('#advice').text('Loading...');
    
    // Fetch real patient referral history data
    // console.log('Fetching data for patient ID:', patientId);
    // console.log('API URL:', `/referral/patient/${patientId}/history/`);
    
    $.ajax({
        url: `/referral/patient/${patientId}/history/`,
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        success: function(data) {
            console.log('Patient referral history loaded:', data);
            
            if (data.referrals && data.referrals.length > 0) {
                // Get the most recent item (could be referral or follow-up visit)
                const latestItem = data.referrals[0];
                
                // Check if it's a follow-up visit or regular referral
                if (latestItem.type === 'followup_visit') {
                    // Handle follow-up visit display
                    
                    // Hide labels for follow-up visits
                    $('#chiefComplaintLabel').hide();
                    $('#symptomsLabel').hide();
                    $('#physicalExamLabel').hide();
                    $('#icdCodeLabel').hide();
                    
                    // SUBJECTIVE Card
                    // Reason for Follow-up (using advice content) - label bold, content not bold
                    $('#chiefComplaint').html(`<strong>Reason for Follow-up:</strong><br><span style="font-weight: normal;">${latestItem.advice || latestItem.notes || 'N/A'}</span>`);
                    // Current Symptoms with label - label bold, content not bold
                    $('#symptoms').html(`<strong>Current Symptoms:</strong><br><span style="font-weight: normal;">${latestItem.current_symptoms || 'No current symptoms recorded'}</span>`);
                    
                    // OBJECTIVE Card (Vital Signs) - Build complete list
                    let vitalSignsHtml = `
                        <li>BP: <span>${latestItem.bp_systolic || 'N/A'}/${latestItem.bp_diastolic || 'N/A'}</span></li>
                        <li>HR: <span>${latestItem.pulse_rate || 'N/A'}</span></li>
                        <li>TEMP: <span>${latestItem.temperature ? latestItem.temperature + '°C' : 'N/A'}</span></li>
                        <li>O2 SAT: <span>${latestItem.oxygen_saturation ? latestItem.oxygen_saturation + '%' : 'N/A'}</span></li>
                    `;
                    if (latestItem.weight) {
                        vitalSignsHtml += `<li>Weight: <span>${latestItem.weight} kg</span></li>`;
                    }
                    if (latestItem.height) {
                        vitalSignsHtml += `<li>Height: <span>${latestItem.height} cm</span></li>`;
                    }
                    $('#vitalSigns').html(vitalSignsHtml);
                    
                    // Physical Examination -> Visit Findings (no label)
                    $('#physicalExam').html(`${latestItem.visit_notes || 'No visit notes recorded'}`);
                    
                    // ASSESSMENT Card
                    const statusBadge = latestItem.status === 'completed' 
                        ? '<span class="badge bg-success">Completed</span>'
                        : latestItem.status === 'no_show'
                        ? '<span class="badge bg-warning">No Show</span>'
                        : latestItem.status === 'cancelled'
                        ? '<span class="badge bg-danger">Cancelled</span>'
                        : '<span class="badge bg-secondary">' + latestItem.status + '</span>';
                    
                    let assessmentHtml = `
                        <strong>${latestItem.illness_name || 'N/A'}</strong> <span class="badge bg-info">Follow-up</span><br>
                        <small class="mt-2 d-block">Status: ${statusBadge}</small>
                    `;
                    if (latestItem.treatment_response) {
                        assessmentHtml += `<small class="mt-2 d-block"><strong>Treatment Response:</strong><br>${latestItem.treatment_response}</small>`;
                    }
                    $('#diagnosis').html(assessmentHtml);
                    $('#icdCode').text(''); // Hide ICD code for follow-up visits
                    
                    // PLAN Card
                    const visitDate = new Date(latestItem.visit_date).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    let planNotesHtml = `
                        <strong>Visit Date:</strong> ${visitDate}<br>
                        <strong>Recorded By:</strong> ${latestItem.recorded_by || 'N/A'}<br>
                    `;
                    if (latestItem.visit_notes) {
                        planNotesHtml += `<br><strong>Visit Notes:</strong><br>${latestItem.visit_notes}`;
                    }
                    $('#mhoNotes').html(planNotesHtml);
                    
                    // Advice section (Original Advice moved to SUBJECTIVE card)
                    let adviceHtml = '';
                    if (latestItem.new_medications) {
                        adviceHtml += `<strong>New Medications:</strong><br>${latestItem.new_medications}<br><br>`;
                    }
                    if (latestItem.next_followup_date) {
                        const nextDate = new Date(latestItem.next_followup_date).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        adviceHtml += `<strong>Next Follow-up:</strong> ${nextDate}`;
                    } else {
                        adviceHtml += '<em>No further follow-up scheduled</em>';
                    }
                    $('#advice').html(adviceHtml || '<em>No additional information</em>');
                } else {
                    // Handle regular referral display
                    // Show labels for regular referrals
                    $('#chiefComplaintLabel').show();
                    $('#symptomsLabel').show();
                    $('#physicalExamLabel').show();
                    $('#icdCodeLabel').show();
                    
                    $('#chiefComplaint').text(latestItem.chief_complaint || 'No chief complaint recorded');
                    $('#symptoms').text(latestItem.symptoms || 'No symptoms recorded');
                    
                    // Populate OBJECTIVE card (Vital Signs) - reset to standard format
                    let vitalSignsHtml = `
                        <li>BP: <span>${latestItem.bp_systolic || 'N/A'}/${latestItem.bp_diastolic || 'N/A'}</span></li>
                        <li>HR: <span>${latestItem.pulse_rate || 'N/A'}</span></li>
                        <li>TEMP: <span>${latestItem.temperature ? latestItem.temperature + '°C' : 'N/A'}</span></li>
                        <li>O2 SAT: <span>${latestItem.oxygen_saturation ? latestItem.oxygen_saturation + '%' : 'N/A'}</span></li>
                    `;
                    if (latestItem.weight) {
                        vitalSignsHtml += `<li>Weight: <span>${latestItem.weight} kg</span></li>`;
                    }
                    if (latestItem.height) {
                        vitalSignsHtml += `<li>Height: <span>${latestItem.height} cm</span></li>`;
                    }
                    $('#vitalSigns').html(vitalSignsHtml);
                    
                    // Populate Physical Examination (Work Up Details)
                    $('#physicalExam').text(latestItem.work_up_details || 'No work-up details recorded');
                    
                    // Populate ASSESSMENT card - Use diagnosis from referral model
                    // Prefer final_diagnosis if available, otherwise use initial_diagnosis
                    const diagnosis = latestItem.final_diagnosis || latestItem.initial_diagnosis || latestItem.illness_name || 'No diagnosis available';
                    $('#diagnosis').html(`<strong>${diagnosis}</strong>`);
                    
                    // Populate ICD Code from referral model
                    $('#icdCode').text(latestItem.ICD_code || 'N/A');
                    
                    // Populate PLAN card - MHO Notes from Medical_History
                    const referralDate = new Date(latestItem.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    $('#mhoNotes').text(latestItem.notes || `Referral created on ${referralDate}`);
                    
                    // Show advice
                    $('#advice').text(latestItem.advice || 'No advice recorded');
                }
                
                // Show additional history if available
                if (data.referrals.length > 1) {
                    // Add referral history dropdown for multiple items
                    addReferralHistoryDropdown(data.referrals, patientId);
                } else {
                    // Hide the referral history filter container if only one item
                    $('#referralHistoryFilterContainer').hide();
                }
                
            } else {
                // No referrals found
                $('#chiefComplaint').text('No referrals found for this patient');
                $('#symptoms').text('No referral data available');
                $('#bpValue').text('N/A');
                $('#hrValue').text('N/A');
                $('#tempValue').text('N/A');
                $('#o2Value').text('N/A');
                $('#physicalExam').text('No referral data available');
                $('#diagnosis').html('<strong>No Referrals</strong>');
                $('#icdCode').text('N/A');
                $('#mhoNotes').text('This patient has no referral history');
                $('#advice').text('No referral data available');
            }
        },
        error: function(xhr, status, error) {
            console.error('Failed to load patient referral history:', error);
            console.error('Status:', status);
            console.error('Response Text:', xhr.responseText);
            console.error('Status Code:', xhr.status);
            console.error('Response Headers:', xhr.getAllResponseHeaders());
            
            // Show error state
            $('#chiefComplaint').text('Error loading data');
            $('#symptoms').text('Failed to fetch referral history');
            $('#bpValue').text('Error');
            $('#hrValue').text('Error');
            $('#tempValue').text('Error');
            $('#o2Value').text('Error');
            $('#physicalExam').text('Error loading data');
            $('#diagnosis').html('<strong>Error</strong>');
            $('#icdCode').text('Error');
            $('#mhoNotes').text('Failed to load patient referral data');
            $('#advice').text('Please try again or contact support');
        }
    });
}

// Function to add referral history dropdown for patients with multiple referrals
function addReferralHistoryDropdown(referrals, patientId) {
    // Remove existing dropdown if any
    $('.referral-history-dropdown').remove();
    
    // Create dropdown HTML
    const dropdownHtml = `
        <div class="referral-history-dropdown">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-primary text-white border-0">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-clock-history me-2 fs-5"></i>
                        <h6 class="mb-0 fw-semibold">Referral History</h6><span></span>
                        <span class="badge bg-light text-primary ms-auto fs-6">${referrals.length} total</span>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="form-group mb-3">
                        <label for="referralHistorySelect" class="form-label fw-medium text-muted mb-2">
                            <i class="bi bi-arrow-down-circle me-1"></i>Select Referral to View
                        </label>
                        <select class="form-select form-select-lg shadow-sm" 
                                id="referralHistorySelect" 
                                onchange="switchReferralData(this.value, ${patientId})"
                                style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                            ${referrals.map((item, index) => {
                                // Handle both referrals and follow-up visits
                                const isFollowup = item.type === 'followup_visit';
                                const itemDate = isFollowup ? new Date(item.visit_date) : new Date(item.created_at);
                                const dateStr = itemDate.toLocaleDateString('en-US', {
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric'
                                });
                                const timeStr = itemDate.toLocaleTimeString('en-US', {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                // Get status color and icon
                                let statusColor = 'secondary';
                                let statusIcon = 'bi-clock';
                                let label = '';
                                
                                if (isFollowup) {
                                    // Follow-up visit
                                    statusIcon = 'bi-clipboard-check';
                                    statusColor = 'info';
                                    label = 'Follow-up Visit';
                                    if (item.status === 'completed') {
                                        statusColor = 'success';
                                    } else if (item.status === 'no_show') {
                                        statusColor = 'warning';
                                    }
                                } else {
                                    // Regular referral
                                    if (item.status === 'completed') {
                                        statusColor = 'success';
                                        statusIcon = 'bi-check-circle';
                                    } else if (item.status === 'in-progress') {
                                        statusColor = 'primary';
                                        statusIcon = 'bi-arrow-right-circle';
                                    } else if (item.status === 'rejected') {
                                        statusColor = 'danger';
                                        statusIcon = 'bi-x-circle';
                                    }
                                    label = `Referral #${item.referral_id || 'N/A'}`;
                                }
                                
                                return `
                                    <option value="${index}" ${index === 0 ? 'selected' : ''}>
                                        ${isFollowup ? '<i class="bi bi-clipboard-check text-info me-2"></i>' : ''}
                                        ${label} - ${dateStr} at ${timeStr}
                                        <span class="badge bg-${statusColor} ms-2">${item.status}</span>
                                        ${isFollowup ? '<span class="badge bg-info ms-1">Follow-up</span>' : ''}
                                    </option>
                                `;
                            }).join('')}
                        </select>
                    </div>
                    
                </div>
            </div>
        </div>
    `;
    
    // Add dropdown to the referral history filter container and show it
    $('#referralHistoryFilterContainer').html(dropdownHtml).show();
}

// Function to switch between different referral data (including follow-up visits)
function switchReferralData(referralIndex, patientId) {
    // Fetch the referral data again and populate with selected referral
    $.ajax({
        url: `/referral/patient/${patientId}/history/`,
        method: 'GET',
        success: function(data) {
            if (data.referrals && data.referrals[referralIndex]) {
                const selectedItem = data.referrals[referralIndex];
                
                // Check if it's a follow-up visit or regular referral
                if (selectedItem.type === 'followup_visit') {
                    // Handle follow-up visit display
                    
                    // Hide labels for follow-up visits
                    $('#chiefComplaintLabel').hide();
                    $('#symptomsLabel').hide();
                    $('#physicalExamLabel').hide();
                    $('#icdCodeLabel').hide();
                    
                    // SUBJECTIVE Card
                    // Reason for Follow-up (using advice content) - label bold, content not bold
                    $('#chiefComplaint').html(`<strong>Reason for Follow-up:</strong><br><span style="font-weight: normal;">${selectedItem.advice || selectedItem.notes || 'N/A'}</span>`);
                    // Current Symptoms with label - label bold, content not bold
                    $('#symptoms').html(`<strong>Current Symptoms:</strong><br><span style="font-weight: normal;">${selectedItem.current_symptoms || 'No current symptoms recorded'}</span>`);
                    
                    // OBJECTIVE Card (Vital Signs) - Build complete list
                    let vitalSignsHtml = `
                        <li>BP: <span>${selectedItem.bp_systolic || 'N/A'}/${selectedItem.bp_diastolic || 'N/A'}</span></li>
                        <li>HR: <span>${selectedItem.pulse_rate || 'N/A'}</span></li>
                        <li>TEMP: <span>${selectedItem.temperature ? selectedItem.temperature + '°C' : 'N/A'}</span></li>
                        <li>O2 SAT: <span>${selectedItem.oxygen_saturation ? selectedItem.oxygen_saturation + '%' : 'N/A'}</span></li>
                    `;
                    if (selectedItem.weight) {
                        vitalSignsHtml += `<li>Weight: <span>${selectedItem.weight} kg</span></li>`;
                    }
                    if (selectedItem.height) {
                        vitalSignsHtml += `<li>Height: <span>${selectedItem.height} cm</span></li>`;
                    }
                    $('#vitalSigns').html(vitalSignsHtml);
                    
                    // Physical Examination -> Visit Findings (no label)
                    $('#physicalExam').html(`${selectedItem.visit_notes || 'No visit notes recorded'}`);
                    
                    // ASSESSMENT Card
                    const statusBadge = selectedItem.status === 'completed' 
                        ? '<span class="badge bg-success">Completed</span>'
                        : selectedItem.status === 'no_show'
                        ? '<span class="badge bg-warning">No Show</span>'
                        : selectedItem.status === 'cancelled'
                        ? '<span class="badge bg-danger">Cancelled</span>'
                        : '<span class="badge bg-secondary">' + selectedItem.status + '</span>';
                    
                    let assessmentHtml = `
                        <strong>${selectedItem.illness_name || 'N/A'}</strong> <span class="badge bg-info">Follow-up</span><br>
                        <small class="mt-2 d-block">Status: ${statusBadge}</small>
                    `;
                    if (selectedItem.treatment_response) {
                        assessmentHtml += `<small class="mt-2 d-block"><strong>Treatment Response:</strong><br>${selectedItem.treatment_response}</small>`;
                    }
                    $('#diagnosis').html(assessmentHtml);
                    $('#icdCode').text(''); // Hide ICD code for follow-up visits
                    
                    // PLAN Card
                    const visitDate = new Date(selectedItem.visit_date).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    let planNotesHtml = `
                        <strong>Visit Date:</strong> ${visitDate}<br>
                        <strong>Recorded By:</strong> ${selectedItem.recorded_by || 'N/A'}<br>
                    `;
                    if (selectedItem.visit_notes) {
                        planNotesHtml += `<br><strong>Visit Notes:</strong><br>${selectedItem.visit_notes}`;
                    }
                    $('#mhoNotes').html(planNotesHtml);
                    
                    // Advice section (Original Advice moved to SUBJECTIVE card)
                    let adviceHtml = '';
                    if (selectedItem.new_medications) {
                        adviceHtml += `<strong>New Medications:</strong><br>${selectedItem.new_medications}<br><br>`;
                    }
                    if (selectedItem.next_followup_date) {
                        const nextDate = new Date(selectedItem.next_followup_date).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        adviceHtml += `<strong>Next Follow-up:</strong> ${nextDate}`;
                    } else {
                        adviceHtml += '<em>No further follow-up scheduled</em>';
                    }
                    $('#advice').html(adviceHtml || '<em>No additional information</em>');
                    
                    console.log(`Switched to follow-up visit #${selectedItem.visit_id}`);
                } else {
                    // Handle regular referral display
                    // Show labels for regular referrals
                    $('#chiefComplaintLabel').show();
                    $('#symptomsLabel').show();
                    $('#physicalExamLabel').show();
                    $('#icdCodeLabel').show();
                    
                    $('#chiefComplaint').text(selectedItem.chief_complaint || 'No chief complaint recorded');
                    $('#symptoms').text(selectedItem.symptoms || 'No symptoms recorded');
                    
                    // Populate OBJECTIVE card (Vital Signs) - reset to standard format
                    let vitalSignsHtml = `
                        <li>BP: <span>${selectedItem.bp_systolic || 'N/A'}/${selectedItem.bp_diastolic || 'N/A'}</span></li>
                        <li>HR: <span>${selectedItem.pulse_rate || 'N/A'}</span></li>
                        <li>TEMP: <span>${selectedItem.temperature ? selectedItem.temperature + '°C' : 'N/A'}</span></li>
                        <li>O2 SAT: <span>${selectedItem.oxygen_saturation ? selectedItem.oxygen_saturation + '%' : 'N/A'}</span></li>
                    `;
                    if (selectedItem.weight) {
                        vitalSignsHtml += `<li>Weight: <span>${selectedItem.weight} kg</span></li>`;
                    }
                    if (selectedItem.height) {
                        vitalSignsHtml += `<li>Height: <span>${selectedItem.height} cm</span></li>`;
                    }
                    $('#vitalSigns').html(vitalSignsHtml);
                    
                    $('#physicalExam').text(selectedItem.work_up_details || 'No work-up details recorded');
                    
                    // Populate ASSESSMENT card - Use diagnosis from referral model
                    // Prefer final_diagnosis if available, otherwise use initial_diagnosis
                    const diagnosis = selectedItem.final_diagnosis || selectedItem.initial_diagnosis || selectedItem.illness_name || `Referral Status: ${selectedItem.status.toUpperCase()}`;
                    $('#diagnosis').html(`<strong>${diagnosis}</strong>`);
                    
                    // Populate ICD Code from referral model
                    $('#icdCode').text(selectedItem.ICD_code || 'N/A');
                    
                    const referralDate = new Date(selectedItem.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    $('#mhoNotes').text(selectedItem.notes || `Referral created on ${referralDate}`);
                    $('#advice').text(selectedItem.advice || 'No advice available');
                    
                    console.log(`Switched to referral #${selectedItem.referral_id}`);
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('Failed to switch referral data:', error);
        }
    });
}
</script>
{% endblock %}
{% endblock %}