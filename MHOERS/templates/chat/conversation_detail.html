{% extends 'base.html' %}
{% load static %}

{% block alerts %}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}" />

<!-- Navbar -->
{% include 'components/navbar.html' %}

<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <a href="{% url 'chat:chat_home' %}" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left me-2"></i>Back
          </a>
          <div class="d-flex align-items-center">
            <div class="avatar-circle bg-primary-soft me-3">
              <i class="bi bi-person-fill text-primary"></i>
            </div>
            <div>
              <h4 class="mb-1 fw-bold">{{ other_user.get_full_name|default:other_user.username }}</h4>
              <small class="text-muted">
                {% if other_user.is_staff %}Municipal Health Officer{% else %}Barangay Health Worker{% endif %}
              </small>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-danger" onclick="deleteConversation({{ conversation.id }})">
            <i class="bi bi-trash me-2"></i>Delete Conversation
          </button>
          <button class="btn btn-outline-primary" onclick="refreshMessages()">
            <i class="bi bi-arrow-clockwise me-2"></i>Refresh
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Messages Area -->
    <div class="col-12">
      <div class="card border-0 shadow-sm rounded-4 h-100" style="height: 600px;">
        <div class="card-body p-0 d-flex flex-column">
          <!-- Messages Container -->
          <div id="messagesContainer" class="flex-grow-1 p-4 overflow-auto" style="max-height: 450px;">
            {% for message in messages %}
              <div class="message-item mb-3 {% if message.sender == request.user %}text-end{% endif %}" data-message-id="{{ message.id }}">
                <div class="d-flex {% if message.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
                  <div class="message-bubble {% if message.sender == request.user %}bg-primary text-white{% else %}bg-light{% endif %} p-3 rounded-3 position-relative" style="max-width: 70%;">
                    {% if message.sender == request.user %}
                    <button class="btn btn-sm btn-link text-white-50 p-0 position-absolute top-0 end-0 m-1 delete-message-btn" 
                            onclick="deleteMessage({{ message.id }})" 
                            title="Delete message"
                            style="opacity: 0.7; font-size: 0.75rem;">
                      <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}
                    <p class="mb-1">{{ message.content }}</p>
                    <small class="{% if message.sender == request.user %}text-white-50{% else %}text-muted{% endif %}">
                      {{ message.created_at|date:"M d, Y g:i A" }}
                    </small>
                  </div>
                </div>
              </div>
            {% empty %}
              <div class="text-center py-5">
                <i class="bi bi-chat-dots display-4 text-muted mb-3"></i>
                <p class="text-muted">No messages yet. Start the conversation!</p>
              </div>
            {% endfor %}
          </div>
          
          <!-- Message Input -->
          <div class="border-top p-4">
            <form id="messageForm" method="post">
              {% csrf_token %}
              <div class="input-group">
                <textarea class="form-control" id="messageInput" name="content" rows="2" 
                          placeholder="Type your message..." style="resize: none;"></textarea>
                <button class="btn btn-primary" type="submit">
                  <i class="bi bi-send"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Styles -->
<style>
  .avatar-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
  }
  
  .bg-primary-soft {
    background-color: rgba(13, 110, 253, 0.1);
  }
  
  .message-bubble {
    word-wrap: break-word;
    word-break: break-word;
  }
  
  .message-item:last-child {
    margin-bottom: 0 !important;
  }
  
  #messagesContainer {
    scroll-behavior: smooth;
  }
  
  .message-item {
    animation: fadeIn 0.3s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .message-bubble {
    position: relative;
  }
  
  .delete-message-btn {
    opacity: 0;
    transition: opacity 0.2s;
  }
  
  .message-bubble:hover .delete-message-btn {
    opacity: 0.7;
  }
  
  .delete-message-btn:hover {
    opacity: 1 !important;
    color: #dc3545 !important;
  }
</style>

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const messageForm = document.getElementById('messageForm');
  const messageInput = document.getElementById('messageInput');
  const messagesContainer = document.getElementById('messagesContainer');
  const conversationId = {{ conversation.id }};
  
  // WebSocket connection
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.host}/ws/chat/${conversationId}/`;
  let chatSocket = null;
  let reconnectAttempts = 0;
  const maxReconnectAttempts = 5;
  
  // Connect to WebSocket
  function connectWebSocket() {
    try {
      chatSocket = new WebSocket(wsUrl);
      
      chatSocket.onopen = function(e) {
        console.log('WebSocket connection established');
        reconnectAttempts = 0;
        updateConnectionStatus(true);
      };
      
      chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'chat_message' && data.message) {
          const message = data.message;
          const isOwn = message.sender_id === {{ request.user.id }};
          addMessageToUI(message, isOwn);
          scrollToBottom();
        } else if (data.type === 'message_deleted') {
          // Handle message deletion
          removeMessageFromUI(data.message_id);
        } else if (data.type === 'typing') {
          // Handle typing indicator if needed
          // showTypingIndicator(data.username, data.is_typing);
        } else if (data.error) {
          console.error('WebSocket error:', data.error);
          alert('Error: ' + data.error);
        }
      };
      
      chatSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
        updateConnectionStatus(false);
      };
      
      chatSocket.onclose = function(e) {
        console.log('WebSocket connection closed');
        updateConnectionStatus(false);
        
        // Attempt to reconnect
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
          setTimeout(connectWebSocket, 3000 * reconnectAttempts);
        } else {
          console.error('Max reconnection attempts reached. Please refresh the page.');
          alert('Connection lost. Please refresh the page to reconnect.');
        }
      };
    } catch (error) {
      console.error('Error creating WebSocket:', error);
      updateConnectionStatus(false);
    }
  }
  
  // Update connection status indicator
  function updateConnectionStatus(connected) {
    // You can add a visual indicator here if needed
    // For example, show a green/red dot in the header
  }
  
  // Initialize WebSocket connection
  connectWebSocket();
  
  // Auto-scroll to bottom
  scrollToBottom();
  
  // Handle form submission
  messageForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const content = messageInput.value.trim();
    if (!content) return;
    
    // Send message via WebSocket
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
      sendMessageViaWebSocket(content);
    } else {
      // Fallback to HTTP if WebSocket is not available
      sendMessageViaHTTP(content);
    }
    
    // Clear input
    messageInput.value = '';
  });
  
  // Send message via WebSocket
  function sendMessageViaWebSocket(content) {
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
      chatSocket.send(JSON.stringify({
        type: 'chat_message',
        content: content
      }));
    } else {
      console.warn('WebSocket not connected, falling back to HTTP');
      sendMessageViaHTTP(content);
    }
  }
  
  // Fallback: Send message via HTTP (for backward compatibility)
  function sendMessageViaHTTP(content) {
    fetch(`{% url 'chat:send_message' conversation.id %}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        addMessageToUI(data, true);
        scrollToBottom();
      } else {
        alert('Error sending message: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error sending message');
    });
  }
  
  // Add message to UI
  function addMessageToUI(messageData, isOwn) {
    // Check if message already exists (prevent duplicates)
    const existingMessage = messagesContainer.querySelector(`[data-message-id="${messageData.id}"]`);
    if (existingMessage) {
      return;
    }
    
    const messageItem = document.createElement('div');
    messageItem.className = `message-item mb-3 ${isOwn ? 'text-end' : ''}`;
    messageItem.setAttribute('data-message-id', messageData.id);
    
    const messageBubble = document.createElement('div');
    messageBubble.className = `d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'}`;
    
    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isOwn ? 'bg-primary text-white' : 'bg-light'} p-3 rounded-3 position-relative`;
    bubble.style.maxWidth = '70%';
    
    const createdAt = messageData.created_at ? new Date(messageData.created_at) : new Date();
    
    let deleteButton = '';
    if (isOwn) {
      deleteButton = `
        <button class="btn btn-sm btn-link ${isOwn ? 'text-white-50' : 'text-muted'} p-0 position-absolute top-0 end-0 m-1 delete-message-btn" 
                onclick="deleteMessage(${messageData.id})" 
                title="Delete message"
                style="opacity: 0.7; font-size: 0.75rem;">
          <i class="bi bi-trash"></i>
        </button>
      `;
    }
    
    bubble.innerHTML = `
      ${deleteButton}
      <p class="mb-1">${escapeHtml(messageData.content)}</p>
      <small class="${isOwn ? 'text-white-50' : 'text-muted'}">
        ${createdAt.toLocaleString()}
      </small>
    `;
    
    messageBubble.appendChild(bubble);
    messageItem.appendChild(messageBubble);
    messagesContainer.appendChild(messageItem);
  }
  
  // Remove message from UI
  function removeMessageFromUI(messageId) {
    const messageElement = messagesContainer.querySelector(`[data-message-id="${messageId}"]`);
    if (messageElement) {
      messageElement.style.transition = 'opacity 0.3s';
      messageElement.style.opacity = '0';
      setTimeout(() => {
        messageElement.remove();
      }, 300);
    }
  }
  
  // Delete message function
  window.deleteMessage = function(messageId) {
    if (!confirm('Are you sure you want to delete this message?')) {
      return;
    }
    
    fetch(`{% url 'chat:delete_message' 0 %}`.replace('0', messageId), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        removeMessageFromUI(messageId);
      } else {
        alert('Error deleting message: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting message');
    });
  };
  
  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Scroll to bottom
  function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  // Refresh messages (reload page to get latest messages)
  window.refreshMessages = function() {
    if (chatSocket) {
      chatSocket.close();
    }
    location.reload();
  };
  
  // Clean up on page unload
  window.addEventListener('beforeunload', function() {
    if (chatSocket) {
      chatSocket.close();
    }
  });
  
  // Focus on message input
  messageInput.focus();
  
  // Get CSRF token from cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  // Delete conversation function
  window.deleteConversation = function(conversationId) {
    if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
      return;
    }
    
    fetch(`{% url 'chat:delete_conversation' 0 %}`.replace('0', conversationId), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Redirect to chat home after successful deletion
        window.location.href = '{% url "chat:chat_home" %}';
      } else {
        alert('Error deleting conversation: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting conversation');
    });
  };
});
</script>
{% endblock %}
{% endblock %}
