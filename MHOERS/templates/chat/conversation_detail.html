{% extends 'base.html' %}
{% load static %}

{% block alerts %}{% endblock %}

{% block content %}
<!-- Prevent Django messages modal from showing on this page -->
<script>
  // Override showMessageModal immediately to prevent modals on conversation pages
  (function() {
    'use strict';
    // Override the function before base.html processes Django messages
    window.showMessageModal = function(type, title, message, details, callback) {
      // Silently ignore all modal requests on conversation pages
      return;
    };
  })();
</script>

<link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}" />

<!-- Navbar -->
{% include 'components/navbar.html' %}

<!-- Messenger-style Chat Interface -->
<div class="container-fluid py-3">
  <div class="messenger-chat-container" style="height: calc(100vh - 140px);">
    <div class="row g-0 h-100">
      <!-- Left Sidebar: Conversations List -->
      <div class="col-lg-4 col-md-5 messenger-sidebar d-none d-md-block">
        <div class="messenger-sidebar-header">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-chat-dots me-2"></i>Messages
          </h5>
          <a href="{% url 'chat:chat_home' %}" class="btn btn-sm btn-link text-muted">
            <i class="bi bi-arrow-left"></i>
          </a>
        </div>
        
        <div class="messenger-search">
          <i class="bi bi-search"></i>
          <input type="text" class="form-control" placeholder="Search conversations..." id="conversationSearch">
        </div>
        
        <div class="messenger-conversations">
          {% for conv in all_conversations %}
            <div class="conversation-item {% if conv.id == conversation.id %}active{% endif %}" data-conversation-id="{{ conv.id }}">
              <a href="{% url 'chat:chat_conversation' conv.id %}" class="conversation-link">
                <div class="conversation-avatar">
                  <div class="avatar-circle">
                    <i class="bi bi-person-fill"></i>
                  </div>
                </div>
                <div class="conversation-info">
                  <div class="conversation-header">
                    <h6 class="conversation-name">{{ conv.other_user_name }}</h6>
                  </div>
                </div>
              </a>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Right Side: Active Chat -->
      <div class="col-lg-8 col-md-7 messenger-chat-area">
        <!-- Chat Header -->
        <div class="messenger-chat-header">
          <div class="d-flex align-items-center">
            <a href="{% url 'chat:chat_home' %}" class="btn btn-sm btn-link text-muted d-md-none me-2">
              <i class="bi bi-arrow-left"></i>
            </a>
            <div class="chat-avatar me-3">
              <div class="avatar-circle">
                <i class="bi bi-person-fill"></i>
              </div>
            </div>
            <div class="chat-user-info">
              <h6 class="mb-0 fw-bold">
                {% if other_user %}
                  {{ other_user.get_full_name|default:other_user.username }}
                {% else %}
                  Unknown User
                {% endif %}
              </h6>
              <small class="text-muted">
                {% if other_user %}
                  {% if other_user.is_staff %}
                    Municipal Health Officer
                  {% else %}
                    Barangay Health Worker{% if other_user_facility %} - {{ other_user_facility }}{% endif %}
                  {% endif %}
                {% else %}
                  User
                {% endif %}
              </small>
            </div>
          </div>
          <div class="chat-actions">
            <div class="dropdown">
              <button class="btn btn-sm btn-link text-muted" type="button" id="chatActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="More options">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatActionsDropdown">
                <li>
                  <a class="dropdown-item" href="#" onclick="refreshMessages(); return false;">
                    <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item text-danger" href="#" onclick="deleteConversation({{ conversation.id }}); return false;">
                    <i class="bi bi-trash me-2"></i>Delete
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Messages Container -->
        <div id="messagesContainer" class="messenger-messages">
          {% for message in messages %}
            <div class="message-wrapper {% if message.sender == request.user %}message-sent{% else %}message-received{% endif %}" data-message-id="{{ message.id }}">
              {% if message.sender != request.user %}
                <div class="message-avatar">
                  <div class="avatar-circle-small">
                    <i class="bi bi-person-fill"></i>
                  </div>
                </div>
              {% endif %}
              <div class="message-bubble-wrapper">
                <div class="message-bubble {% if message.sender == request.user %}bubble-sent{% else %}bubble-received{% endif %}">
                  {% if message.sender == request.user %}
                    <button class="btn btn-sm btn-link text-white-50 p-0 delete-message-btn" 
                            onclick="deleteMessage({{ message.id }})" 
                            title="Delete message">
                      <i class="bi bi-x"></i>
                    </button>
                  {% endif %}
                  <div class="message-content">
                    {{ message.content }}
                  </div>
                  <div class="message-time">
                    {{ message.created_at|date:"g:i A" }}
                  </div>
                </div>
              </div>
            </div>
          {% empty %}
            <div class="empty-messages">
              <i class="bi bi-chat-dots display-4 text-muted mb-3"></i>
              <p class="text-muted">No messages yet. Start the conversation!</p>
            </div>
          {% endfor %}
        </div>

        <!-- Message Input -->
        <div class="messenger-input-area">
          <form id="messageForm" method="post">
            {% csrf_token %}
            <div class="input-group">
              <textarea class="form-control" id="messageInput" name="content" 
                        placeholder="Type a message..." rows="1" style="resize: none; border-radius: 20px 0 0 20px;"></textarea>
              <button class="btn btn-primary" type="submit" style="border-radius: 0 20px 20px 0;">
                <i class="bi bi-send-fill"></i>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Conversation Confirmation Modal -->
<div class="modal fade" id="deleteConversationModal" tabindex="-1" role="dialog" aria-labelledby="deleteConversationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg border-0">
      <!-- Modal Header -->
      <div class="modal-header bg-danger text-white py-3">
        <h5 class="modal-title mb-0" id="deleteConversationModalLabel">
          <i class="bi bi-trash mr-2"></i>Delete Conversation
        </h5>
        <button type="button" class="btn-close btn-close-white close text-white" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body p-4">
        <p id="delete-conversation-confirm-text" class="text-muted mb-4"></p>
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-dismiss="modal">
            <i class="bi bi-x-circle mr-2"></i>Cancel
          </button>
          <button type="button" class="btn btn-danger" id="confirmDeleteConversationBtn">
            <i class="bi bi-trash mr-2"></i>Delete
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Messenger Chat Styles -->
<style>
  .messenger-chat-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  /* Left Sidebar (same as chat_home) */
  .messenger-sidebar {
    border-right: 1px solid #e4e6eb;
    background: #f0f2f5;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .messenger-sidebar-header {
    padding: 16px;
    background: #fff;
    border-bottom: 1px solid #e4e6eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .messenger-search {
    padding: 12px 16px;
    background: #fff;
    border-bottom: 1px solid #e4e6eb;
    position: relative;
  }

  .messenger-search i {
    position: absolute;
    left: 28px;
    top: 50%;
    transform: translateY(-50%);
    color: #8a8d91;
    z-index: 1;
  }

  .messenger-search input {
    padding-left: 40px;
    border: none;
    background: #f0f2f5;
    border-radius: 20px;
    height: 36px;
    font-size: 14px;
  }

  .messenger-search input:focus {
    background: #fff;
    box-shadow: 0 0 0 2px #e7f3ff;
    outline: none;
  }

  .messenger-conversations {
    flex: 1;
    overflow-y: auto;
    background: #fff;
  }

  .conversation-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #e4e6eb;
    transition: background-color 0.2s;
  }

  .conversation-item:hover {
    background-color: #f2f2f2;
  }

  .conversation-item.active {
    background-color: #e7f3ff;
    border-left: 3px solid #0084ff;
  }

  .conversation-link {
    display: flex;
    align-items: center;
    flex: 1;
    text-decoration: none;
    color: inherit;
  }

  .conversation-avatar {
    position: relative;
    margin-right: 12px;
    flex-shrink: 0;
  }

  .conversation-avatar .avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 18px;
  }

  /* Chat Area */
  .messenger-chat-area {
    background: #fff;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .messenger-chat-header {
    padding: 12px 16px;
    background: #fff;
    border-bottom: 1px solid #e4e6eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .chat-avatar .avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 18px;
  }

  .chat-actions {
    display: flex;
    gap: 8px;
  }

  .chat-actions .dropdown-menu {
    min-width: 140px;
    padding: 4px 0;
    font-size: 13px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  .chat-actions .dropdown-item {
    padding: 6px 12px;
    font-size: 13px;
    display: flex;
    align-items: center;
  }

  .chat-actions .dropdown-item i {
    font-size: 14px;
    width: 16px;
  }

  .chat-actions .dropdown-divider {
    margin: 4px 0;
  }

  /* Messages */
  .messenger-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    background: #f0f2f5;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .message-wrapper {
    display: flex;
    align-items: flex-end;
    margin-bottom: 2px;
    animation: fadeIn 0.3s ease-in;
  }

  .message-sent {
    justify-content: flex-end;
  }

  .message-received {
    justify-content: flex-start;
  }

  .message-avatar {
    margin-right: 8px;
    flex-shrink: 0;
  }

  .avatar-circle-small {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 14px;
  }

  .message-bubble-wrapper {
    max-width: 65%;
    display: flex;
    flex-direction: column;
  }

  .message-bubble {
    padding: 8px 12px;
    border-radius: 18px;
    position: relative;
    word-wrap: break-word;
    word-break: break-word;
  }

  .bubble-sent {
    background: #0084ff;
    color: #fff;
    border-bottom-right-radius: 4px;
  }

  .bubble-received {
    background: #e4e6eb;
    color: #050505;
    border-bottom-left-radius: 4px;
  }

  .message-content {
    font-size: 14px;
    line-height: 1.4;
    margin-bottom: 4px;
  }

  .message-time {
    font-size: 11px;
    opacity: 0.7;
    text-align: right;
    margin-top: 2px;
  }

  .bubble-received .message-time {
    text-align: left;
  }

  .delete-message-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    opacity: 0;
    transition: opacity 0.2s;
    font-size: 12px;
    padding: 2px 4px;
  }

  .message-bubble:hover .delete-message-btn {
    opacity: 1;
  }

  .empty-messages {
    text-align: center;
    padding: 60px 20px;
  }

  /* Input Area */
  .messenger-input-area {
    padding: 12px 16px;
    background: #fff;
    border-top: 1px solid #e4e6eb;
  }

  .messenger-input-area .form-control {
    border: 1px solid #e4e6eb;
    padding: 10px 16px;
    font-size: 14px;
  }

  .messenger-input-area .form-control:focus {
    border-color: #0084ff;
    box-shadow: 0 0 0 2px #e7f3ff;
  }

  .messenger-input-area .btn {
    padding: 10px 20px;
  }

  /* Scrollbar */
  .messenger-messages::-webkit-scrollbar,
  .messenger-conversations::-webkit-scrollbar {
    width: 6px;
  }

  .messenger-messages::-webkit-scrollbar-track,
  .messenger-conversations::-webkit-scrollbar-track {
    background: transparent;
  }

  .messenger-messages::-webkit-scrollbar-thumb,
  .messenger-conversations::-webkit-scrollbar-thumb {
    background: #bcc0c4;
    border-radius: 3px;
  }

  .messenger-messages::-webkit-scrollbar-thumb:hover,
  .messenger-conversations::-webkit-scrollbar-thumb:hover {
    background: #8a8d91;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Ensure showMessageModal is still overridden (prevent modals on conversation pages)
  window.showMessageModal = function() { return; };
  
  const messageForm = document.getElementById('messageForm');
  const messageInput = document.getElementById('messageInput');
  const messagesContainer = document.getElementById('messagesContainer');
  const conversationId = {{ conversation.id }};
  
  // Auto-resize textarea
  messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });
  
  // Handle Enter key to send message (Shift+Enter for new line)
  messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      
      const content = messageInput.value.trim();
      if (!content) return;
      
      // Send message via HTTP
      sendMessageViaHTTP(content);
      
      // Clear input and reset height
      messageInput.value = '';
      messageInput.style.height = 'auto';
    }
    // Shift+Enter will allow default behavior (new line)
  });
  
  // Auto-scroll to bottom
  scrollToBottom();
  
  // Handle form submission (for button click)
  messageForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const content = messageInput.value.trim();
    if (!content) return;
    
    // Send message via HTTP
    sendMessageViaHTTP(content);
    
    // Clear input and reset height
    messageInput.value = '';
    messageInput.style.height = 'auto';
  });
  
  // Send message via HTTP
  function sendMessageViaHTTP(content) {
    fetch(`{% url 'chat:send_message' conversation.id %}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        addMessageToUI(data, true);
        scrollToBottom();
      } else {
        alert('Error sending message: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error sending message');
    });
  }
  
  // Add message to UI
  function addMessageToUI(messageData, isOwn) {
    // Check if message already exists (prevent duplicates)
    const existingMessage = messagesContainer.querySelector(`[data-message-id="${messageData.id}"]`);
    if (existingMessage) {
      return;
    }
    
    const messageWrapper = document.createElement('div');
    messageWrapper.className = `message-wrapper ${isOwn ? 'message-sent' : 'message-received'}`;
    messageWrapper.setAttribute('data-message-id', messageData.id);
    
    const createdAt = messageData.created_at ? new Date(messageData.created_at) : new Date();
    const timeStr = createdAt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    
    let avatarHtml = '';
    if (!isOwn) {
      avatarHtml = `
        <div class="message-avatar">
          <div class="avatar-circle-small">
            <i class="bi bi-person-fill"></i>
          </div>
        </div>
      `;
    }
    
    let deleteButton = '';
    if (isOwn) {
      deleteButton = `
        <button class="btn btn-sm btn-link text-white-50 p-0 delete-message-btn" 
                onclick="deleteMessage(${messageData.id})" 
                title="Delete message">
          <i class="bi bi-x"></i>
        </button>
      `;
    }
    
    messageWrapper.innerHTML = `
      ${avatarHtml}
      <div class="message-bubble-wrapper">
        <div class="message-bubble ${isOwn ? 'bubble-sent' : 'bubble-received'}">
          ${deleteButton}
          <div class="message-content">${escapeHtml(messageData.content)}</div>
          <div class="message-time">${timeStr}</div>
        </div>
      </div>
    `;
    
    messagesContainer.appendChild(messageWrapper);
  }
  
  // Remove message from UI
  function removeMessageFromUI(messageId) {
    const messageElement = messagesContainer.querySelector(`[data-message-id="${messageId}"]`);
    if (messageElement) {
      messageElement.style.transition = 'opacity 0.3s';
      messageElement.style.opacity = '0';
      setTimeout(() => {
        messageElement.remove();
      }, 300);
    }
  }
  
  // Delete message function
  window.deleteMessage = function(messageId) {
    if (!confirm('Are you sure you want to delete this message?')) {
      return;
    }
    
    fetch(`{% url 'chat:delete_message' 0 %}`.replace('0', messageId), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        removeMessageFromUI(messageId);
      } else {
        alert('Error deleting message: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting message');
    });
  };
  
  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Scroll to bottom
  function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  // Refresh messages (reload page to get latest messages)
  window.refreshMessages = function() {
    if (typeof chatSocket !== 'undefined' && chatSocket) {
      chatSocket.close();
    }
    location.reload();
  };
  
  // Clean up on page unload
  window.addEventListener('beforeunload', function() {
    if (typeof chatSocket !== 'undefined' && chatSocket) {
      chatSocket.close();
    }
  });
  
  // Focus on message input
  messageInput.focus();
  
  // Get CSRF token from cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  // Store conversation ID and name for deletion
  let conversationToDelete = null;
  let conversationName = null;
  
  // Delete conversation function
  window.deleteConversation = function(conversationId) {
    conversationToDelete = conversationId;
    
    // Get conversation name from the chat header
    const chatUserInfo = document.querySelector('.chat-user-info h6');
    if (chatUserInfo) {
      conversationName = chatUserInfo.textContent.trim();
    } else {
      conversationName = 'this conversation';
    }
    
    // Update modal message
    const confirmText = document.getElementById('delete-conversation-confirm-text');
    if (confirmText) {
      confirmText.textContent = `Are you sure you want to delete the conversation with ${conversationName}?`;
    }
    
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConversationModal'));
    deleteModal.show();
  };
  
  // Handle confirm delete button click
  document.getElementById('confirmDeleteConversationBtn').addEventListener('click', function() {
    if (!conversationToDelete) return;
    
    const conversationId = conversationToDelete;
    conversationToDelete = null;
    
    // Close modal
    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConversationModal'));
    deleteModal.hide();
    
    // Perform deletion
    fetch(`{% url 'chat:delete_conversation' 0 %}`.replace('0', conversationId), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Redirect to chat home after successful deletion
        window.location.href = '{% url "chat:chat_home" %}';
      } else {
        alert('Error deleting conversation: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting conversation');
    });
  });
});
</script>
{% endblock content %}
